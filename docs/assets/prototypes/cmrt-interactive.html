<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMRT 6.5 - å¯äº¤äº’åŸå‹</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1565c0;
            --primary-dark: #0d47a1;
            --primary-light: #e3f2fd;
            --success: #2e7d32;
            --success-light: #e8f5e9;
            --warning: #f57c00;
            --warning-light: #fff3e0;
            --error: #c62828;
            --error-light: #ffebee;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            --font-main: 'IBM Plex Sans', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --yellow-fill: #ffff00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
            gap: 16px;
        }

        .top-nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
            min-width: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 14px;
        }

        .logo-text { color: white; font-weight: 600; font-size: 18px; }
        .logo-version {
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .nav-tabs { display: flex; gap: 4px; }

        .nav-tab {
            padding: 8px 16px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-tab:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-tab.active { background: rgba(255,255,255,0.2); color: white; }

        .nav-right { display: flex; align-items: center; gap: 16px; }

        .lang-select {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
        }

        .btn-export {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }

        /* Page Container */
        .page-container {
            display: none;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Card */
        .section-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-50);
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .section-badge {
            background: var(--primary-light);
            color: var(--primary);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .section-body { padding: 20px; }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-label {
            font-size: 13px;
            color: var(--gray-700);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-label .required { color: var(--error); }

        .form-input, .form-select, .form-textarea {
            height: 40px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 14px;
            font-family: var(--font-main);
            transition: all 0.2s;
            background: white;
            width: 100%;
        }

        .form-input.required-field, .form-select.required-field {
            background: var(--yellow-fill);
        }

        .form-textarea {
            height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input.error, .form-select.error {
            border-color: var(--error);
            background: var(--error-light);
        }

        .form-input.valid {
            border-color: var(--success);
            background: var(--success-light);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
            cursor: pointer;
        }

        .form-hint { font-size: 11px; color: var(--gray-500); }
        .form-error { font-size: 11px; color: var(--error); display: none; }
        .form-group.has-error .form-error { display: block; }

        /* Question Matrix - æ­£ç¡®å¸ƒå±€ï¼šæ¯é—®é¢˜ä¸‹4è¡Œé‡‘å± */
        .question-block {
            border: 1px solid var(--gray-300);
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .question-header {
            background: var(--primary-dark);
            color: white;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .question-header .q-num {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 10px;
            font-weight: 600;
        }

        .question-table {
            width: 100%;
            border-collapse: collapse;
        }

        .question-table th {
            background: var(--gray-100);
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-300);
        }

        .question-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .question-table tr:last-child td { border-bottom: none; }
        .question-table tr:hover { background: var(--gray-50); }

        .metal-label {
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metal-label .required { color: var(--error); font-size: 14px; }

        .metal-ta { color: #1565c0; }
        .metal-sn { color: #2e7d32; }
        .metal-au { color: #f57c00; }
        .metal-w { color: #7b1fa2; }

        .answer-select {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 10px;
            font-size: 13px;
            background: var(--yellow-fill);
            cursor: pointer;
        }

        .answer-select:focus { outline: none; border-color: var(--primary); }
        .answer-select.answered { background: white; }
        .answer-select.disabled { background: var(--gray-100); color: var(--gray-500); }

        .comment-input {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 10px;
            font-size: 13px;
        }

        .comment-input:focus { outline: none; border-color: var(--primary); }
        .comment-input.disabled { background: var(--gray-100); color: var(--gray-500); }

        .q-dependency-hint {
            font-size: 11px;
            color: var(--gray-500);
            font-style: italic;
            margin-top: 8px;
            padding: 8px 12px;
            background: var(--gray-50);
            border-radius: var(--radius-sm);
        }

        /* Company Questions */
        .company-question {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            gap: 16px;
        }

        .company-question:last-child { border-bottom: none; }

        .cq-letter {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .cq-content { flex: 1; }
        .cq-text { font-size: 14px; color: var(--gray-800); margin-bottom: 10px; }

        .cq-options { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        .cq-select {
            height: 36px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 13px;
            background: white;
            min-width: 200px;
        }

        #companyQuestionsBody.cq-required .cq-select {
            background: var(--yellow-fill);
        }

        .cq-select.answered { background: white; }

        .cq-comment {
            margin-top: 10px;
            display: none;
        }

        .cq-comment.show { display: block; }

        .cq-comment input {
            width: 100%;
            height: 36px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 13px;
        }

        .cq-comment input:focus { outline: none; border-color: var(--primary); }
        .cq-comment.show input { background: var(--yellow-fill); }

        .cq-disabled { opacity: 0.5; pointer-events: none; }

        /* Data Table */
        .table-container { overflow-x: auto; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 900px;
        }

        .data-table th {
            background: var(--gray-100);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
            white-space: nowrap;
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .data-table tr:hover { background: var(--gray-50); }

        .data-table input, .data-table select {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 8px;
            font-size: 12px;
            font-family: var(--font-main);
        }

        .data-table input:focus, .data-table select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .metal-select { min-width: 100px; }

        .delete-row-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--error-light);
            color: var(--error);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .delete-row-btn:hover { background: var(--error); color: white; }

        .add-row-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--gray-500);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .add-row-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .btn-primary:hover { filter: brightness(0.95); }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover { background: var(--gray-50); }

        .btn-primary:disabled,
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 24px 0 40px;
        }

        .page-actions .btn-primary,
        .page-actions .btn-secondary {
            min-width: 120px;
        }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-conformant { background: var(--success-light); color: var(--success); }
        .status-active { background: #e3f2fd; color: #1565c0; }
        .status-notlisted { background: var(--warning-light); color: var(--warning); }
        .status-unknown { background: var(--gray-200); color: var(--gray-600); }

        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #42a5f5 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .checker-list { list-style: none; }

        .checker-item {
            display: flex;
            align-items: flex-start;
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-200);
            gap: 12px;
            transition: background 0.2s;
        }

        .checker-item:hover { background: var(--gray-50); }
        .checker-item:last-child { border-bottom: none; }

        .checker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .checker-icon.error { background: var(--error-light); color: var(--error); }
        .checker-icon.warning { background: var(--warning-light); color: var(--warning); }
        .checker-icon.success { background: var(--success-light); color: var(--success); }

        .checker-content { flex: 1; }
        .checker-message { font-size: 13px; color: var(--gray-800); }
        .checker-location { font-size: 11px; color: var(--gray-500); margin-top: 4px; }

        .checker-fix-btn {
            padding: 4px 10px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checker-fix-btn:hover { background: var(--primary); color: white; }

        /* Page Title */
        .page-title { margin-bottom: 20px; }
        .page-title h1 { font-size: 24px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
        .page-title p { font-size: 14px; color: var(--gray-600); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--gray-900);
            color: white;
            border-radius: var(--radius-md);
            font-size: 14px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show { display: flex; }

        .modal-card {
            width: 520px;
            max-width: 92%;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title { font-size: 16px; font-weight: 600; color: var(--gray-900); }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 20px;
            color: var(--gray-500);
            cursor: pointer;
        }

        .modal-body { padding: 16px 20px; }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
        }

        .submit-summary {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .submit-errors {
            border: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .submit-errors-title {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .submit-errors ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .submit-error-item {
            display: flex;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-800);
            padding: 4px 0;
        }

        .submit-all-pass {
            padding: 12px;
            border-radius: var(--radius-md);
            background: var(--success-light);
            color: var(--success);
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        /* === UX ä¼˜åŒ–æ–°å¢æ ·å¼ === */

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .top-nav .progress-indicator {
            background: transparent;
            border-bottom: none;
            padding: 0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-500);
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .top-nav .progress-step {
            color: rgba(255, 255, 255, 0.75);
            font-size: 12px;
        }

        .progress-step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .progress-step.completed {
            color: var(--success);
        }

        .top-nav .progress-step.active {
            color: #fff;
        }

        .top-nav .progress-step.completed {
            color: #c8f7d4;
        }

        .progress-step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .top-nav .progress-step-num {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .progress-step.active .progress-step-num {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed .progress-step-num {
            background: var(--success);
            color: white;
        }

        .top-nav .progress-step.active .progress-step-num {
            background: #fff;
            color: var(--primary);
        }

        .top-nav .progress-step.completed .progress-step-num {
            background: #b7f5c3;
            color: #1b5e20;
        }

        .progress-arrow {
            color: var(--gray-300);
            font-size: 16px;
        }

        .top-nav .progress-arrow {
            color: rgba(255, 255, 255, 0.4);
        }

        /* å…¨å±€é”™è¯¯æç¤ºæ¡ */
        .global-error-bar {
            position: sticky;
            top: var(--top-nav-height, 56px);
            z-index: 99;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .global-error-bar.has-errors {
            background: var(--error-light);
            color: var(--error);
            border-bottom: 1px solid rgba(198, 40, 40, 0.2);
        }

        .global-error-bar.all-passed {
            background: var(--success-light);
            color: var(--success);
            border-bottom: 1px solid rgba(46, 125, 50, 0.2);
        }

        .global-error-bar:hover {
            filter: brightness(0.95);
        }

        /* å¿…å¡«é¡¹è¯´æ˜æç¤º */
        .required-hint {
            background: linear-gradient(90deg, var(--yellow-fill) 0%, #fff9c4 100%);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            border: 1px solid #e6d800;
        }

        .required-hint-icon {
            font-size: 16px;
        }

        /* ç¦ç”¨çŠ¶æ€é®ç½© */
        .disabled-overlay {
            position: relative;
        }

        .disabled-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 5;
            border-radius: var(--radius-md);
        }

        .disabled-overlay-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 6;
            background: white;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            font-size: 13px;
            color: var(--gray-600);
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
        }

        /* å®šä½é«˜äº®åŠ¨ç”» */
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(21, 101, 192, 0.6); }
            50% { box-shadow: 0 0 0 10px rgba(21, 101, 192, 0); }
            100% { box-shadow: 0 0 0 0 rgba(21, 101, 192, 0); }
        }

        .highlight-target {
            animation: highlight-pulse 0.5s ease-out 3;
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Smelter List å›ºå®šåˆ— */
        .sticky-col-1 {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
        }

        .sticky-col-2 {
            position: sticky;
            left: 120px;
            background: white;
            z-index: 2;
        }

        .sticky-col-3 {
            position: sticky;
            left: 220px;
            background: white;
            z-index: 2;
            border-right: 2px solid var(--gray-300);
        }

        .data-table thead th.sticky-col-1,
        .data-table thead th.sticky-col-2,
        .data-table thead th.sticky-col-3 {
            background: var(--gray-100);
        }

        .data-table tbody tr:hover .sticky-col-1,
        .data-table tbody tr:hover .sticky-col-2,
        .data-table tbody tr:hover .sticky-col-3 {
            background: var(--gray-50);
        }

        /* Checker åˆ†ç»„æ ·å¼ */
        .checker-group {
            border-bottom: 1px solid var(--gray-200);
        }

        .checker-group:last-child {
            border-bottom: none;
        }

        .checker-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--gray-50);
            cursor: pointer;
            transition: background 0.2s;
        }

        .checker-group-header:hover {
            background: var(--gray-100);
        }

        .checker-group-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .checker-group-count {
            background: var(--error-light);
            color: var(--error);
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .checker-group-toggle {
            font-size: 12px;
            color: var(--gray-500);
            transition: transform 0.2s;
        }

        .checker-group.collapsed .checker-group-toggle {
            transform: rotate(-90deg);
        }

        .checker-group-content {
            max-height: none;
            overflow: visible;
            transition: none;
        }

        .checker-group.collapsed .checker-group-content {
            max-height: 0;
            overflow: hidden;
        }

        /* é€šè¿‡é¡¹æŠ˜å  */
        .passed-summary {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .passed-summary:hover {
            background: var(--gray-50);
        }

        .passed-summary-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--success);
            font-weight: 500;
        }

        .passed-summary-toggle {
            font-size: 12px;
            color: var(--gray-500);
            padding: 4px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
        }

        .passed-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .passed-details.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Loading çŠ¶æ€ */
        .btn-export.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-export.loading::after {
            content: '...';
            animation: loading-dots 1s infinite;
        }

        @keyframes loading-dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">
            <div class="logo-icon">CM</div>
            <span class="logo-text">CMRT</span>
            <span class="logo-version">v6.5</span>
        </div>

        <div class="top-nav-center">
            <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div class="progress-indicator" id="progressIndicator">
            <div class="progress-step active" data-step="declaration">
                <span class="progress-step-num">1</span>
                <span>Declaration</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-step" data-step="smelter">
                <span class="progress-step-num">2</span>
                <span>Smelter List</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-step" data-step="product">
                <span class="progress-step-num">3</span>
                <span>Product List</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-step" data-step="checker">
                <span class="progress-step-num">4</span>
                <span>Review</span>
            </div>
            </div>
        </div>

        <div class="nav-right">
            <select class="lang-select" id="langSelect">
                <option value="en">English</option>
                <option value="zh">ä¸­æ–‡</option>
                <option value="ja">æ—¥æœ¬èª</option>
            </select>
            <select class="lang-select" id="versionSelect"></select>
            <button class="btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        </div>
    </nav>

    <!-- å…¨å±€é”™è¯¯æç¤ºæ¡ -->
    <div class="global-error-bar has-errors" id="globalErrorBar" onclick="goToChecker()">
        <span id="globalErrorIcon">âš ï¸</span>
        <span id="globalErrorText">è¿˜æœ‰ 0 ä¸ªå¿…å¡«é¡¹æœªå®Œæˆ</span>
        <span style="font-size: 12px; opacity: 0.7;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</span>
    </div>

    <!-- Declaration Page -->
    <div class="page-container active" id="page-declaration">
        <div class="page-title">
            <h1>Declaration ç”³æŠ¥é¡µ</h1>
            <p>æ­¤å¡«å†™æ­¤æŠ¥å‘Šçš„ç›®çš„æ˜¯æ”¶é›†åœ¨äº§å“ä¸­æ‰€ç”¨é”¡ã€é’½ã€é’¨ã€é»„é‡‘ç­‰é‡‘å±çš„é‡‡è´­ä¿¡æ¯ã€‚</p>
        </div>

        <!-- å¿…å¡«é¡¹è¯´æ˜æç¤º -->
        <div class="required-hint">
            <span class="required-hint-icon">ğŸ’¡</span>
            <span><strong>å¡«å†™æç¤ºï¼š</strong>é»„è‰²åº•è‰²å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œè¯·ç¡®ä¿å…¨éƒ¨å¡«å†™å®Œæ•´åå†æäº¤ã€‚</span>
        </div>

        <!-- Company Information -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ¢</span>
                    å…¬å¸ä¿¡æ¯
                </div>
                <span class="section-badge" id="companyFieldsCount">0/8 å¿…å¡«å·²å®Œæˆ</span>
            </div>
            <div class="section-body">
                <div class="form-grid" id="companyForm">
                    <div class="form-group" data-field="companyName" data-required="true">
                        <label class="form-label">å…¬å¸åç§° (*)ï¼š</label>
                        <input type="text" class="form-input required-field" id="companyName" placeholder="è¯·è¾“å…¥å…¬å¸æ­£å¼æ³¨å†Œåç§°">
                        <span class="form-hint">ä½¿ç”¨æ­£å¼æ³¨å†Œåç§°ï¼Œä¸å¾—ä½¿ç”¨ç¼©å†™</span>
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="declarationScope" data-required="true">
                        <label class="form-label">ç”³æŠ¥èŒƒå›´æˆ–ç§ç±» (*)ï¼š</label>
                        <select class="form-select required-field" id="declarationScope">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="A">A. Company</option>
                            <option value="B">B. Product (or List of Products)</option>
                            <option value="C">C. User defined</option>
                        </select>
                        <span class="form-hint">A=å…¬å¸çº§ | B=äº§å“çº§(éœ€å¡«Product List) | C=è‡ªå®šä¹‰</span>
                        <span class="form-error">è¯·é€‰æ‹©ç”³æŠ¥èŒƒå›´</span>
                    </div>
                    <div class="form-group" id="scopeDescGroup" style="display: none;" data-field="scopeDescription">
                        <label class="form-label">èŒƒå›´æè¿°ï¼š</label>
                        <textarea class="form-textarea required-field" id="scopeDescription" placeholder="è¯·æè¿°è‡ªå®šä¹‰ç”³æŠ¥èŒƒå›´"></textarea>
                        <span class="form-error">é€‰æ‹©è‡ªå®šä¹‰èŒƒå›´æ—¶å¿…é¡»å¡«å†™æè¿°</span>
                    </div>
                    <div class="form-group" data-field="uniqueId">
                        <label class="form-label">å…¬å¸å”¯ä¸€è¯†åˆ«ä¿¡æ¯ï¼š</label>
                        <input type="text" class="form-input" id="uniqueId" placeholder="DUNS, VAT, ç»„ç»‡æœºæ„ä»£ç ç­‰">
                    </div>
                    <div class="form-group" data-field="authId">
                        <label class="form-label">å…¬å¸å”¯ä¸€æˆæƒè¯†åˆ«ä¿¡æ¯ï¼š</label>
                        <input type="text" class="form-input" id="authId" placeholder="æˆæƒè¯†åˆ«ä¿¡æ¯">
                    </div>
                    <div class="form-group" data-field="address">
                        <label class="form-label">åœ°å€ï¼š</label>
                        <input type="text" class="form-input" id="address" placeholder="å…¬å¸åœ°å€">
                    </div>
                    <div class="form-group" data-field="contactName" data-required="true">
                        <label class="form-label">è”ç³»äººå§“å (*)ï¼š</label>
                        <input type="text" class="form-input required-field" id="contactName" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="contactEmail" data-required="true">
                        <label class="form-label">ç”µå­é‚®ä»¶ - è”ç³»äºº (*)ï¼š</label>
                        <input type="email" class="form-input required-field" id="contactEmail" placeholder="example@company.com">
                        <span class="form-hint">æ— é‚®ç®±å¯å¡« "not available"</span>
                        <span class="form-error">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</span>
                    </div>
                    <div class="form-group" data-field="contactPhone" data-required="true">
                        <label class="form-label">ç”µè¯ - è”ç³»äºº (*)ï¼š</label>
                        <input type="tel" class="form-input required-field" id="contactPhone" placeholder="+86 xxx xxxx xxxx">
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="authorizer" data-required="true">
                        <label class="form-label">æˆæƒäºº (*)ï¼š</label>
                        <input type="text" class="form-input required-field" id="authorizer" placeholder="è¯·è¾“å…¥æˆæƒäººå§“å">
                        <span class="form-hint">ä¸å¯å¡« "same" ç­‰å ä½</span>
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œä¸”ä¸èƒ½ä¸º "same"</span>
                    </div>
                    <div class="form-group" data-field="authorizerTitle">
                        <label class="form-label">èŒåŠ¡ - æˆæƒäººï¼š</label>
                        <input type="text" class="form-input" id="authorizerTitle" placeholder="èŒåŠ¡åç§°">
                    </div>
                    <div class="form-group" data-field="authorizerEmail" data-required="true">
                        <label class="form-label">ç”µå­é‚®ä»¶ - æˆæƒäºº (*)ï¼š</label>
                        <input type="email" class="form-input required-field" id="authorizerEmail" placeholder="example@company.com">
                        <span class="form-error">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</span>
                    </div>
                    <div class="form-group" data-field="authorizerPhone">
                        <label class="form-label">ç”µè¯ - æˆæƒäººï¼š</label>
                        <input type="tel" class="form-input" id="authorizerPhone" placeholder="+86 xxx xxxx xxxx">
                    </div>
                    <div class="form-group" data-field="effectiveDate" data-required="true">
                        <label class="form-label">ç”Ÿæ•ˆæ—¥æœŸ (*)ï¼š</label>
                        <input type="date" class="form-input required-field" id="effectiveDate">
                        <span class="form-hint">æ ¼å¼: DD-MMM-YYYY (å¦‚ 01-Jan-2026)</span>
                        <span class="form-error">è¯·é€‰æ‹©æœ‰æ•ˆæ—¥æœŸ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Matrix - æ­£ç¡®å¸ƒå±€ -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">â“</span>
                    æ ¹æ®ä¸Šè¿°ç”³æŠ¥èŒƒå›´ï¼Œå›ç­”ä»¥ä¸‹ 1 è‡³ 8 é¢˜
                </div>
                <span class="section-badge">Q1-Q8</span>
            </div>
            <div class="section-body" style="padding: 16px;" id="questionMatrixContainer">
                <!-- é—®é¢˜å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- Company Level Questions -->
        <div class="section-card" id="companyQuestionsCard">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“‹</span>
                    ä»å…¬å¸å±‚é¢ï¼Œå›ç­”ä»¥ä¸‹é—®é¢˜
                </div>
                <span class="section-badge" id="cqStatus">å½“ä»»ä¸€é‡‘å± Q1 ä¸ Q2 â‰  No æ—¶å¿…å¡«</span>
            </div>
            <div class="section-body" style="padding: 0;" id="companyQuestionsBody">
            </div>
        </div>

        <div class="page-actions" data-page="declaration">
            <button class="btn-secondary" data-action="prev" disabled>ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Smelter List Page -->
    <div class="page-container" id="page-smelter">
        <div class="page-title">
            <h1>Smelter List å†¶ç‚¼å‚æ¸…å•</h1>
            <p>åˆ—å‡ºä¾›åº”é“¾ä¸­æ¶‰åŠçš„æ‰€æœ‰3TGå†¶ç‚¼å‚/ç²¾ç‚¼å‚ä¿¡æ¯</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ­</span>
                    å†¶ç‚¼å‚æ¸…å•
                </div>
                <span class="section-badge" id="smelterCount">0 æ¡è®°å½•</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-container" style="max-height: 600px; overflow: auto;">
                    <table class="data-table" id="smelterTable" style="min-width: 2600px;">
                        <thead>
                            <tr>
                                <th class="sticky-col-1" style="width: 120px; position: sticky; top: 0; left: 0; background: var(--gray-100); z-index: 12;">å†¶ç‚¼å‚è¯†åˆ«å·ç <br/>è¾“å…¥åˆ—</th>
                                <th class="sticky-col-2" style="width: 100px; position: sticky; top: 0; left: 120px; background: var(--gray-100); z-index: 12;">é‡‘å± <span style="color:var(--error);">*</span></th>
                                <th class="sticky-col-3" style="width: 180px; position: sticky; top: 0; left: 220px; background: var(--gray-100); z-index: 12; border-right: 2px solid var(--gray-300);">å†¶ç‚¼å‚æŸ¥æ‰¾ <span style="color:var(--error);">*</span></th>
                                <th style="width: 200px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚åç§°</th>
                                <th style="width: 140px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å›½å®¶/åœ°åŒº <span style="color:var(--error);">*</span></th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è¯†åˆ«</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å‡ºå¤„è¯†åˆ«å·</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">è¡—é“</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">åŸå¸‚</th>
                                <th style="width: 100px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å·/çœ</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è”ç³»äºº</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è”ç³»äºº<br/>ç”µå­é‚®ä»¶</th>
                                <th style="width: 180px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å»ºè®®çš„åç»­æ­¥éª¤</th>
                                <th style="width: 220px; position: sticky; top: 0; background: var(--gray-100); z-index: 10; font-size: 10px; line-height: 1.3;">å¡«å†™çŸ¿äº•åç§°ï¼Œæˆ–å¦‚æœæ‰€ç”¨çŸ¿äº§æ¥è‡ªäºå›æ”¶æ–™å’ŒæŠ¥åºŸæ–™ï¼Œè¯·å¡«å†™"å›æ”¶"æˆ–"æŠ¥åºŸ"ã€‚</th>
                                <th style="width: 220px; position: sticky; top: 0; background: var(--gray-100); z-index: 10; font-size: 10px; line-height: 1.3;">å¡«å†™çŸ¿äº•æ‰€åœ¨å›½å®¶æˆ–åœ°åŒºï¼Œæˆ–å¦‚æœæ‰€ç”¨çŸ¿äº§æ¥è‡ªäºå›æ”¶æ–™å’ŒæŠ¥åºŸæ–™ï¼Œè¯·å†™"å›æ”¶"æˆ–"æŠ¥åºŸ"ã€‚</th>
                                <th style="width: 160px; position: sticky; top: 0; background: var(--gray-100); z-index: 10; font-size: 10px; line-height: 1.3;">å†¶ç‚¼å‚çš„è¢«å†¶ç‚¼ç‰©æ–™æ˜¯å¦100%æ¥è‡ªäºå›æ”¶æ–™æˆ–æŠ¥åºŸæ–™?</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">æ³¨é‡Š</th>
                                <th style="width: 50px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;"></th>
                            </tr>
                        </thead>
                        <tbody id="smelterTableBody">
                        </tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addSmelterRow()">+ æ·»åŠ å†¶ç‚¼å‚</button>
            </div>
        </div>

        <!-- å­—æ®µè¯´æ˜å¡ç‰‡ -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“‹</span>
                    å­—æ®µè¯´æ˜
                </div>
            </div>
            <div class="section-body">
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <tr style="background: var(--gray-50);">
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">å­—æ®µ</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">å¿…å¡«</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">è¾“å…¥æ–¹å¼</th>
                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--gray-200);">è¯´æ˜</th>
                    </tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚è¯†åˆ«å·ç è¾“å…¥åˆ—</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>æœ‰å€¼æ—¶è§¦å‘è‡ªåŠ¨å¡«å……å…¶ä»–å­—æ®µ</td></tr>
                    <tr style="background: var(--primary-light);"><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);"><strong>é‡‘å± *</strong></td><td><strong>æ˜¯</strong></td><td>ä¸‹æ‹‰</td><td>é’½/é”¡/é‡‘/é’¨</td></tr>
                    <tr style="background: var(--primary-light);"><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);"><strong>å†¶ç‚¼å‚æŸ¥æ‰¾ *</strong></td><td><strong>æ˜¯</strong></td><td>ä¸‹æ‹‰</td><td>ä»ç›®å½•é€‰æ‹© / Smelter not listed / Smelter not yet identified</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚åç§°</td><td>æ¡ä»¶</td><td>æ‰‹åŠ¨</td><td>é€‰æ‹© "Not listed" æ—¶å¿…å¡«</td></tr>
                    <tr style="background: var(--primary-light);"><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);"><strong>å›½å®¶/åœ°åŒº *</strong></td><td><strong>æ¡ä»¶</strong></td><td>ä¸‹æ‹‰</td><td>é€‰æ‹© "Not listed" æ—¶å¿…é€‰</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚è¯†åˆ«</td><td>å¦</td><td style="color: var(--primary);">è‡ªåŠ¨</td><td>ç³»ç»Ÿè‡ªåŠ¨å¡«å……</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å‡ºå¤„è¯†åˆ«å·</td><td>å¦</td><td style="color: var(--primary);">è‡ªåŠ¨</td><td>ç³»ç»Ÿè‡ªåŠ¨å¡«å……</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">è¡—é“/åŸå¸‚/å·çœ</td><td>å¦</td><td style="color: var(--primary);">è‡ªåŠ¨</td><td>ç³»ç»Ÿè‡ªåŠ¨å¡«å……</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚è”ç³»äºº</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>å†¶ç‚¼å‚è”ç³»äººå§“å</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚è”ç³»äººç”µå­é‚®ä»¶</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>å†¶ç‚¼å‚è”ç³»äººé‚®ç®±</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å»ºè®®çš„åç»­æ­¥éª¤</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>åç»­è·Ÿè¿›äº‹é¡¹</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å¡«å†™çŸ¿äº•åç§°...</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>çŸ¿äº•åç§°ï¼Œæˆ–å¡«"å›æ”¶"/"æŠ¥åºŸ"</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å¡«å†™çŸ¿äº•æ‰€åœ¨å›½å®¶æˆ–åœ°åŒº...</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>çŸ¿äº•å›½å®¶ï¼Œæˆ–å¡«"å›æ”¶"/"æŠ¥åºŸ"</td></tr>
                    <tr><td style="padding: 6px 8px; border-bottom: 1px solid var(--gray-100);">å†¶ç‚¼å‚çš„è¢«å†¶ç‚¼ç‰©æ–™æ˜¯å¦100%...</td><td>å¦</td><td>ä¸‹æ‹‰</td><td>Yes / No / Unknown</td></tr>
                    <tr><td style="padding: 6px 8px;">æ³¨é‡Š</td><td>å¦</td><td>æ‰‹åŠ¨</td><td>å¤‡æ³¨ä¿¡æ¯</td></tr>
                </table>
            </div>
        </div>

        <div class="page-actions" data-page="smelter">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Product List Page -->
    <div class="page-container" id="page-product">
        <div class="page-title">
            <h1>Product List äº§å“æ¸…å•</h1>
            <p>å½“ç”³æŠ¥èŒƒå›´é€‰æ‹© "B. Product" æ—¶å¿…å¡«</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“¦</span>
                    äº§å“æ¸…å•
                </div>
                <span class="section-badge" id="productCount">0 æ¡è®°å½•</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table" id="productTable">
                        <thead>
                            <tr>
                                <th style="width: 200px;">å›å¤æ–¹çš„äº§å“ç¼–å· *</th>
                                <th>å›å¤æ–¹çš„äº§å“åç§°</th>
                                <th>æ³¨é‡Š</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                        </tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addProductRow()">+ æ·»åŠ äº§å“</button>
            </div>
        </div>

        <div class="page-actions" data-page="product">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Checker Page -->
    <div class="page-container" id="page-checker">
        <div class="page-title">
            <h1>Checker æ ¡éªŒç»“æœ</h1>
            <p>ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¡«å†™å®Œæ•´æ€§å’Œåˆè§„æ€§</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“Š</span>
                    å¡«å†™è¿›åº¦
                </div>
            </div>
            <div class="section-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 13px; color: var(--gray-700);">æ€»ä½“å®Œæˆåº¦</span>
                    <span style="font-size: 13px; font-weight: 600; color: var(--primary);" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="section-card" id="errorsCard" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon" style="background: var(--error-light); color: var(--error);">âŒ</span>
                    é”™è¯¯ Errors (å¿…é¡»ä¿®æ­£)
                </div>
                <span class="section-badge" style="background: var(--error-light); color: var(--error);" id="errorBadge">0 é¡¹</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <!-- åˆ†ç»„é”™è¯¯åˆ—è¡¨ -->
                <div id="groupedErrorsList"></div>
            </div>
        </div>

        <div class="section-card" id="passedCard">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon" style="background: var(--success-light); color: var(--success);">âœ…</span>
                    é€šè¿‡ Passed
                </div>
                <span class="section-badge" style="background: var(--success-light); color: var(--success);" id="passedBadge">0 é¡¹</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <!-- é€šè¿‡é¡¹æŠ˜å æ‘˜è¦ -->
                <div class="passed-summary" id="passedSummary" onclick="togglePassedDetails()">
                    <span class="passed-summary-text">
                        <span>âœ…</span>
                        <span id="passedSummaryText">å·²é€šè¿‡ 0 é¡¹æ£€æŸ¥</span>
                    </span>
                    <span class="passed-summary-toggle" id="passedToggleBtn">å±•å¼€æŸ¥çœ‹</span>
                </div>
                <div class="passed-details" id="passedDetails">
                    <ul class="checker-list" id="passedList"></ul>
                </div>
            </div>
        </div>

        <div class="page-actions" data-page="checker">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" id="submitReviewBtn" onclick="openSubmitModal()">æäº¤</button>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal-overlay" id="submitModal" onclick="handleModalBackdrop(event)">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">æäº¤å‰æ£€æŸ¥</div>
                <button class="modal-close" onclick="closeSubmitModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="submit-summary">
                    <div>å®Œæˆåº¦ï¼š<span id="submitCompletion">0%</span></div>
                    <div>é”™è¯¯ï¼š<span id="submitErrorCount">0</span></div>
                </div>
                <div class="submit-all-pass" id="submitAllPass" style="display: none;">å…¨éƒ¨é€šè¿‡</div>
                <div class="submit-errors" id="submitErrorsSection">
                    <div class="submit-errors-title">å¾…ä¿®å¤ï¼ˆå‰ 5 æ¡ï¼‰</div>
                    <ul id="submitErrorsList"></ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeSubmitModal()">ç»§ç»­å¡«å†™</button>
                <button class="btn-primary" id="submitFixBtn" onclick="handleSubmitFix()">å»ä¿®å¤</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Data Store
        const appData = {
            company: {},
            questionMatrix: {}, // { Q1: { Tantalum: { answer: '', comment: '' }, Tin: {...}, ... }, Q2: {...}, ... }
            companyQuestions: {},
            smelters: [],
            products: []
        };

        const versionConfigs = {
            '6.5': { label: '6.5' },
            '6.4': { label: '6.4' },
            '6.31': { label: '6.31' },
            '6.22': { label: '6.22' },
            '6.1': { label: '6.1' },
            '6.01': { label: '6.01' }
        };

        const defaultVersion = '6.5';
        let currentVersion = getVersionFromUrl() || defaultVersion;

        // Questions Definition - æ­£ç¡®çš„å¸ƒå±€
        const questions = [
            { id: 'Q1', text: 'æ˜¯å¦åœ¨äº§å“æˆ–ç”Ÿäº§æµç¨‹ä¸­æœ‰æ„æ·»åŠ æˆ–ä½¿ç”¨ä»»ä½• 3TGï¼Ÿ', options: ['Yes', 'No'], dependency: null },
            { id: 'Q2', text: 'æ˜¯å¦æœ‰ä»»ä½• 3TG ä»å­˜åœ¨äºäº§å“ä¸­ï¼Ÿ', options: ['Yes', 'No'], dependency: null },
            { id: 'Q3', text: 'è´µå…¬å¸ä¾›åº”é“¾ä¸­çš„å†¶ç‚¼å‚æ˜¯å¦ä»æ‰€æŒ‡æ˜çš„å›½å®¶é‡‡è´­ 3TGï¼Ÿï¼ˆæœ‰å…³æœ¯è¯­â€œSECâ€ï¼Œè¯·å‚è§å®šä¹‰é€‰é¡¹å¡ï¼‰', options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q4', text: 'è´µå…¬å¸ä¾›åº”é“¾ä¸­æ˜¯å¦æœ‰å†¶ç‚¼å‚ä»å—å†²çªå½±å“å’Œé«˜é£é™©åœ°åŒºé‡‡è´­ 3TGï¼Ÿ', options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q5', text: 'æ˜¯å¦ 100% çš„ 3TGï¼ˆå› äº§å“åŠŸèƒ½æˆ–ç”Ÿäº§è€Œå¿…é¡»ä½¿ç”¨ï¼‰æ¥è‡ªäºå›æ”¶æ–™æˆ–æŠ¥åºŸæ–™ï¼Ÿ', options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q6', text: 'å·²å¯¹è´µå…¬å¸ä¾›åº”é“¾è°ƒæŸ¥æä¾›ç­”å¤çš„ç›¸å…³ä¾›åº”å•†ç™¾åˆ†æ¯”æ˜¯å¤šå°‘ï¼Ÿ', options: ['100%', 'Greater than 90%', 'Greater than 75%', 'Greater than 50%', '50% or less', 'None'], dependency: 'Q1Q2' },
            { id: 'Q7', text: 'æ‚¨æ˜¯å¦è¯†åˆ«å‡ºä¸ºè´µå…¬å¸ä¾›åº”é“¾ä¾›åº” 3TG çš„æ‰€æœ‰å†¶ç‚¼å‚ï¼Ÿ', options: ['Yes', 'No'], dependency: 'Q1Q2' },
            { id: 'Q8', text: 'è´µå…¬å¸æ”¶åˆ°çš„æ‰€æœ‰é€‚ç”¨å†¶ç‚¼å‚ä¿¡æ¯æ˜¯å¦å·²åœ¨æ­¤ç”³æŠ¥ä¸­æŠ¥å‘Šï¼Ÿ', options: ['Yes', 'No'], dependency: 'Q1Q2' }
        ];

        const metals = [
            { id: 'Tantalum', name: 'é’½', class: 'metal-ta' },
            { id: 'Tin', name: 'é”¡', class: 'metal-sn' },
            { id: 'Gold', name: 'é‡‘', class: 'metal-au' },
            { id: 'Tungsten', name: 'é’¨', class: 'metal-w' }
        ];

        const companyQuestionsData = [
            { id: 'A', text: 'è´µå…¬å¸æ˜¯å¦å·²åˆ¶å®šè´Ÿè´£ä»»çŸ¿äº§é‡‡è´­æ”¿ç­–ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
            { id: 'B', text: 'è´µå…¬å¸çš„è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­æ”¿ç­–æ˜¯å¦å…¬å¼€å‘å¸ƒäºè´µå…¬å¸ç½‘é¡µä¸Šï¼Ÿï¼ˆå¤‡æ³¨ - å¦‚æœæ˜¯ï¼Œè¯·åœ¨æ³¨é‡Šå­—æ®µä¸­æ³¨æ˜ URLã€‚ï¼‰', options: ['Yes', 'No'], commentCondition: 'Yes', commentHint: 'å¦‚é€‰Yesï¼Œè¯·å¡«å†™URL' },
            { id: 'C', text: 'æ‚¨æ˜¯å¦è¦æ±‚æ‚¨çš„ç›´æ¥ä¾›åº”å•†ä»å…¶å°½èŒè°ƒæŸ¥å®è·µå·²è¢«è¢«ç‹¬ç«‹ç¬¬ä¸‰æ–¹å®¡æ ¸æœºæ„éªŒè¯è¿‡çš„å†¶ç‚¼å‚é‡‡è´­ 3TGï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
            { id: 'D', text: 'è´µå…¬å¸æ˜¯å¦å·²å®æ–½è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­çš„å°½èŒè°ƒæŸ¥æªæ–½ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
            { id: 'E', text: 'è´µå…¬å¸æ˜¯å¦å¼€å±•äº†ç›¸å…³ä¾›åº”å•†çš„å†²çªçŸ¿äº§è°ƒæŸ¥ï¼Ÿ', options: ['Yes, in conformance with IPC1755 (e.g., CMRT)', 'Yes, using other format (describe)', 'No'], commentCondition: 'Yes, using other format (describe)', commentHint: 'è¯·æè¿°ä½¿ç”¨çš„å…¶ä»–æ ¼å¼' },
            { id: 'F', text: 'è´µå…¬å¸æ˜¯å¦æ ¹æ®å…¬å¸æœŸæœ›æ¥å®¡æŸ¥ä¾›åº”å•†æäº¤çš„å°½èŒè°ƒæŸ¥ä¿¡æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
            { id: 'G', text: 'è´µå…¬å¸çš„éªŒè¯ç¨‹åºæ˜¯å¦åŒ…æ‹¬çº æ­£æªæ–½ç®¡ç†ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
            { id: 'H', text: 'è´µå…¬å¸æ˜¯å¦éœ€è¦æäº¤å¹´åº¦å†²çªçŸ¿äº§æŠ«éœ²ï¼Ÿ', options: ['Yes, with the SEC', 'Yes, with the EU', 'Yes, with the SEC and the EU', 'No'], commentCondition: null }
        ];

        const smelterLookupOptions = [
            'Select from list...',
            'Smelter not listed',
            'Smelter not yet identified',
            '---',
            'Ningxia Orient Tantalum Industry Co., Ltd.',
            'Malaysia Smelting Corporation',
            'Xiamen Tungsten Co., Ltd.',
            'Metalor Technologies SA'
        ];

        const countries = ['China', 'Malaysia', 'Indonesia', 'Japan', 'USA', 'Germany', 'Switzerland', 'Vietnam', 'Thailand', 'Philippines'];

        function getVersionFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const v = params.get('version');
            return v && versionConfigs[v] ? v : null;
        }

        function initVersionSelector() {
            const select = document.getElementById('versionSelect');
            if (!select) return;
            select.innerHTML = '';
            ['6.5', '6.4', '6.31', '6.22', '6.1', '6.01'].forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = `v${v}`;
                select.appendChild(opt);
            });
            select.value = currentVersion;
            select.addEventListener('change', () => {
                const params = new URLSearchParams(window.location.search);
                params.set('version', select.value);
                window.location.search = params.toString();
            });
        }

        function applyVersion(version) {
            const config = versionConfigs[version] || versionConfigs[defaultVersion];
            currentVersion = version;
            document.querySelector('.logo-version').textContent = `v${config.label}`;
        }

        function isLegacySmelterNotListedStrict() {
            return currentVersion === '6.01' || currentVersion === '6.1';
        }

        // æ ‡è®°æ˜¯å¦æœ‰æ•°æ®ä¿®æ”¹ï¼ˆç”¨äºç¦»å¼€ç¡®è®¤ï¼‰
        let hasUnsavedChanges = false;
        let currentPageId = 'declaration';
        let lastCheckerSummary = { errors: [], passed: [], completion: 0 };

        function getPageOrder() {
            return ['declaration', 'smelter', 'product', 'checker'];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initVersionSelector();
            applyVersion(currentVersion);
            initQuestionMatrix();
            initCompanyQuestions();
            setupFormListeners();
            updateCompanyFieldsCount();
            addSmelterRow();
            addProductRow();
            updateCompanyQuestionsState();
            updateQ2Dependency();
            updateQ3Q8Dependency();
            runChecker();
            setupProgressNavigation();
            goToPage('declaration');
            updateStickyOffsets();
            window.addEventListener('resize', updateStickyOffsets);
            setupBeforeUnload();
        });

        // ç¦»å¼€ç¡®è®¤
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                    return e.returnValue;
                }
            });
        }

        // æ ‡è®°æ•°æ®å·²ä¿®æ”¹
        function markAsModified() {
            hasUnsavedChanges = true;
        }

        function updateStickyOffsets() {
            const nav = document.querySelector('.top-nav');
            if (!nav) return;
            const height = nav.getBoundingClientRect().height;
            document.documentElement.style.setProperty('--top-nav-height', `${height}px`);
        }

        function setupProgressNavigation() {
            document.querySelectorAll('.progress-step').forEach(step => {
                step.addEventListener('click', () => {
                    const target = step.dataset.step;
                    if (!getPageOrder().includes(target)) return;
                    goToPage(target);
                });
            });
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.page-actions button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action !== 'prev' && action !== 'next') return;
            const target = btn.dataset.target;
            if (target) goToPage(target);
        });

        function updatePageActions() {
            const pageOrder = getPageOrder();
            document.querySelectorAll('.page-actions').forEach(actions => {
                const pageId = actions.dataset.page;
                const index = pageOrder.indexOf(pageId);
                const prevBtn = actions.querySelector('[data-action="prev"]');
                const nextBtn = actions.querySelector('[data-action="next"]');
                if (prevBtn) {
                    const prevPage = index > 0 ? pageOrder[index - 1] : '';
                    prevBtn.disabled = index <= 0;
                    prevBtn.dataset.target = prevPage;
                }
                if (nextBtn) {
                    const nextPage = index >= 0 && index < pageOrder.length - 1 ? pageOrder[index + 1] : '';
                    nextBtn.disabled = index === -1 || index >= pageOrder.length - 1;
                    nextBtn.dataset.target = nextPage;
                }
            });
        }

        function goToPage(pageId) {
            const page = document.getElementById('page-' + pageId);
            if (!page) return;
            currentPageId = pageId;
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            page.classList.add('active');
            updateProgressIndicator(pageId);
            updatePageActions();
            if (pageId === 'checker') {
                runChecker();
            }
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(currentPage) {
            const steps = document.querySelectorAll('.progress-step');
            const pageOrder = getPageOrder();
            const currentIndex = pageOrder.indexOf(currentPage);
            
            steps.forEach(step => {
                const stepPage = step.dataset.step;
                const index = pageOrder.indexOf(stepPage);
                if (index === -1) return;
                step.classList.remove('active', 'completed');
                if (index < currentIndex) {
                    step.classList.add('completed');
                    step.querySelector('.progress-step-num').textContent = 'âœ“';
                } else if (index === currentIndex) {
                    step.classList.add('active');
                    step.querySelector('.progress-step-num').textContent = index + 1;
                } else {
                    step.querySelector('.progress-step-num').textContent = index + 1;
                }
            });
        }

        // è·³è½¬åˆ° Checker é¡µé¢
        function goToChecker() {
            goToPage('checker');
        }

        // åˆ‡æ¢é€šè¿‡é¡¹å±•å¼€/æŠ˜å 
        function togglePassedDetails() {
            const details = document.getElementById('passedDetails');
            const btn = document.getElementById('passedToggleBtn');
            details.classList.toggle('expanded');
            btn.textContent = details.classList.contains('expanded') ? 'æ”¶èµ·' : 'å±•å¼€æŸ¥çœ‹';
        }

        // åˆ‡æ¢é”™è¯¯åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleErrorGroup(groupId) {
            const group = document.getElementById(groupId);
            group.classList.toggle('collapsed');
        }

        function handleModalBackdrop(event) {
            if (event.target && event.target.id === 'submitModal') {
                closeSubmitModal();
            }
        }

        function openSubmitModal() {
            const result = runChecker();
            const errors = result?.errors || lastCheckerSummary.errors || [];
            const completion = result?.completion ?? lastCheckerSummary.completion ?? 0;
            const errorCount = errors.length;

            document.getElementById('submitCompletion').textContent = completion + '%';
            document.getElementById('submitErrorCount').textContent = errorCount;

            const list = document.getElementById('submitErrorsList');
            const errorsSection = document.getElementById('submitErrorsSection');
            const allPass = document.getElementById('submitAllPass');
            const fixBtn = document.getElementById('submitFixBtn');

            if (errorCount === 0) {
                errorsSection.style.display = 'none';
                allPass.style.display = 'block';
                if (fixBtn) fixBtn.disabled = true;
                list.innerHTML = '';
            } else {
                errorsSection.style.display = 'block';
                allPass.style.display = 'none';
                if (fixBtn) fixBtn.disabled = false;
                list.innerHTML = errors.slice(0, 5).map(item => `
                    <li class="submit-error-item">
                        <span>âŒ</span>
                        <div>
                            <div>${formatCheckerLocation(item.location || '')}</div>
                            <div style="color: var(--gray-500); font-size: 12px;">${item.message}</div>
                        </div>
                    </li>
                `).join('');
            }

            document.getElementById('submitModal').classList.add('show');
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').classList.remove('show');
        }

        function handleSubmitFix() {
            closeSubmitModal();
            goToChecker();
            const errorsCard = document.getElementById('errorsCard');
            if (errorsCard) {
                setTimeout(() => errorsCard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
        }

        // Initialize Question Matrix - æ­£ç¡®å¸ƒå±€ï¼šæ¯ä¸ªé—®é¢˜ä¸‹æœ‰4è¡Œé‡‘å±
        function initQuestionMatrix() {
            const container = document.getElementById('questionMatrixContainer');
            container.innerHTML = '';

            // Initialize data structure
            questions.forEach(q => {
                appData.questionMatrix[q.id] = {};
                metals.forEach(m => {
                    appData.questionMatrix[q.id][m.id] = { answer: '', comment: '' };
                });
            });

            questions.forEach(q => {
                const block = document.createElement('div');
                block.className = 'question-block';
                block.id = 'question-' + q.id;

                const isDependentQ = q.dependency === 'Q1Q2';

                block.innerHTML = `
                    <div class="question-header">
                        <span class="q-num">${q.id.replace('Q', '')}</span>
                        ${q.text} ${isDependentQ ? '' : '<span style="color: #ffeb3b;">(*)</span>'}
                    </div>
                    <table class="question-table">
                        <thead>
                            <tr>
                                <th style="width: 120px;"></th>
                                <th style="width: 200px;">å›ç­”</th>
                                <th>æ³¨é‡Š</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${metals.map(m => `
                                <tr data-metal="${m.id}">
                                    <td>
                                        <span class="metal-label ${m.class}">
                                            ${m.name} ${m.id} <span class="required">*</span>
                                        </span>
                                    </td>
                                    <td>
                                        <select class="answer-select" data-question="${q.id}" data-metal="${m.id}" ${isDependentQ ? 'disabled' : ''}>
                                            <option value="">--</option>
                                            ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="comment-input" data-question="${q.id}" data-metal="${m.id}" placeholder="æ³¨é‡Š (å¯é€‰)">
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    ${isDependentQ ? '<div class="q-dependency-hint">â†³ Q1 æˆ– Q2 é€‰æ‹© "No" æ—¶ï¼Œæœ¬é¢˜ä¸è¦æ±‚å¡«å†™</div>' : ''}
                `;
                container.appendChild(block);
            });

            // Add change listeners
            container.querySelectorAll('.answer-select').forEach(select => {
                select.addEventListener('change', function() {
                    const q = this.dataset.question;
                    const m = this.dataset.metal;
                    appData.questionMatrix[q][m].answer = this.value;
                    
                    // Update style
                    this.classList.toggle('answered', this.value !== '');
                    
                    // Check dependencies
                    if (q === 'Q1') {
                        updateQ2Dependency();
                        updateQ3Q8Dependency();
                        updateCompanyQuestionsState();
                    } else if (q === 'Q2') {
                        updateQ3Q8Dependency();
                        updateCompanyQuestionsState();
                    }
                    
                    markAsModified();
                    runChecker();
                });
            });

            container.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('input', function() {
                    const q = this.dataset.question;
                    const m = this.dataset.metal;
                    appData.questionMatrix[q][m].comment = this.value;
                    markAsModified();
                });
            });
        }

        function updateQ2Dependency() {
            metals.forEach(m => {
                const q1Answer = appData.questionMatrix['Q1'][m.id].answer;
                const required = q1Answer !== 'No';
                const q2Select = document.querySelector(`select[data-question="Q2"][data-metal="${m.id}"]`);
                const q2Comment = document.querySelector(`input.comment-input[data-question="Q2"][data-metal="${m.id}"]`);

                if (q2Select) {
                    q2Select.disabled = !required;
                    q2Select.classList.toggle('disabled', !required);
                    if (!required) {
                        q2Select.value = '';
                        q2Select.classList.remove('answered');
                        appData.questionMatrix['Q2'][m.id].answer = '';
                    }
                }

                if (q2Comment) {
                    q2Comment.disabled = !required;
                    q2Comment.classList.toggle('disabled', !required);
                    if (!required) {
                        q2Comment.value = '';
                        appData.questionMatrix['Q2'][m.id].comment = '';
                    }
                }
            });
        }

        function updateQ3Q8Dependency() {
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é‡‘å±çš„ Q3-Q8 éƒ½è¢«ç¦ç”¨
            let allQ3Q8Disabled = true;
            
            metals.forEach(m => {
                const q1Answer = appData.questionMatrix['Q1'][m.id].answer;
                const q2Answer = appData.questionMatrix['Q2'][m.id].answer;
                const required = q1Answer !== 'No' && q2Answer !== 'No';
                
                if (required) allQ3Q8Disabled = false;

                ['Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'].forEach(qId => {
                    const select = document.querySelector(`select[data-question="${qId}"][data-metal="${m.id}"]`);
                    const comment = document.querySelector(`input.comment-input[data-question="${qId}"][data-metal="${m.id}"]`);
                    const row = select ? select.closest('tr') : null;
                    
                    if (select) {
                        select.disabled = !required;
                        select.classList.toggle('disabled', !required);
                        if (!required) {
                            select.value = '';
                            select.classList.remove('answered');
                            appData.questionMatrix[qId][m.id].answer = '';
                        }
                    }
                    if (comment) {
                        comment.disabled = !required;
                        comment.classList.toggle('disabled', !required);
                        if (!required) {
                            comment.value = '';
                            appData.questionMatrix[qId][m.id].comment = '';
                        }
                    }
                    
                    // ä¸ºç¦ç”¨çš„è¡Œæ·»åŠ è§†è§‰æç¤º
                    if (row) {
                        row.style.opacity = required ? '1' : '0.5';
                    }
                });
            });
            
            // æ›´æ–° Q3-Q8 åŒºå—çš„æ•´ä½“ç¦ç”¨çŠ¶æ€æç¤º
            ['Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'].forEach(qId => {
                const block = document.getElementById('question-' + qId);
                if (block) {
                    // æ£€æŸ¥æ­¤é—®é¢˜æ˜¯å¦æ‰€æœ‰é‡‘å±éƒ½è¢«ç¦ç”¨
                    let allDisabledForQ = true;
                    metals.forEach(m => {
                        const q1Answer = appData.questionMatrix['Q1'][m.id].answer;
                        const q2Answer = appData.questionMatrix['Q2'][m.id].answer;
                        if (q1Answer !== 'No' && q2Answer !== 'No') {
                            allDisabledForQ = false;
                        }
                    });
                    
                    // ç§»é™¤æ—§çš„é®ç½©æç¤º
                    const oldHint = block.querySelector('.disabled-overlay-hint');
                    if (oldHint) oldHint.remove();
                    block.classList.remove('disabled-overlay');
                }
            });
        }

        function updateCompanyQuestionsState() {
            // Check if any metal has Q1/Q2 not "No"
            let anyRequired = false;
            metals.forEach(m => {
                const q1 = appData.questionMatrix['Q1'][m.id].answer;
                const q2 = appData.questionMatrix['Q2'][m.id].answer;
                if (q1 !== 'No' && q2 !== 'No') {
                    anyRequired = true;
                }
            });

            const container = document.getElementById('companyQuestionsBody');
            const status = document.getElementById('cqStatus');
            
            container.classList.remove('cq-disabled');
            container.classList.toggle('cq-required', anyRequired);
            if (anyRequired) {
                status.textContent = 'å¿…å¡«';
                status.style.background = 'var(--error-light)';
                status.style.color = 'var(--error)';
            } else {
                status.textContent = 'Q1 æˆ– Q2 é€‰æ‹© No æ—¶å¯é€‰å¡«å†™';
                status.style.background = '';
                status.style.color = '';
            }
        }

        // Initialize Company Questions
        function initCompanyQuestions() {
            const container = document.getElementById('companyQuestionsBody');
            container.innerHTML = '';

            companyQuestionsData.forEach(q => {
                const div = document.createElement('div');
                div.className = 'company-question';
                div.innerHTML = `
                    <div class="cq-letter">${q.id}</div>
                    <div class="cq-content">
                        <div class="cq-text">${q.text}</div>
                        <div class="cq-options">
                            <select class="cq-select" data-question="${q.id}">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                                ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                            </select>
                        </div>
                        ${q.commentCondition ? `
                            <div class="cq-comment" id="cq-comment-${q.id}">
                                <input type="text" placeholder="${q.commentHint || 'è¯·å¡«å†™æ³¨é‡Š'}" data-question="${q.id}">
                            </div>
                        ` : ''}
                    </div>
                `;
                container.appendChild(div);
            });

            // Add listeners
            container.querySelectorAll('.cq-select').forEach(select => {
                select.addEventListener('change', function() {
                    const qId = this.dataset.question;
                    appData.companyQuestions[qId] = this.value;
                    this.classList.toggle('answered', this.value !== '');

                    // Show/hide comment
                    const qData = companyQuestionsData.find(q => q.id === qId);
                    const comment = document.getElementById('cq-comment-' + qId);
                    if (comment && qData.commentCondition) {
                        comment.classList.toggle('show', this.value === qData.commentCondition);
                    }

                    markAsModified();
                    runChecker();
                });
            });

            // å…¬å¸å±‚é¢é—®é¢˜æ³¨é‡Šè¾“å…¥ä¹Ÿè§¦å‘ä¿®æ”¹æ ‡è®°
            container.querySelectorAll('.cq-comment input').forEach(input => {
                input.addEventListener('input', markAsModified);
            });
        }

        // Form Listeners
        function setupFormListeners() {
            document.getElementById('declarationScope').addEventListener('change', function() {
                const scopeDescGroup = document.getElementById('scopeDescGroup');
                scopeDescGroup.style.display = this.value === 'C' ? 'block' : 'none';
                
                // Remove required-field from input if it has value
                this.classList.toggle('required-field', !this.value);
                
                markAsModified();
                runChecker();
            });

            const handleCompanyFieldInput = (input) => {
                markAsModified();
                // Update visual state
                if (input.classList.contains('required-field') && input.value.trim()) {
                    input.classList.remove('required-field');
                    input.classList.add('valid');
                } else if (!input.value.trim() && input.closest('[data-required="true"]')) {
                    input.classList.add('required-field');
                    input.classList.remove('valid');
                }
                
                updateCompanyFieldsCount();
                runChecker();
            };

            document.querySelectorAll('#companyForm input, #companyForm select, #companyForm textarea').forEach(input => {
                input.addEventListener('input', () => handleCompanyFieldInput(input));
                input.addEventListener('change', () => handleCompanyFieldInput(input));
            });
        }

        function updateCompanyFieldsCount() {
            const requiredFields = document.querySelectorAll('#companyForm [data-required="true"]');
            let filled = 0;
            let total = 8; // åŸºç¡€ 8 ä¸ªå¿…å¡«å­—æ®µ
            
            requiredFields.forEach(group => {
                const input = group.querySelector('input, select, textarea');
                if (input && input.value.trim()) filled++;
            });
            
            // ä¿®å¤ï¼šR002 - scope=C æ—¶ scopeDescription ä¹Ÿæ˜¯å¿…å¡«
            const scope = document.getElementById('declarationScope').value;
            if (scope === 'C') {
                total += 1;
                const desc = document.getElementById('scopeDescription').value.trim();
                if (desc) filled++;
            }
            
            document.getElementById('companyFieldsCount').textContent = `${filled}/${total} å¿…å¡«å·²å®Œæˆ`;
        }

        // Smelter List Functions - å®Œæ•´ 17 å­—æ®µ
        function addSmelterRow() {
            const tbody = document.getElementById('smelterTableBody');
            const rowId = 'smelter-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td class="sticky-col-1" style="left: 0; background: white;"><input type="text" placeholder="è¾“å…¥è¯†åˆ«å·..." style="font-family: var(--font-mono); font-size: 11px;" onchange="handleSmelterIdInput(this, '${rowId}'); markAsModified(); runChecker();"></td>
                <td class="sticky-col-2" style="left: 120px; background: white;">
                    <select class="metal-select" style="background: var(--yellow-fill);" onchange="this.style.background = this.value ? 'white' : 'var(--yellow-fill)'; markAsModified(); runChecker();">
                        <option value="">--</option>
                        ${metals.map(m => `<option value="${m.id}">${m.id}</option>`).join('')}
                    </select>
                </td>
                <td class="sticky-col-3" style="left: 220px; background: white; border-right: 2px solid var(--gray-300);">
                    <select style="background: var(--yellow-fill);" onchange="this.style.background = this.value ? 'white' : 'var(--yellow-fill)'; handleSmelterLookupChange(this, '${rowId}'); markAsModified(); runChecker();">
                        ${smelterLookupOptions.map(opt => 
                            opt === '---' ? '<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>' : `<option value="${opt}">${opt}</option>`
                        ).join('')}
                    </select>
                </td>
                <td><input type="text" placeholder="å†¶ç‚¼å‚åç§°" onchange="markAsModified(); runChecker()"></td>
                <td>
                    <select onchange="runChecker()">
                        <option value="">-- é€‰æ‹© --</option>
                        ${countries.map(c => `<option value="${c}">${c}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" placeholder="CID..." style="font-family: var(--font-mono); font-size: 10px; background: var(--gray-100);" readonly></td>
                <td><input type="text" placeholder="Source ID" style="font-size: 10px; background: var(--gray-100);" readonly></td>
                <td><input type="text" placeholder="è¡—é“" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" placeholder="åŸå¸‚" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" placeholder="å·/çœ" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" placeholder="è”ç³»äºº" style="font-size: 11px;" oninput="markAsModified()"></td>
                <td><input type="email" placeholder="email@..." style="font-size: 11px;" oninput="markAsModified()"></td>
                <td><input type="text" placeholder="åç»­æ­¥éª¤" style="font-size: 11px;" oninput="markAsModified()"></td>
                <td><input type="text" placeholder="çŸ¿äº•åç§°" style="font-size: 11px;" oninput="markAsModified()"></td>
                <td><input type="text" placeholder="çŸ¿äº•å›½å®¶" style="font-size: 11px;" oninput="markAsModified()"></td>
                <td>
                    <select onchange="markAsModified(); runChecker()">
                        <option value="">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </td>
                <td><input type="text" placeholder="æ³¨é‡Š" style="font-size: 11px;" oninput="markAsModified()"></td>
                <td><button class="delete-row-btn" onclick="deleteRow('${rowId}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            updateSmelterCount();
        }

        // é€šè¿‡è¯†åˆ«å·è‡ªåŠ¨å¡«å……
        function handleSmelterIdInput(input, rowId) {
            const row = document.getElementById(rowId);
            const idValue = input.value.trim();
            
            if (idValue) {
                // æ¨¡æ‹Ÿè‡ªåŠ¨å¡«å……ï¼ˆå®é™…ç³»ç»Ÿä¼šä»æ•°æ®åº“æŸ¥è¯¢ï¼‰
                const inputs = row.querySelectorAll('input');
                const selects = row.querySelectorAll('select');
                
                // inputs ç´¢å¼•: [0]=è¯†åˆ«å·è¾“å…¥, [1]=å†¶ç‚¼å‚åç§°, [2]=CID, [3]=å‡ºå¤„è¯†åˆ«å·, [4]=è¡—é“...
                // ç¤ºä¾‹ï¼šå¦‚æœè¾“å…¥ CID001234ï¼Œæ¨¡æ‹Ÿè‡ªåŠ¨å¡«å……
                if (idValue.startsWith('CID')) {
                    selects[0].value = 'Tantalum'; // é‡‘å±
                    selects[0].style.background = 'white';
                    inputs[2].value = idValue; // ä¿®å¤ï¼šCID åœ¨ inputs[2]
                    inputs[3].value = 'SRC-' + idValue.slice(3); // ä¿®å¤ï¼šå‡ºå¤„è¯†åˆ«å·åœ¨ inputs[3]
                    showToast('å·²é€šè¿‡è¯†åˆ«å·è‡ªåŠ¨å¡«å……éƒ¨åˆ†å­—æ®µ', 'success');
                }
            }
        }

        function handleSmelterLookupChange(select, rowId) {
            const row = document.getElementById(rowId);
            const inputs = row.querySelectorAll('input');
            const selects = row.querySelectorAll('select');
            
            // inputs: [0]=è¯†åˆ«å·è¾“å…¥, [1]=å†¶ç‚¼å‚åç§°, [2]=å†¶ç‚¼å‚è¯†åˆ«, [3]=å‡ºå¤„è¯†åˆ«å·, [4]=è¡—é“, [5]=åŸå¸‚, [6]=å·çœ, [7]=è”ç³»äºº, [8]=é‚®ç®±, [9]=åç»­æ­¥éª¤, [10]=çŸ¿äº•åç§°, [11]=çŸ¿äº•å›½å®¶, [12]=æ³¨é‡Š
            // selects: [0]=é‡‘å±, [1]=å†¶ç‚¼å‚æŸ¥æ‰¾, [2]=å›½å®¶, [3]=100%å›æ”¶æ–™

            if (select.value === 'Smelter not listed') {
                // æ‰‹åŠ¨å¡«å†™æ¨¡å¼
                inputs[1].disabled = false;
                inputs[1].placeholder = 'å¿…å¡«ï¼šå†¶ç‚¼å‚åç§°';
                inputs[1].style.background = 'var(--yellow-fill)';
                selects[2].disabled = false; // ä¿®å¤ï¼šæ¢å¤å›½å®¶ä¸‹æ‹‰å¯é€‰
                selects[2].style.background = 'var(--yellow-fill)';
                // æ¸…ç©ºè‡ªåŠ¨å¡«å……å­—æ®µ
                inputs[2].value = '';
                inputs[3].value = '';
                inputs[4].value = '';
                inputs[5].value = '';
                inputs[6].value = '';
            } else if (select.value === 'Smelter not yet identified') {
                // æœªè¯†åˆ«æ¨¡å¼
                inputs[1].disabled = false;
                inputs[1].placeholder = 'å¯å¡«å†™å†¶ç‚¼å‚åç§°';
                inputs[1].style.background = '';
                inputs[2].value = 'Unknown';
                selects[2].disabled = false; // ä¿®å¤ï¼šæ¢å¤å›½å®¶ä¸‹æ‹‰å¯é€‰
                selects[2].style.background = '';
            } else if (select.value && !select.value.includes('Select')) {
                // ä»ç›®å½•é€‰æ‹© - è‡ªåŠ¨å¡«å……
                inputs[1].value = select.value;
                inputs[1].disabled = true;
                inputs[1].style.background = 'var(--gray-100)';
                
                // æ¨¡æ‹Ÿè‡ªåŠ¨å¡«å……æ•°æ®
                const mockData = getSmelterMockData(select.value);
                inputs[2].value = mockData.cid;
                inputs[3].value = mockData.sourceId;
                inputs[4].value = mockData.street;
                inputs[5].value = mockData.city;
                inputs[6].value = mockData.state;
                selects[2].value = mockData.country;
                selects[2].style.background = 'var(--gray-100)';
                selects[2].disabled = true;
            }
        }

        // æ¨¡æ‹Ÿå†¶ç‚¼å‚æ•°æ®ï¼ˆå®é™…ç³»ç»Ÿä» Smelter Look-up è¡¨è·å–ï¼‰
        function getSmelterMockData(smelterName) {
            const mockDatabase = {
                'Ningxia Orient Tantalum Industry Co., Ltd.': {
                    cid: 'CID001277', sourceId: 'RMI-Ta-001', country: 'China', 
                    street: '123 Industrial Road', city: 'Shizuishan', state: 'Ningxia'
                },
                'Malaysia Smelting Corporation': {
                    cid: 'CID001105', sourceId: 'RMI-Sn-002', country: 'Malaysia',
                    street: '88 Smelter Ave', city: 'Butterworth', state: 'Penang'
                },
                'Xiamen Tungsten Co., Ltd.': {
                    cid: 'CID002082', sourceId: 'RMI-W-003', country: 'China',
                    street: '56 Tungsten Blvd', city: 'Xiamen', state: 'Fujian'
                },
                'Metalor Technologies SA': {
                    cid: 'CID001149', sourceId: 'RMI-Au-004', country: 'Switzerland',
                    street: '2 Metalor Strasse', city: 'Marin-Epagnier', state: 'NeuchÃ¢tel'
                }
            };
            return mockDatabase[smelterName] || {
                cid: 'CID' + Math.floor(Math.random() * 900000 + 100000),
                sourceId: 'SRC-' + Math.floor(Math.random() * 10000),
                country: '', street: '', city: '', state: ''
            };
        }

        function deleteRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateSmelterCount();
                updateProductCount();
                runChecker();
            }
        }

        function updateSmelterCount() {
            const count = document.querySelectorAll('#smelterTableBody tr').length;
            document.getElementById('smelterCount').textContent = `${count} æ¡è®°å½•`;
        }

        // Product List Functions
        function addProductRow() {
            const tbody = document.getElementById('productTableBody');
            const rowId = 'product-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><input type="text" placeholder="PRD-xxxx-xxx" style="font-family: var(--font-mono);" onchange="runChecker()"></td>
                <td><input type="text" placeholder="äº§å“åç§°" onchange="runChecker()"></td>
                <td><input type="text" placeholder="æ³¨é‡Š" onchange="runChecker()"></td>
                <td><button class="delete-row-btn" onclick="deleteRow('${rowId}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            updateProductCount();
        }

        function updateProductCount() {
            const count = document.querySelectorAll('#productTableBody tr').length;
            document.getElementById('productCount').textContent = `${count} æ¡è®°å½•`;
        }

        // Checker - æ­£ç¡®çš„æ ¡éªŒé€»è¾‘
        function runChecker() {
            const errors = [];
            const passed = [];
            const questionErrors = {
                Q1: [],
                Q2: [],
                Q3: [],
                Q4: [],
                Q5: [],
                Q6: [],
                Q7: [],
                Q8: []
            };
            const otherErrors = [];

            // === å…¬å¸ä¿¡æ¯å¿…å¡«é¡¹ ===
            const requiredFields = [
                { id: 'companyName', name: 'å…¬å¸åç§°' },
                { id: 'declarationScope', name: 'ç”³æŠ¥èŒƒå›´' },
                { id: 'contactName', name: 'è”ç³»äººå§“å' },
                { id: 'contactEmail', name: 'è”ç³»äººé‚®ç®±' },
                { id: 'contactPhone', name: 'è”ç³»äººç”µè¯' },
                { id: 'authorizer', name: 'æˆæƒäºº' },
                { id: 'authorizerEmail', name: 'æˆæƒäººé‚®ç®±' },
                { id: 'effectiveDate', name: 'ç”Ÿæ•ˆæ—¥æœŸ' }
            ];

            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) {
                    passed.push({ message: `${field.name} å·²å¡«å†™`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯' });
                } else {
                    otherErrors.push({ id: 'R001', message: `${field.name} ä¸ºå¿…å¡«é¡¹`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: field.id });
                }
            });

            // Email format check (must contain "@")
            [
                { id: 'contactEmail', name: 'è”ç³»äººé‚®ç®±' },
                { id: 'authorizerEmail', name: 'æˆæƒäººé‚®ç®±' }
            ].forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim() && !input.value.includes('@')) {
                    otherErrors.push({ id: 'R001', message: `${field.name} æ ¼å¼ä¸æ­£ç¡®`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: field.id });
                }
            });

            // R002: ç”³æŠ¥èŒƒå›´=C æ—¶èŒƒå›´æè¿°å¿…å¡«
            const scope = document.getElementById('declarationScope').value;
            if (scope === 'C') {
                const desc = document.getElementById('scopeDescription').value.trim();
                if (!desc) {
                    otherErrors.push({ id: 'R002', message: 'é€‰æ‹©è‡ªå®šä¹‰èŒƒå›´(C)æ—¶å¿…é¡»å¡«å†™èŒƒå›´æè¿°', location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: 'scopeDescription' });
                } else {
                    passed.push({ message: 'èŒƒå›´æè¿°å·²å¡«å†™', location: 'Declaration â†’ å…¬å¸ä¿¡æ¯' });
                }
            }

            // R001: ç”³æŠ¥èŒƒå›´=B æ—¶ Product List è‡³å°‘ä¸€è¡Œ
            if (scope === 'B') {
                const products = document.querySelectorAll('#productTableBody tr');
                let hasValidProduct = false;
                products.forEach(row => {
                    const productId = row.querySelector('input').value.trim();
                    if (productId) hasValidProduct = true;
                });
                if (!hasValidProduct) {
                    otherErrors.push({ id: 'R001', message: 'ç”³æŠ¥èŒƒå›´é€‰æ‹© B.Product æ—¶ï¼ŒProduct List è‡³å°‘éœ€è¦ä¸€æ¡æœ‰æ•ˆè®°å½•', location: 'Product List' });
                } else {
                    passed.push({ message: 'Product List å·²å¡«å†™', location: 'Product List' });
                }
            }

            // === é—®é¢˜çŸ©é˜µ ===
            // Q1 å¿…å¡«ï¼›Q2 åœ¨ Q1â‰ No æ—¶å¿…å¡«ï¼›Q3-Q8 åœ¨ Q1â‰ No ä¸” Q2â‰ No æ—¶å¿…å¡«
            let metalsWithQ1Required = []; // è®°å½•å“ªäº›é‡‘å± Q1â‰ Noï¼ˆQ2 å¿…å¡«ï¼‰
            let metalsWithFollowups = []; // è®°å½•å“ªäº›é‡‘å± Q1â‰ No ä¸” Q2â‰ Noï¼ˆQ3-Q8/A-H/Smelter å¿…å¡«ï¼‰

            metals.forEach(m => {
                const q1Answer = appData.questionMatrix['Q1'][m.id].answer;
                const q2Answer = appData.questionMatrix['Q2'][m.id].answer;

                // Q1 å¿…å¡«
                if (!q1Answer) {
                    questionErrors.Q1.push({ id: 'R003', message: `Q1 ${m.id} (${m.name}) æœªå›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: 'question-Q1' });
                } else {
                    passed.push({ message: `Q1 ${m.id} å·²å›ç­”: ${q1Answer}`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                }

                if (q1Answer !== 'No') {
                    metalsWithQ1Required.push(m.id);
                    // Q2 å¿…å¡«ï¼ˆQ1=No æ—¶ä¸è¦æ±‚ï¼‰
                    if (!q2Answer) {
                        questionErrors.Q2.push({ id: 'R003', message: `Q2 ${m.id} (${m.name}) æœªå›ç­” (Q1=No æ—¶å¯ä¸å¡«)`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: 'question-Q2' });
                    } else {
                        passed.push({ message: `Q2 ${m.id} å·²å›ç­”: ${q2Answer}`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                    }

                    // R003: ä»…å½“ Q1/Q2 å‡ä¸ä¸º Noï¼Œåˆ™ Q3-Q8 å¿…å¡«
                    if (q2Answer !== 'No') {
                        metalsWithFollowups.push(m.id);

                        ['Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'].forEach(qId => {
                            const answer = appData.questionMatrix[qId][m.id].answer;
                            if (!answer) {
                                questionErrors[qId].push({ id: 'R003', message: `${qId} ${m.id} (${m.name}) æœªå›ç­” (Q1 æˆ– Q2 ä¸º No æ—¶å¯ä¸å¡«)`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: `question-${qId}` });
                            } else {
                                passed.push({ message: `${qId} ${m.id} å·²å›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                            }
                        });
                    }
                }
            });

            // === å…¬å¸å±‚é¢é—®é¢˜ A-H ===
            // R004: åªæœ‰å½“ä»»ä¸€é‡‘å± Q1/Q2 ä¸ä¸º No æ—¶æ‰å¿…å¡«
            if (metalsWithFollowups.length > 0) {
                companyQuestionsData.forEach(q => {
                    if (!appData.companyQuestions[q.id]) {
                        otherErrors.push({ id: 'R004', message: `å…¬å¸é—®é¢˜ ${q.id} æœªå›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'companyQuestionsCard' });
                    } else {
                        passed.push({ message: `å…¬å¸é—®é¢˜ ${q.id} å·²å›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜' });
                        
                        // R006: E=Using other format æ—¶æ³¨é‡Šå¿…å¡«
                        if (q.id === 'E' && appData.companyQuestions[q.id] === 'Yes, using other format (describe)') {
                            const commentInput = document.querySelector(`#cq-comment-E input`);
                            if (!commentInput || !commentInput.value.trim()) {
                                otherErrors.push({ id: 'R006', message: 'é—®é¢˜E é€‰æ‹© "using other format" æ—¶æ³¨é‡Šå¿…å¡«', location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'cq-comment-E' });
                            }
                        }
                        
                        // R005: B=Yes æ—¶æ³¨é‡Šåº”åŒ…å«URL
                        if (q.id === 'B' && appData.companyQuestions[q.id] === 'Yes') {
                            const commentInput = document.querySelector(`#cq-comment-B input`);
                            if (!commentInput || !commentInput.value.trim()) {
                                otherErrors.push({ id: 'R005', message: 'The URL in the comment field', location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'cq-comment-B' });
                            }
                        }
                    }
                });
            } else {
                // å¦‚æœæ²¡æœ‰é‡‘å± Q1&Q2=Yesï¼ŒA-H ä¸éœ€è¦å¡«å†™ï¼Œæ˜¾ç¤ºä¸ºé€šè¿‡
                passed.push({ message: 'A-H æ— éœ€å¡«å†™ (æ‰€æœ‰é‡‘å± Q1 æˆ– Q2 ä¸º No)', location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜' });
            }

            // === Smelter List ===
            const smelterRows = document.querySelectorAll('#smelterTableBody tr');
            const smelterMetals = {};
            
            smelterRows.forEach((row, index) => {
                const metal = row.querySelector('.metal-select').value;
                const lookup = row.querySelectorAll('select')[1].value;
                // ä¿®å¤ï¼šinputs[1] æ˜¯å†¶ç‚¼å‚åç§°ï¼Œinputs[0] æ˜¯è¯†åˆ«å·è¾“å…¥åˆ—
                const name = row.querySelectorAll('input')[1].value.trim();
                const country = row.querySelectorAll('select')[2].value;

                if (metal) {
                    smelterMetals[metal] = true;
                }

                // R007: ä»… 6.01/6.1 å¼ºåˆ¶ Smelter not listed æ—¶åç§°å’Œå›½å®¶å¿…å¡«
                if (lookup === 'Smelter not listed' && isLegacySmelterNotListedStrict()) {
                    if (!name) {
                        otherErrors.push({ id: 'R007', message: `Smelter List ç¬¬ ${index + 1} è¡Œ: é€‰æ‹© "Smelter not listed" æ—¶å†¶ç‚¼å‚åç§°å¿…å¡«`, location: 'Smelter List', field: 'smelterTable' });
                    }
                    if (!country) {
                        otherErrors.push({ id: 'R007', message: `Smelter List ç¬¬ ${index + 1} è¡Œ: é€‰æ‹© "Smelter not listed" æ—¶å›½å®¶å¿…å¡«`, location: 'Smelter List', field: 'smelterTable' });
                    }
                }
            });

            // æ£€æŸ¥æœ‰ Q1&Q2=Yes çš„é‡‘å±æ˜¯å¦åœ¨ Smelter List ä¸­æœ‰è®°å½•
            metalsWithFollowups.forEach(metal => {
                if (!smelterMetals[metal]) {
                    otherErrors.push({ id: 'R008', message: `${metal} çš„ Q1/Q2 æœªé€‰æ‹© Noï¼Œä½† Smelter List ä¸­æ²¡æœ‰å¯¹åº”çš„å†¶ç‚¼å‚è®°å½•`, location: 'Smelter List', field: 'smelterTable' });
                }
            });

            const otherById = {};
            otherErrors.forEach(item => {
                if (!otherById[item.id]) otherById[item.id] = [];
                otherById[item.id].push(item);
            });
            const ruleOrder = ['R001', 'R002', 'R003', 'R004', 'R005', 'R006', 'R007', 'R008', 'R011'];
            ruleOrder.forEach(ruleId => {
                if (ruleId === 'R003') {
                    errors.push(
                        ...questionErrors.Q1,
                        ...questionErrors.Q2,
                        ...questionErrors.Q3,
                        ...questionErrors.Q4,
                        ...questionErrors.Q5,
                        ...questionErrors.Q6,
                        ...questionErrors.Q7,
                        ...questionErrors.Q8
                    );
                } else if (otherById[ruleId]) {
                    errors.push(...otherById[ruleId]);
                }
            });

            errors.sort(compareCheckerErrors);

            // === è®¡ç®—å®Œæˆåº¦ ===
            // åŸºç¡€å¿…å¡«é¡¹: å…¬å¸ä¿¡æ¯å­—æ®µ + Q1(4ä¸ª) + Q2(ä»…å½“ Q1=Yes)
            let totalRequired = requiredFields.length + metals.length + metalsWithQ1Required.length;
            let completedRequired = 0;
            
            // å…¬å¸ä¿¡æ¯
            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) completedRequired++;
            });

            // ä¿®å¤ï¼šR002 - scope=C æ—¶ scopeDescription æ˜¯å¿…å¡«é¡¹
            if (scope === 'C') {
                totalRequired += 1; // å¢åŠ  scopeDescription åˆ°å¿…å¡«è®¡æ•°
                const desc = document.getElementById('scopeDescription').value.trim();
                if (desc) completedRequired++;
            }
            
            // Q1/Q2
            metals.forEach(m => {
                const q1 = appData.questionMatrix['Q1'][m.id].answer;
                const q2 = appData.questionMatrix['Q2'][m.id].answer;
                if (q1) completedRequired++;
                if (q1 !== 'No' && q2) completedRequired++;
            });

            // å¦‚æœæœ‰ metalsWithFollowupsï¼Œå¢åŠ  Q3-Q8 å’Œ A-H çš„è¦æ±‚
            if (metalsWithFollowups.length > 0) {
                totalRequired += metalsWithFollowups.length * 6; // Q3-Q8 for each metal required
                totalRequired += 8; // A-H

                metalsWithFollowups.forEach(m => {
                    ['Q3', 'Q4', 'Q5', 'Q6', 'Q7', 'Q8'].forEach(qId => {
                        if (appData.questionMatrix[qId][m].answer) completedRequired++;
                    });
                });

                companyQuestionsData.forEach(q => {
                    if (appData.companyQuestions[q.id]) completedRequired++;
                });
            }

            const completion = totalRequired > 0 ? Math.round((completedRequired / totalRequired) * 100) : 0;

            // Update UI
            const errorCountEl = document.getElementById('errorCount');
            if (errorCountEl) errorCountEl.textContent = errors.length;
            const passedCountEl = document.getElementById('passedCount');
            if (passedCountEl) passedCountEl.textContent = passed.length;
            const completionEl = document.getElementById('completionRate');
            if (completionEl) completionEl.textContent = completion + '%';
            document.getElementById('progressText').textContent = completion + '%';
            document.getElementById('progressFill').style.width = completion + '%';

            document.getElementById('errorBadge').textContent = errors.length + ' é¡¹';
            document.getElementById('passedBadge').textContent = passed.length + ' é¡¹';

            document.getElementById('errorsCard').style.display = errors.length > 0 ? 'block' : 'none';

            // æ›´æ–°å…¨å±€é”™è¯¯æç¤ºæ¡
            updateGlobalErrorBar(errors.length);

            // æ›´æ–°é€šè¿‡é¡¹æ‘˜è¦
            document.getElementById('passedSummaryText').textContent = `å·²é€šè¿‡ ${passed.length} é¡¹æ£€æŸ¥`;

            // æ¸²æŸ“åˆ†ç»„é”™è¯¯åˆ—è¡¨
            renderGroupedErrors(errors);
            
            // æ¸²æŸ“é€šè¿‡é¡¹åˆ—è¡¨
            renderCheckerList('passedList', passed, 'success');

            lastCheckerSummary = { errors, passed, completion };
            return lastCheckerSummary;
        }

        function compareCheckerErrors(a, b) {
            const sectionOrder = {
                companyInfo: 0,
                questionMatrix: 1,
                companyQuestions: 2,
                smelterList: 3,
                mineList: 4,
                productList: 5,
                mineralsScope: 6
            };
            const aSection = getErrorSectionKey(a, sectionOrder);
            const bSection = getErrorSectionKey(b, sectionOrder);
            if (aSection !== bSection) return aSection - bSection;

            if (aSection === sectionOrder.companyInfo) {
                const fieldOrder = [
                    'companyName', 'declarationScope', 'scopeDescription', 'uniqueId', 'authId', 'address',
                    'contactName', 'contactEmail', 'contactPhone', 'authorizerName', 'authorizerTitle',
                    'authorizerEmail', 'authorizerPhone', 'authDate'
                ];
                const aIdx = fieldOrder.indexOf(a.field);
                const bIdx = fieldOrder.indexOf(b.field);
                if (aIdx !== bIdx) return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
            }

            if (aSection === sectionOrder.questionMatrix) {
                const questionOrder = {};
                questions.forEach((q, idx) => { questionOrder[q.id] = idx; });
                const qa = a.questionId || extractQuestionId(a.message);
                const qb = b.questionId || extractQuestionId(b.message);
                if (qa || qb) {
                    const aIdx = qa ? (questionOrder[qa] ?? 999) : 999;
                    const bIdx = qb ? (questionOrder[qb] ?? 999) : 999;
                    if (aIdx !== bIdx) return aIdx - bIdx;
                }
                const ma = a.mineral || findMetalInMessage(a.message);
                const mb = b.mineral || findMetalInMessage(b.message);
                const mIdxA = metalIndex(ma);
                const mIdxB = metalIndex(mb);
                if (mIdxA !== mIdxB) return mIdxA - mIdxB;
            }

            if (aSection === sectionOrder.companyQuestions) {
                const companyOrder = {};
                companyQuestionsData.forEach((q, idx) => { companyOrder[q.id] = idx; });
                const qa = a.questionId || extractCompanyQuestionId(a.message);
                const qb = b.questionId || extractCompanyQuestionId(b.message);
                if (qa || qb) {
                    const aIdx = qa ? (companyOrder[qa] ?? 999) : 999;
                    const bIdx = qb ? (companyOrder[qb] ?? 999) : 999;
                    if (aIdx !== bIdx) return aIdx - bIdx;
                }
            }

            const aRow = extractRowIndex(a.message);
            const bRow = extractRowIndex(b.message);
            if (aRow !== bRow) return aRow - bRow;

            return String(a.message || '').localeCompare(String(b.message || ''));
        }

        function getErrorSectionKey(error, sectionOrder) {
            const loc = error.location || '';
            if (loc.includes('å…¬å¸ä¿¡æ¯')) return sectionOrder.companyInfo;
            if (loc.includes('é—®é¢˜çŸ©é˜µ')) return sectionOrder.questionMatrix;
            if (loc.includes('å…¬å¸å±‚é¢')) return sectionOrder.companyQuestions;
            if (loc.includes('Smelter') || loc.includes('å†¶ç‚¼å‚')) return sectionOrder.smelterList;
            if (loc.includes('Mine') || loc.includes('çŸ¿å‚')) return sectionOrder.mineList;
            if (loc.includes('Product') || loc.includes('äº§å“')) return sectionOrder.productList;
            if (loc.includes('Scope') || loc.includes('çŸ¿ç‰©èŒƒå›´') || loc.includes('Minerals')) return sectionOrder.mineralsScope;
            return 99;
        }

        function extractQuestionId(message) {
            const match = message && message.match(/(Q\\d+)/);
            return match ? match[1] : null;
        }

        function extractCompanyQuestionId(message) {
            const match = message && message.match(/å…¬å¸é—®é¢˜\\s*([A-Z])/);
            return match ? match[1] : null;
        }

        function extractRowIndex(message) {
            const match = message && message.match(/ç¬¬\\s*(\\d+)\\s*è¡Œ/);
            return match ? Number(match[1]) : 999;
        }

        function findMetalInMessage(message) {
            if (!message) return null;
            return metals.map(m => m.id).find(id => message.includes(id)) || null;
        }

        function metalIndex(metal) {
            if (!metal) return 999;
            const list = metals.map(m => m.id);
            const idx = list.indexOf(metal);
            return idx === -1 ? 999 : idx;
        }

        // æ›´æ–°å…¨å±€é”™è¯¯æç¤ºæ¡
        function updateGlobalErrorBar(errorCount) {
            const bar = document.getElementById('globalErrorBar');
            const icon = document.getElementById('globalErrorIcon');
            const text = document.getElementById('globalErrorText');
            
            if (errorCount > 0) {
                bar.className = 'global-error-bar has-errors';
                icon.textContent = 'âš ï¸';
                text.textContent = `è¿˜æœ‰ ${errorCount} ä¸ªå¿…å¡«é¡¹æœªå®Œæˆ`;
            } else {
                bar.className = 'global-error-bar all-passed';
                icon.textContent = 'âœ…';
                text.textContent = 'æ‰€æœ‰å¿…å¡«é¡¹å·²å®Œæˆ';
            }
        }

        // æ¸²æŸ“åˆ†ç»„é”™è¯¯åˆ—è¡¨
        function renderGroupedErrors(errors) {
            const container = document.getElementById('groupedErrorsList');
            
            // æŒ‰æ¨¡å—åˆ†ç»„
            const groups = {
                companyInfo: { label: 'å…¬å¸ä¿¡æ¯', errors: [] },
                questionMatrix: { label: 'é—®é¢˜çŸ©é˜µ (Q1-Q8)', errors: [] },
                companyQuestions: { label: 'å…¬å¸å±‚é¢é—®é¢˜ (A-H)', errors: [] },
                smelterList: { label: 'å†¶ç‚¼å‚æ¸…å•', errors: [] },
                productList: { label: 'äº§å“æ¸…å•', errors: [] }
            };
            
            errors.forEach(error => {
                const loc = error.location || '';
                if (loc.includes('å…¬å¸ä¿¡æ¯')) {
                    groups.companyInfo.errors.push(error);
                } else if (loc.includes('é—®é¢˜çŸ©é˜µ')) {
                    groups.questionMatrix.errors.push(error);
                } else if (loc.includes('å…¬å¸å±‚é¢')) {
                    groups.companyQuestions.errors.push(error);
                } else if (loc.includes('Smelter') || loc.includes('å†¶ç‚¼å‚')) {
                    groups.smelterList.errors.push(error);
                } else if (loc.includes('Product') || loc.includes('äº§å“')) {
                    groups.productList.errors.push(error);
                } else {
                    groups.companyInfo.errors.push(error); // é»˜è®¤æ”¾åˆ°å…¬å¸ä¿¡æ¯
                }
            });
            
            // æ¸²æŸ“åˆ†ç»„
            let html = '';
            Object.keys(groups).forEach(key => {
                const group = groups[key];
                if (group.errors.length > 0) {
                    html += `
                        <div class="checker-group" id="error-group-${key}">
                            <div class="checker-group-header" onclick="toggleErrorGroup('error-group-${key}')">
                                <div class="checker-group-title">
                                    <span>${group.label}</span>
                                    <span class="checker-group-count">${group.errors.length}</span>
                                </div>
                                <span class="checker-group-toggle">â–¼</span>
                            </div>
                            <div class="checker-group-content">
                                <ul class="checker-list">
                                    ${group.errors.map(item => `
                                        <li class="checker-item">
                                            <div class="checker-icon error">!</div>
                                            <div class="checker-content">
                                                <div class="checker-message">${item.message}</div>
                                            </div>
                                            ${item.field ? `<button class="checker-fix-btn" onclick="goToField('${item.field}')">å®šä½</button>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        const checkerSectionLabels = {
            companyInfo: 'å…¬å¸ä¿¡æ¯',
            questionMatrix: 'æ ¹æ®ä¸Šè¿°ç”³æŠ¥èŒƒå›´ï¼Œå›ç­”ä»¥ä¸‹ 1 è‡³ 8 é¢˜',
            companyQuestions: 'ä»å…¬å¸å±‚é¢ï¼Œå›ç­”ä»¥ä¸‹é—®é¢˜',
            smelterList: 'å†¶ç‚¼å‚æ¸…å•',
            productList: 'äº§å“æ¸…å•',
            mineList: 'çŸ¿å‚æ¸…å•',
            mineralsScope: 'çŸ¿ç‰©èŒƒå›´'
        };

        function formatCheckerLocation(location) {
            if (!location) return '';
            if (location.includes('å…¬å¸ä¿¡æ¯')) return checkerSectionLabels.companyInfo;
            if (location.includes('é—®é¢˜çŸ©é˜µ')) return checkerSectionLabels.questionMatrix;
            if (location.includes('å…¬å¸å±‚é¢')) return checkerSectionLabels.companyQuestions;
            if (location.includes('Smelter') || location.includes('å†¶ç‚¼å‚')) return checkerSectionLabels.smelterList;
            if (location.includes('Mine') || location.includes('çŸ¿å‚')) return checkerSectionLabels.mineList;
            if (location.includes('Product') || location.includes('äº§å“')) return checkerSectionLabels.productList;
            if (location.includes('Scope') || location.includes('çŸ¿ç‰©èŒƒå›´') || location.includes('Minerals')) return checkerSectionLabels.mineralsScope;
            return location.replace('Declaration â†’ ', '');
        }

        function renderCheckerList(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <li class="checker-item">
                    <div class="checker-icon ${type}">${type === 'error' ? '!' : type === 'warning' ? '!' : 'âœ“'}</div>
                    <div class="checker-content">
                        <div class="checker-location">${formatCheckerLocation(item.location)}</div>
                        <div class="checker-message">${item.message}</div>
                    </div>
                    ${item.field ? `<button class="checker-fix-btn" onclick="goToField('${item.field}')">å®šä½</button>` : ''}
                </li>
            `).join('');
        }

        function goToField(fieldId) {
            const field = document.getElementById(fieldId);
            const page = field ? field.closest('.page-container') : document.getElementById('page-declaration');
            const pageId = page ? page.id.replace('page-', '') : 'declaration';
            goToPage(pageId);

            if (field) {
                // æ»šåŠ¨åˆ°ç›®æ ‡å­—æ®µ
                setTimeout(() => {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    // æ·»åŠ é«˜äº®åŠ¨ç”»
                    field.classList.add('highlight-target');
                    
                    // å°è¯•èšç„¦ï¼ˆå¦‚æœæ˜¯å¯èšç„¦å…ƒç´ ï¼‰
                    const focusable = field.querySelector('input, select, textarea') || field;
                    if (focusable.focus) focusable.focus();
                    
                    // 1.5ç§’åç§»é™¤é«˜äº®
                    setTimeout(() => {
                        field.classList.remove('highlight-target');
                    }, 1500);
                }, 100);
            }
        }

        function exportData() {
            // æ˜¾ç¤º loading çŠ¶æ€
            const exportBtn = document.querySelector('.btn-export');
            const originalText = exportBtn.textContent;
            exportBtn.classList.add('loading');
            exportBtn.textContent = 'æ­£åœ¨å¯¼å‡º';

            // æ¨¡æ‹Ÿå¼‚æ­¥å¯¼å‡ºï¼ˆå®é™…å¯èƒ½éœ€è¦å¤„ç†å¤§é‡æ•°æ®ï¼‰
            setTimeout(() => {
                const data = {
                    version: currentVersion,
                    company: {},
                    questionMatrix: appData.questionMatrix,
                    companyQuestions: appData.companyQuestions,
                    smelters: [],
                    products: []
                };

                document.querySelectorAll('#companyForm input, #companyForm select, #companyForm textarea').forEach(input => {
                    if (input.id) data.company[input.id] = input.value;
                });

                document.querySelectorAll('#smelterTableBody tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    const selects = row.querySelectorAll('select');
                    data.smelters.push({
                        metal: selects[0].value,
                        lookup: selects[1].value,
                        name: inputs[1].value,
                        country: selects[2].value,
                        cid: inputs[2].value,
                        sourceId: inputs[3].value,
                        street: inputs[4].value,
                        city: inputs[5].value,
                        state: inputs[6].value,
                        contact: inputs[7].value,
                        email: inputs[8].value,
                        nextSteps: inputs[9].value,
                        mineName: inputs[10].value,
                        mineCountry: inputs[11].value,
                        recycled: selects[3].value,
                        comment: inputs[12].value
                    });
                });

                document.querySelectorAll('#productTableBody tr').forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    data.products.push({
                        productId: inputs[0].value,
                        productName: inputs[1].value,
                        comment: inputs[2].value
                    });
                });

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cmrt-data.json';
                a.click();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                exportBtn.classList.remove('loading');
                exportBtn.textContent = originalText;
                
                // å¯¼å‡ºåæ ‡è®°ä¸ºå·²ä¿å­˜
                hasUnsavedChanges = false;
                
                showToast('æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶', 'success');
            }, 500);
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
