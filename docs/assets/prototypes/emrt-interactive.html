<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMRT 2.1 - å¯äº¤äº’åŸå‹</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1565c0;
            --primary-dark: #0d47a1;
            --primary-light: #e3f2fd;
            --success: #2e7d32;
            --success-light: #e8f5e9;
            --warning: #f57c00;
            --warning-light: #fff3e0;
            --error: #c62828;
            --error-light: #ffebee;
            --gray-50: #fafafa;
            --gray-100: #f5f5f5;
            --gray-200: #eeeeee;
            --gray-300: #e0e0e0;
            --gray-400: #bdbdbd;
            --gray-500: #9e9e9e;
            --gray-600: #757575;
            --gray-700: #616161;
            --gray-800: #424242;
            --gray-900: #212121;
            --font-main: 'IBM Plex Sans', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --yellow-fill: #ffff00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-main);
            background: var(--gray-100);
            color: var(--gray-900);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow-md);
            gap: 16px;
        }

        .top-nav-center {
            flex: 1;
            display: flex;
            justify-content: center;
            min-width: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 14px;
        }

        .logo-text { color: white; font-weight: 600; font-size: 18px; }
        .logo-version {
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .nav-tabs { display: flex; gap: 4px; }

        .nav-tab {
            padding: 8px 16px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        .nav-tab:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-tab.active { background: rgba(255,255,255,0.2); color: white; }

        .nav-right { display: flex; align-items: center; gap: 16px; }

        .lang-select {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            cursor: pointer;
        }

        .btn-export {
            background: white;
            color: var(--primary);
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }

        /* Page Container */
        .page-container {
            display: none;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Section Card */
        .section-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--gray-200);
        }

        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--gray-50);
        }

        .section-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title-icon {
            width: 24px;
            height: 24px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .section-badge {
            background: var(--primary-light);
            color: var(--primary);
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }

        .section-body { padding: 20px; }

        /* Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group.full-width { grid-column: 1 / -1; }

        .form-label {
            font-size: 13px;
            color: var(--gray-700);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .form-label .required { color: var(--error); }

        .form-input, .form-select, .form-textarea {
            height: 40px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 14px;
            font-family: var(--font-main);
            transition: all 0.2s;
            background: white;
            width: 100%;
        }

        .form-input.required-field, .form-select.required-field {
            background: var(--yellow-fill);
        }

        .form-textarea {
            height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .form-input.error, .form-select.error {
            border-color: var(--error);
            background: var(--error-light);
        }

        .form-input.valid {
            border-color: var(--success);
            background: var(--success-light);
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23757575' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
            cursor: pointer;
        }

        .form-hint { font-size: 11px; color: var(--gray-500); }
        .form-error { font-size: 11px; color: var(--error); display: none; }
        .form-group.has-error .form-error { display: block; }

        /* Mineral Selector */
        .mineral-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .mineral-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            background: white;
            cursor: pointer;
            font-size: 13px;
        }

        .mineral-option input { cursor: pointer; }

        .mineral-selected-list {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .mineral-chip {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            background: var(--primary-light);
            color: var(--primary);
        }

        /* Question Matrix */
        .question-block {
            border: 1px solid var(--gray-300);
            margin-bottom: 16px;
            border-radius: var(--radius-md);
            overflow: hidden;
        }

        .question-header {
            background: var(--primary-dark);
            color: white;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 500;
        }

        .question-header .q-num {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 10px;
            font-weight: 600;
        }

        .question-table {
            width: 100%;
            border-collapse: collapse;
        }

        .question-table th {
            background: var(--gray-100);
            padding: 8px 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-300);
        }

        .question-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .question-table tr:last-child td { border-bottom: none; }
        .question-table tr:hover { background: var(--gray-50); }

        .metal-label {
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metal-label .required { color: var(--error); font-size: 14px; }

        .metal-co { color: #1565c0; }
        .metal-cu { color: #ef6c00; }
        .metal-gr { color: #455a64; }
        .metal-li { color: #5e35b1; }
        .metal-mi { color: #2e7d32; }
        .metal-ni { color: #6d4c41; }

        .answer-select {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 10px;
            font-size: 13px;
            background: var(--yellow-fill);
            cursor: pointer;
        }

        .answer-select:focus { outline: none; border-color: var(--primary); }
        .answer-select.answered { background: white; }
        .answer-select.disabled { background: var(--gray-100); color: var(--gray-500); }

        .comment-input {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 10px;
            font-size: 13px;
        }

        .comment-input:focus { outline: none; border-color: var(--primary); }
        .comment-input.disabled { background: var(--gray-100); color: var(--gray-500); }

        /* Company Questions */
        .company-question {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
            gap: 16px;
        }

        .company-question:last-child { border-bottom: none; }

        .cq-letter {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .cq-content { flex: 1; }
        .cq-text { font-size: 14px; color: var(--gray-800); margin-bottom: 10px; }

        .cq-options { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }

        .cq-select {
            height: 36px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 13px;
            background: white;
            min-width: 240px;
        }

        #companyQuestionsBody.cq-required .cq-select {
            background: var(--yellow-fill);
        }

        .cq-select.answered { background: white; }
        .cq-select.disabled { background: var(--gray-100); color: var(--gray-500); }

        .cq-mineral-list { display: flex; flex-direction: column; gap: 8px; }
        .cq-mineral-row { display: flex; align-items: center; gap: 12px; }
        .cq-mineral-label { min-width: 120px; font-weight: 600; color: var(--gray-700); }
        .cq-row-disabled { opacity: 0.5; }
        .cq-row-optional .cq-select { background: white !important; }

        .cq-comment {
            margin-top: 10px;
            display: none;
        }

        .cq-comment.show { display: block; }

        .cq-comment input {
            width: 100%;
            height: 36px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 12px;
            font-size: 13px;
        }

        .cq-comment input:focus { outline: none; border-color: var(--primary); }
        .cq-comment.show input { background: var(--yellow-fill); }

        .cq-disabled { opacity: 0.5; pointer-events: none; }

        /* Data Table */
        .table-container { overflow-x: auto; }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 900px;
        }

        .data-table th {
            background: var(--gray-100);
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 2px solid var(--gray-300);
            white-space: nowrap;
        }

        .data-table td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--gray-200);
            vertical-align: middle;
        }

        .data-table tr:hover { background: var(--gray-50); }

        .data-table input, .data-table select {
            width: 100%;
            height: 34px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            padding: 0 8px;
            font-size: 12px;
            font-family: var(--font-main);
        }

        .data-table input:focus, .data-table select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .metal-select { min-width: 120px; }

        .delete-row-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--error-light);
            color: var(--error);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .delete-row-btn:hover { background: var(--error); color: white; }

        .add-row-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-md);
            background: transparent;
            color: var(--gray-500);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }

        .add-row-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        .btn-primary,
        .btn-secondary {
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            border: 1px solid var(--primary);
        }

        .btn-primary:hover { filter: brightness(0.95); }

        .btn-secondary {
            background: white;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover { background: var(--gray-50); }

        .btn-primary:disabled,
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 24px 0 40px;
        }

        .page-actions .btn-primary,
        .page-actions .btn-secondary {
            min-width: 120px;
        }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-conformant { background: var(--success-light); color: var(--success); }
        .status-active { background: #e3f2fd; color: #1565c0; }
        .status-notlisted { background: var(--warning-light); color: var(--warning); }
        .status-unknown { background: var(--gray-200); color: var(--gray-600); }


        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, #42a5f5 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .checker-list { list-style: none; }

        .checker-item {
            display: flex;
            align-items: flex-start;
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-200);
            gap: 12px;
            transition: background 0.2s;
        }

        .checker-item:hover { background: var(--gray-50); }
        .checker-item:last-child { border-bottom: none; }

        .checker-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .checker-icon.error { background: var(--error-light); color: var(--error); }
        .checker-icon.warning { background: var(--warning-light); color: var(--warning); }
        .checker-icon.success { background: var(--success-light); color: var(--success); }

        .checker-content { flex: 1; }
        .checker-message { font-size: 13px; color: var(--gray-800); }
        .checker-location { font-size: 11px; color: var(--gray-500); margin-top: 4px; }

        .checker-fix-btn {
            padding: 4px 10px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checker-fix-btn:hover { background: var(--primary); color: white; }

        /* === UX ä¼˜åŒ–æ–°å¢æ ·å¼ === */

        /* è¿›åº¦æŒ‡ç¤ºå™¨ */
        .progress-indicator {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .top-nav .progress-indicator {
            background: transparent;
            border-bottom: none;
            padding: 0;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-500);
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .top-nav .progress-step {
            color: rgba(255, 255, 255, 0.75);
            font-size: 12px;
        }

        .progress-step.active {
            color: var(--primary);
            font-weight: 600;
        }

        .progress-step.completed {
            color: var(--success);
        }

        .top-nav .progress-step.active {
            color: #fff;
        }

        .top-nav .progress-step.completed {
            color: #c8f7d4;
        }

        .progress-step-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            background: var(--gray-200);
            color: var(--gray-600);
        }

        .top-nav .progress-step-num {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        .progress-step.active .progress-step-num {
            background: var(--primary);
            color: white;
        }

        .progress-step.completed .progress-step-num {
            background: var(--success);
            color: white;
        }

        .top-nav .progress-step.active .progress-step-num {
            background: #fff;
            color: var(--primary);
        }

        .top-nav .progress-step.completed .progress-step-num {
            background: #b7f5c3;
            color: #1b5e20;
        }

        .progress-arrow {
            color: var(--gray-300);
            font-size: 16px;
        }

        .top-nav .progress-arrow {
            color: rgba(255, 255, 255, 0.4);
        }

        /* å…¨å±€é”™è¯¯æç¤ºæ¡ */
        .global-error-bar {
            position: sticky;
            top: var(--top-nav-height, 56px);
            z-index: 99;
            padding: 10px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .global-error-bar.has-errors {
            background: var(--error-light);
            color: var(--error);
            border-bottom: 1px solid rgba(198, 40, 40, 0.2);
        }

        .global-error-bar.all-passed {
            background: var(--success-light);
            color: var(--success);
            border-bottom: 1px solid rgba(46, 125, 50, 0.2);
        }

        .global-error-bar:hover {
            filter: brightness(0.95);
        }

        /* å¿…å¡«é¡¹è¯´æ˜æç¤º */
        .required-hint {
            background: linear-gradient(90deg, var(--yellow-fill) 0%, #fff9c4 100%);
            padding: 10px 16px;
            border-radius: var(--radius-md);
            font-size: 13px;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
            border: 1px solid #e6d800;
        }

        .required-hint-icon {
            font-size: 16px;
        }

        /* ç¦ç”¨çŠ¶æ€é®ç½© */
        .disabled-overlay {
            position: relative;
        }

        .disabled-overlay::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            pointer-events: none;
            z-index: 5;
            border-radius: var(--radius-md);
        }

        .disabled-overlay-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 6;
            background: white;
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            font-size: 13px;
            color: var(--gray-600);
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
        }

        /* å®šä½é«˜äº®åŠ¨ç”» */
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 0 0 rgba(21, 101, 192, 0.6); }
            50% { box-shadow: 0 0 0 10px rgba(21, 101, 192, 0); }
            100% { box-shadow: 0 0 0 0 rgba(21, 101, 192, 0); }
        }

        .highlight-target {
            animation: highlight-pulse 0.5s ease-out 3;
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* Smelter List å›ºå®šåˆ— */
        .sticky-col-1 {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
        }

        .sticky-col-2 {
            position: sticky;
            left: 120px;
            background: white;
            z-index: 2;
        }

        .sticky-col-3 {
            position: sticky;
            left: 240px;
            background: white;
            z-index: 2;
            border-right: 2px solid var(--gray-300);
        }

        .data-table thead th.sticky-col-1,
        .data-table thead th.sticky-col-2,
        .data-table thead th.sticky-col-3 {
            background: var(--gray-100);
        }

        .data-table tbody tr:hover .sticky-col-1,
        .data-table tbody tr:hover .sticky-col-2,
        .data-table tbody tr:hover .sticky-col-3 {
            background: var(--gray-50);
        }

        /* Checker åˆ†ç»„æ ·å¼ */
        .checker-group {
            border-bottom: 1px solid var(--gray-200);
        }

        .checker-group:last-child {
            border-bottom: none;
        }

        .checker-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--gray-50);
            cursor: pointer;
            transition: background 0.2s;
        }

        .checker-group-header:hover {
            background: var(--gray-100);
        }

        .checker-group-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .checker-group-count {
            background: var(--error-light);
            color: var(--error);
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .checker-group-toggle {
            font-size: 12px;
            color: var(--gray-500);
            transition: transform 0.2s;
        }

        .checker-group.collapsed .checker-group-toggle {
            transform: rotate(-90deg);
        }

        .checker-group-content {
            max-height: none;
            overflow: visible;
            transition: none;
        }

        .checker-group.collapsed .checker-group-content {
            max-height: 0;
            overflow: hidden;
        }

        /* é€šè¿‡é¡¹æŠ˜å  */
        .passed-summary {
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }

        .passed-summary:hover {
            background: var(--gray-50);
        }

        .passed-summary-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--success);
            font-weight: 500;
        }

        .passed-summary-toggle {
            font-size: 12px;
            color: var(--gray-500);
            padding: 4px 12px;
            background: var(--gray-100);
            border-radius: var(--radius-sm);
        }

        .passed-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .passed-details.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Loading çŠ¶æ€ */
        .btn-export.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-export.loading::after {
            content: '...';
            animation: loading-dots 1s infinite;
        }

        @keyframes loading-dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Page Title */
        .page-title { margin-bottom: 20px; }
        .page-title h1 { font-size: 24px; font-weight: 700; color: var(--gray-900); margin-bottom: 4px; }
        .page-title p { font-size: 14px; color: var(--gray-600); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 20px;
            background: var(--gray-900);
            color: white;
            border-radius: var(--radius-md);
            font-size: 14px;
            box-shadow: var(--shadow-lg);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--error); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show { display: flex; }

        .modal-card {
            width: 520px;
            max-width: 92%;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-title { font-size: 16px; font-weight: 600; color: var(--gray-900); }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 20px;
            color: var(--gray-500);
            cursor: pointer;
        }

        .modal-body { padding: 16px 20px; }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--gray-200);
        }

        .submit-summary {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--gray-700);
            margin-bottom: 12px;
        }

        .submit-errors {
            border: 1px solid var(--gray-200);
            background: var(--gray-50);
            border-radius: var(--radius-md);
            padding: 12px;
        }

        .submit-errors-title {
            font-size: 12px;
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .submit-errors ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .submit-error-item {
            display: flex;
            gap: 8px;
            font-size: 13px;
            color: var(--gray-800);
            padding: 4px 0;
        }

        .submit-all-pass {
            padding: 12px;
            border-radius: var(--radius-md);
            background: var(--success-light);
            color: var(--success);
            font-weight: 600;
        }

        /* Version toggles */
        body.emrt-no-mine #page-mine,
        body.emrt-no-mine .progress-step[data-step="mine"],
        body.emrt-no-mine .progress-arrow[data-after="mine"] { display: none; }
        body.emrt-no-combined .col-combined { display: none; }
        body.emrt-mine-smelter-input .mine-smelter-select { display: none; }
        body.emrt-mine-smelter-select .mine-smelter-input { display: none; }

        /* Responsive */
        @media (max-width: 1024px) {
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">
            <div class="logo-icon">EM</div>
            <span class="logo-text">EMRT</span>
            <span class="logo-version">v2.1</span>
        </div>

        <div class="top-nav-center">
            <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div class="progress-indicator" id="progressIndicator">
            <div class="progress-step active" data-step="declaration">
                <span class="progress-step-num">1</span>
                <span>Declaration</span>
            </div>
            <span class="progress-arrow" data-after="declaration">â†’</span>
            <div class="progress-step" data-step="smelter">
                <span class="progress-step-num">2</span>
                <span>Smelter List</span>
            </div>
            <span class="progress-arrow" data-after="smelter">â†’</span>
            <div class="progress-step" data-step="mine">
                <span class="progress-step-num">3</span>
                <span>Mine List</span>
            </div>
            <span class="progress-arrow" data-after="mine">â†’</span>
            <div class="progress-step" data-step="product">
                <span class="progress-step-num">4</span>
                <span>Product List</span>
            </div>
            <span class="progress-arrow" data-after="product">â†’</span>
            <div class="progress-step" data-step="checker">
                <span class="progress-step-num">5</span>
                <span>Review</span>
            </div>
            </div>
        </div>

        <div class="nav-right">
            <select class="lang-select" id="langSelect">
                <option value="en">English</option>
                <option value="zh">ä¸­æ–‡</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
                <option value="fr">FranÃ§ais</option>
                <option value="de">Deutsch</option>
            </select>
            <select class="lang-select" id="versionSelect"></select>
            <button class="btn-export" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        </div>
    </nav>

    <!-- å…¨å±€é”™è¯¯æç¤ºæ¡ -->
    <div class="global-error-bar has-errors" id="globalErrorBar" onclick="goToChecker()">
        <span id="globalErrorIcon">âš ï¸</span>
        <span id="globalErrorText">è¿˜æœ‰ 0 ä¸ªå¿…å¡«é¡¹æœªå®Œæˆ</span>
        <span style="font-size: 12px; opacity: 0.7;">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</span>
    </div>

    <!-- Declaration Page -->
    <div class="page-container active" id="page-declaration">
        <div class="page-title">
            <h1>Declaration ç”³æŠ¥é¡µ</h1>
            <p>æœ¬æ–‡ä»¶æ—¨åœ¨æ”¶é›†äº§å“ä¸­ä½¿ç”¨çš„ç‰¹å®šåŸææ–™ï¼ˆç‰¹åˆ«æ˜¯é’´æˆ–å¤©ç„¶äº‘æ¯ï¼‰çš„é‡‡è´­ä¿¡æ¯ã€‚</p>
        </div>

        <!-- å¿…å¡«é¡¹è¯´æ˜æç¤º -->
        <div class="required-hint">
            <span class="required-hint-icon">ğŸ’¡</span>
            <span><strong>å¡«å†™æç¤ºï¼š</strong>é»„è‰²åº•è‰²å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œè¯·ç¡®ä¿å…¨éƒ¨å¡«å†™å®Œæ•´åå†æäº¤ã€‚</span>
        </div>

        <!-- Company Information -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ¢</span>
                    å…¬å¸ä¿¡æ¯
                </div>
                <span class="section-badge" id="companyFieldsCount">0/8 å¿…å¡«å·²å®Œæˆ</span>
            </div>
            <div class="section-body">
                <div class="form-grid" id="companyForm">
                    <div class="form-group" data-field="companyName" data-required="true">
                        <label class="form-label">å…¬å¸åç§°ï¼ˆ*ï¼‰ï¼š</label>
                        <input type="text" class="form-input required-field" id="companyName" placeholder="è¯·è¾“å…¥å…¬å¸æ­£å¼æ³¨å†Œåç§°">
                        <span class="form-hint">ä½¿ç”¨æ­£å¼æ³¨å†Œåç§°ï¼Œä¸å¾—ä½¿ç”¨ç¼©å†™</span>
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="declarationScope" data-required="true">
                        <label class="form-label">ç”³æŠ¥èŒƒå›´æˆ–ç§ç±» (*):</label>
                        <select class="form-select required-field" id="declarationScope">
                            <option value="">-- è¯·é€‰æ‹© --</option>
                            <option value="A">A. Company</option>
                            <option value="B">B. Product (or List of Products)</option>
                            <option value="C">C. User defined</option>
                        </select>
                        <span class="form-hint">A=å…¬å¸çº§ | B=äº§å“çº§(éœ€å¡«Product List) | C=è‡ªå®šä¹‰</span>
                        <span class="form-error">è¯·é€‰æ‹©ç”³æŠ¥èŒƒå›´</span>
                    </div>
                    <div class="form-group" id="scopeDescGroup" style="display: none;" data-field="scopeDescription">
                        <label class="form-label">èŒƒå›´æè¿°ï¼š</label>
                        <textarea class="form-textarea required-field" id="scopeDescription" placeholder="è¯·æè¿°è‡ªå®šä¹‰ç”³æŠ¥èŒƒå›´"></textarea>
                        <span class="form-error">é€‰æ‹©è‡ªå®šä¹‰èŒƒå›´æ—¶å¿…é¡»å¡«å†™æè¿°</span>
                    </div>
                    <div class="form-group" data-field="uniqueId">
                        <label class="form-label">å…¬å¸å”¯ä¸€è¯†åˆ«ä¿¡æ¯ï¼š</label>
                        <input type="text" class="form-input" id="uniqueId" placeholder="DUNS, VAT, ç»„ç»‡æœºæ„ä»£ç ç­‰">
                    </div>
                    <div class="form-group" data-field="authId">
                        <label class="form-label">å…¬å¸å”¯ä¸€æˆæƒè¯†åˆ«ä¿¡æ¯ï¼š</label>
                        <input type="text" class="form-input" id="authId" placeholder="æˆæƒè¯†åˆ«ä¿¡æ¯">
                    </div>
                    <div class="form-group" data-field="address">
                        <label class="form-label">åœ°å€ï¼š</label>
                        <input type="text" class="form-input" id="address" placeholder="å…¬å¸åœ°å€">
                    </div>
                    <div class="form-group" data-field="contactName" data-required="true">
                        <label class="form-label">è”ç³»äººå§“å (*):</label>
                        <input type="text" class="form-input required-field" id="contactName" placeholder="è¯·è¾“å…¥è”ç³»äººå§“å">
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="contactEmail" data-required="true">
                        <label class="form-label">è”ç³»äººç”µé‚®åœ°å€ (*):</label>
                        <input type="email" class="form-input required-field" id="contactEmail" placeholder="example@company.com">
                        <span class="form-hint">æ— é‚®ç®±å¯å¡« "not available"</span>
                        <span class="form-error">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</span>
                    </div>
                    <div class="form-group" data-field="contactPhone" data-required="true">
                        <label class="form-label">è”ç³»äººç”µè¯ (*):</label>
                        <input type="tel" class="form-input required-field" id="contactPhone" placeholder="+86 xxx xxxx xxxx">
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹</span>
                    </div>
                    <div class="form-group" data-field="authorizerName" data-required="true">
                        <label class="form-label">æˆæƒäººå§“å (*):</label>
                        <input type="text" class="form-input required-field" id="authorizerName" placeholder="è¯·è¾“å…¥æˆæƒäººå§“å">
                        <span class="form-hint">ä¸å¯å¡« "same" ç­‰å ä½</span>
                        <span class="form-error">æ­¤å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œä¸”ä¸èƒ½ä¸º "same"</span>
                    </div>
                    <div class="form-group" data-field="authorizerTitle">
                        <label class="form-label">æˆæƒäººèŒåŠ¡:</label>
                        <input type="text" class="form-input" id="authorizerTitle" placeholder="èŒåŠ¡åç§°">
                    </div>
                    <div class="form-group" data-field="authorizerEmail" data-required="true">
                        <label class="form-label">æˆæƒäººç”µé‚®åœ°å€ (*):</label>
                        <input type="email" class="form-input required-field" id="authorizerEmail" placeholder="example@company.com">
                        <span class="form-error">è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€</span>
                    </div>
                    <div class="form-group" data-field="authorizerPhone">
                        <label class="form-label">æˆæƒäººç”µè¯ :</label>
                        <input type="tel" class="form-input" id="authorizerPhone" placeholder="+86 xxx xxxx xxxx">
                    </div>
                    <div class="form-group" data-field="authDate" data-required="true">
                        <label class="form-label">æˆæƒæ—¥æœŸ (*):</label>
                        <input type="date" class="form-input required-field" id="authDate">
                        <span class="form-hint">æ ¼å¼: DD-MMM-YYYY (å¦‚ 01-Jan-2026)ï¼ŒèŒƒå›´ 31-Dec-2006 ~ 31-Mar-2026</span>
                        <span class="form-error">è¯·é€‰æ‹©æœ‰æ•ˆæ—¥æœŸ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mineral Scope -->
        <div class="section-card" id="mineralScopeCard">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">â›ï¸</span>
                    é€‰æ‹©è´µå…¬å¸çš„çŸ¿äº§ç”³æŠ¥èŒƒå›´ (*)
                </div>
                <span class="section-badge" id="mineralScopeCount">0/6 å·²é€‰</span>
            </div>
            <div class="section-body">
                <div class="mineral-selector" id="mineralSelector"></div>
                <div class="mineral-selected-list" id="selectedMineralList"></div>
                <div class="form-hint" id="mineralScopeHint">æ³¨ï¼šé—®é¢˜ 1 è‡³ 7 å’Œ C ä¼šè‡ªåŠ¨å¡«å……ç²¾é€‰çš„çŸ¿äº§ï¼Œå°†æŒ‰å­—æ¯é¡ºåºåˆ—å‡ºã€‚æ£€æŸ¥ä½ çš„å›å¤æ˜¯å¦ä¸ç›¸åº”çš„çŸ¿ç‰©ç›¸ç¬¦ã€‚</div>
            </div>
        </div>

        <!-- Question Matrix -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">â“</span>
                    æ ¹æ®ä¸Šè¿°æŒ‡æ˜çš„ç”³æŠ¥èŒƒå›´å›ç­”ä¸‹åˆ—é—®é¢˜ 1 - 7
                </div>
                <span class="section-badge">Q1-Q7</span>
            </div>
            <div class="section-body" style="padding: 16px;" id="questionMatrixContainer"></div>
        </div>

        <!-- Company Level Questions -->
        <div class="section-card" id="companyQuestionsCard">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“‹</span>
                    ä»å…¬å¸å±‚é¢æ¥å›ç­”ä»¥ä¸‹é—®é¢˜
                </div>
                <span class="section-badge" id="cqStatus">ä»…å½“ Q1â‰ å¦å®šå€¼ä¸” Q2â‰ No/Unknown æ—¶å¿…å¡«</span>
            </div>
            <div class="section-body" style="padding: 0;" id="companyQuestionsBody"></div>
        </div>

        <div class="page-actions" data-page="declaration">
            <button class="btn-secondary" data-action="prev" disabled>ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Smelter List Page -->
    <div class="page-container" id="page-smelter">
        <div class="page-title">
            <h1>Smelter List å†¶ç‚¼å‚æ¸…å•</h1>
            <p>åˆ—å‡ºä¾›åº”é“¾ä¸­æ¶‰åŠçš„å†¶ç‚¼å‚/ç²¾ç‚¼å‚ä¿¡æ¯ï¼ˆæŒ‰çŸ¿äº§ï¼‰</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ­</span>
                    å†¶ç‚¼å‚æ¸…å•
                </div>
                <span class="section-badge" id="smelterCount">0 æ¡è®°å½•</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-container" style="max-height: 600px; overflow: auto;">
                    <table class="data-table" id="smelterTable" style="min-width: 2800px;">
                        <thead>
                            <tr>
                                <th class="sticky-col-1" style="width: 120px; position: sticky; top: 0; left: 0; background: var(--gray-100); z-index: 12;">å†¶ç‚¼å‚è¯†åˆ«å·ç <br/>è¾“å…¥åˆ—</th>
                                <th class="sticky-col-2" style="width: 120px; position: sticky; top: 0; left: 120px; background: var(--gray-100); z-index: 12;">é‡‘å± <span style="color:var(--error);">*</span></th>
                                <th class="sticky-col-3" style="width: 200px; position: sticky; top: 0; left: 240px; background: var(--gray-100); z-index: 12; border-right: 2px solid var(--gray-300);">å†¶ç‚¼å‚æŸ¥æ‰¾ <span style="color:var(--error);">*</span></th>
                                <th style="width: 200px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚åç§°</th>
                                <th style="width: 140px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å›½å®¶/åœ°åŒº <span style="color:var(--error);">*</span></th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è¯†åˆ«</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å‡ºå¤„è¯†åˆ«å·</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">è¡—é“</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">åŸå¸‚</th>
                                <th style="width: 100px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å·/çœ</th>
                                <th style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è”ç³»äºº</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å†¶ç‚¼å‚è”ç³»äºº<br/>ç”µå­é‚®ä»¶</th>
                                <th style="width: 180px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">å»ºè®®çš„åç»­æ­¥éª¤</th>
                                <th style="width: 200px; position: sticky; top: 0; background: var(--gray-100); z-index: 10; font-size: 10px; line-height: 1.3;">å¡«å†™çŸ¿äº•åç§°/å›æ”¶/æŠ¥åºŸ</th>
                                <th style="width: 200px; position: sticky; top: 0; background: var(--gray-100); z-index: 10; font-size: 10px; line-height: 1.3;">å¡«å†™çŸ¿äº•å›½å®¶/å›æ”¶/æŠ¥åºŸ</th>
                                <th style="width: 160px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">100%å›æ”¶æ–™ï¼Ÿ</th>
                                <th style="width: 150px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">æ³¨é‡Š</th>
                                <th class="col-combined" style="width: 120px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">Combined Metal</th>
                                <th class="col-combined" style="width: 160px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;">Combined Smelter</th>
                                <th style="width: 50px; position: sticky; top: 0; background: var(--gray-100); z-index: 10;"></th>
                            </tr>
                        </thead>
                        <tbody id="smelterTableBody"></tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addSmelterRow()">+ æ·»åŠ å†¶ç‚¼å‚</button>
            </div>
        </div>

        <div class="section-card" id="smelterWarningCard" style="display: none;">
            <div class="section-header" style="background: var(--warning-light);">
                <div class="section-title" style="color: var(--warning);">âš ï¸ è­¦å‘Šæç¤º</div>
            </div>
            <div class="section-body">
                <p id="smelterWarningText" style="color: var(--warning); font-size: 14px;"></p>
            </div>
        </div>

        <div class="page-actions" data-page="smelter">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Mine List Page -->
    <div class="page-container" id="page-mine">
        <div class="page-title">
            <h1>Mine List çŸ¿å‚æ¸…å•</h1>
            <p>2.0+ æ–°å¢ï¼šè®°å½•çŸ¿å‚ä¿¡æ¯å¹¶ä¸ Smelter List è”åŠ¨</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">â›ï¸</span>
                    çŸ¿å‚æ¸…å•
                </div>
                <span class="section-badge" id="mineCount">0 æ¡è®°å½•</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table" id="mineTable" style="min-width: 2000px;">
                        <thead>
                            <tr>
                                <th style="width: 140px;">é‡‘å±</th>
                                <th style="width: 220px;">ä»è¯¥çŸ¿å‚é‡‡è´­çš„å†¶ç‚¼å‚åç§°</th>
                                <th style="width: 200px;">çŸ¿å‚åç§°</th>
                                <th style="width: 140px;">çŸ¿å‚è¯†åˆ«</th>
                                <th style="width: 140px;">å†¶ç‚¼å‚å‡ºå¤„è¯†åˆ«å·</th>
                                <th style="width: 160px;">å›½å®¶/åœ°åŒº</th>
                                <th style="width: 160px;">è¡—é“</th>
                                <th style="width: 120px;">åŸå¸‚</th>
                                <th style="width: 100px;">å·/çœ</th>
                                <th style="width: 140px;">è”ç³»äºº</th>
                                <th style="width: 160px;">è”ç³»äººé‚®ç®±</th>
                                <th style="width: 160px;">åç»­æ­¥éª¤</th>
                                <th style="width: 140px;">æ³¨é‡Š</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="mineTableBody"></tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addMineRow()">+ æ·»åŠ çŸ¿å‚</button>
            </div>
        </div>

        <div class="page-actions" data-page="mine">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Product List Page -->
    <div class="page-container" id="page-product">
        <div class="page-title">
            <h1>Product List äº§å“æ¸…å•</h1>
            <p>å½“ç”³æŠ¥èŒƒå›´é€‰æ‹© "B. Product" æ—¶å¿…å¡«</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“¦</span>
                    äº§å“æ¸…å•
                </div>
                <span class="section-badge" id="productCount">0 æ¡è®°å½•</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="table-container">
                    <table class="data-table" id="productTable">
                        <thead>
                            <tr>
                                <th style="width: 200px;">å›å¤æ–¹çš„äº§å“ç¼–å· *</th>
                                <th>å›å¤æ–¹çš„äº§å“åç§°</th>
                                <th>è¯·æ±‚æ–¹çš„äº§å“ç¼–å·</th>
                                <th>è¯·æ±‚æ–¹çš„äº§å“åç§°</th>
                                <th>å¤‡æ³¨</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody"></tbody>
                    </table>
                </div>
                <button class="add-row-btn" onclick="addProductRow()">+ æ·»åŠ äº§å“</button>
            </div>
        </div>

        <div class="page-actions" data-page="product">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" data-action="next">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <!-- Checker Page -->
    <div class="page-container" id="page-checker">
        <div class="page-title">
            <h1>Checker æ ¡éªŒç»“æœ</h1>
            <p>ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å¡«å†™å®Œæ•´æ€§å’Œåˆè§„æ€§</p>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon">ğŸ“Š</span>
                    å¡«å†™è¿›åº¦
                </div>
            </div>
            <div class="section-body">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="font-size: 13px; color: var(--gray-700);">æ€»ä½“å®Œæˆåº¦</span>
                    <span style="font-size: 13px; font-weight: 600; color: var(--primary);" id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="section-card" id="errorsCard" style="display: none;">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon" style="background: var(--error-light); color: var(--error);">âŒ</span>
                    é”™è¯¯ Errors (å¿…é¡»ä¿®æ­£)
                </div>
                <span class="section-badge" style="background: var(--error-light); color: var(--error);" id="errorBadge">0 é¡¹</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div id="groupedErrorsList"></div>
            </div>
        </div>

        <div class="section-card">
            <div class="section-header">
                <div class="section-title">
                    <span class="section-title-icon" style="background: var(--success-light); color: var(--success);">âœ…</span>
                    é€šè¿‡ Passed
                </div>
                <span class="section-badge" style="background: var(--success-light); color: var(--success);" id="passedBadge">0 é¡¹</span>
            </div>
            <div class="section-body" style="padding: 0;">
                <div class="passed-summary" id="passedSummary" onclick="togglePassedDetails()">
                    <span class="passed-summary-text">
                        <span>âœ…</span>
                        <span id="passedSummaryText">å·²é€šè¿‡ 0 é¡¹æ£€æŸ¥</span>
                    </span>
                    <span class="passed-summary-toggle" id="passedToggleBtn">å±•å¼€æŸ¥çœ‹</span>
                </div>
                <div class="passed-details" id="passedDetails">
                    <ul class="checker-list" id="passedList"></ul>
                </div>
            </div>
        </div>

        <div class="page-actions" data-page="checker">
            <button class="btn-secondary" data-action="prev">ä¸Šä¸€é¡µ</button>
            <button class="btn-primary" id="submitReviewBtn" onclick="openSubmitModal()">æäº¤</button>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal-overlay" id="submitModal" onclick="handleModalBackdrop(event)">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">æäº¤å‰æ£€æŸ¥</div>
                <button class="modal-close" onclick="closeSubmitModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="submit-summary">
                    <div>å®Œæˆåº¦ï¼š<span id="submitCompletion">0%</span></div>
                    <div>é”™è¯¯ï¼š<span id="submitErrorCount">0</span></div>
                </div>
                <div class="submit-all-pass" id="submitAllPass" style="display: none;">å…¨éƒ¨é€šè¿‡</div>
                <div class="submit-errors" id="submitErrorsSection">
                    <div class="submit-errors-title">å¾…ä¿®å¤ï¼ˆå‰ 5 æ¡ï¼‰</div>
                    <ul id="submitErrorsList"></ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" onclick="closeSubmitModal()">ç»§ç»­å¡«å†™</button>
                <button class="btn-primary" id="submitFixBtn" onclick="handleSubmitFix()">å»ä¿®å¤</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        const appData = {
            minerals: [],
            questionMatrix: {},
            companyQuestions: {},
            smelters: [],
            mines: [],
            products: []
        };

        const mineralOptionsV2 = [
            { id: 'Cobalt', name: 'Cobalt é’´', class: 'metal-co' },
            { id: 'Copper', name: 'Copper é“œ', class: 'metal-cu' },
            { id: 'Graphite', name: 'Graphite çŸ³å¢¨', class: 'metal-gr' },
            { id: 'Lithium', name: 'Lithium é”‚', class: 'metal-li' },
            { id: 'Mica', name: 'Mica äº‘æ¯', class: 'metal-mi' },
            { id: 'Nickel', name: 'Nickel é•', class: 'metal-ni' }
        ];

        const mineralOptionsV1 = [
            { id: 'Cobalt', name: 'Cobalt é’´', class: 'metal-co' },
            { id: 'Mica', name: 'Mica äº‘æ¯', class: 'metal-mi' }
        ];

        const versionConfigs = {
            '2.1': { label: '2.1', minerals: mineralOptionsV2, hasMine: true, hasCombined: true, mineSmelterLookup: true },
            '2.0': { label: '2.0', minerals: mineralOptionsV2, hasMine: true, hasCombined: false, mineSmelterLookup: false },
            '1.3': { label: '1.3', minerals: mineralOptionsV1, hasMine: false, hasCombined: false, mineSmelterLookup: false },
            '1.2': { label: '1.2', minerals: mineralOptionsV1, hasMine: false, hasCombined: false, mineSmelterLookup: false },
            '1.11': { label: '1.11', minerals: mineralOptionsV1, hasMine: false, hasCombined: false, mineSmelterLookup: false },
            '1.1': { label: '1.1', minerals: mineralOptionsV1, hasMine: false, hasCombined: false, mineSmelterLookup: false }
        };

        const defaultVersion = '2.1';
        let currentVersion = getVersionFromUrl() || defaultVersion;
        let mineralOptions = versionConfigs[currentVersion].minerals;
        let hasUnsavedChanges = false;
        let currentPageId = 'declaration';
        let lastCheckerSummary = { errors: [], passed: [], completion: 0 };

        const questionTextV2 = {
            Q1: 'æ˜¯å¦åœ¨äº§å“æˆ–ç”Ÿäº§æµç¨‹ä¸­æœ‰æ„æ·»åŠ æˆ–ä½¿ç”¨ä»»ä½•æŒ‡å®šçŸ¿äº§ï¼Ÿ',
            Q2: 'äº§å“ä¸­æ˜¯å¦è¿˜å­˜æœ‰ä»»ä½•æŒ‡å®šçŸ¿äº§ï¼Ÿ',
            Q3: 'è´µå…¬å¸ä¾›åº”é“¾ä¸­æ˜¯å¦æœ‰å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ä»å—å†²çªå½±å“å’Œé«˜é£é™©åœ°åŒºé‡‡è´­æŒ‡å®šçŸ¿äº§ï¼Ÿï¼ˆã€Šç»åˆç»„ç»‡å°½èŒè°ƒæŸ¥æŒ‡å—ã€‹ï¼Œå‚è§å®šä¹‰é€‰é¡¹å¡ï¼‰',
            Q4: 'æ˜¯å¦ 100% çš„æŒ‡å®šçŸ¿äº§æ¥è‡ªå›æ”¶æ–™æˆ–æŠ¥åºŸæ–™èµ„æºï¼Ÿ',
            Q5: 'ç™¾åˆ†ä¹‹å¤šå°‘çš„ç›¸å…³ä¾›åº”å•†å·²å¯¹è´µå…¬å¸çš„ä¾›åº”é“¾è°ƒæŸ¥æä¾›ç­”å¤ï¼Ÿ',
            Q6: 'æ‚¨æ˜¯å¦è¯†åˆ«å‡ºä¸ºè´µå…¬å¸çš„ä¾›åº”é“¾ä¾›åº”æŒ‡å®šçŸ¿äº§çš„æ‰€æœ‰å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ï¼Ÿ',
            Q7: 'è´µå…¬å¸æ”¶åˆ°çš„æ‰€æœ‰é€‚ç”¨å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ä¿¡æ¯æ˜¯å¦å·²åœ¨æ­¤ç”³æŠ¥ä¸­æŠ¥å‘Šï¼Ÿ'
        };

        const questionTextV1 = {
            Q1: 'æ˜¯å¦åœ¨äº§å“æˆ–ç”Ÿäº§æµç¨‹ä¸­æœ‰æ„æ·»åŠ æˆ–ä½¿ç”¨ä»»ä½•é’´æˆ–å¤©ç„¶äº‘æ¯ï¼Ÿ',
            Q2: 'äº§å“ä¸­æ˜¯å¦è¿˜å­˜æœ‰ä»»ä½•é’´æˆ–å¤©ç„¶äº‘æ¯ï¼Ÿ',
            Q3: 'è´µå…¬å¸ä¾›åº”é“¾ä¸­æ˜¯å¦æœ‰å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ä»å—å†²çªå½±å“å’Œé«˜é£é™©åœ°åŒºé‡‡è´­é’´æˆ–å¤©ç„¶äº‘æ¯ï¼Ÿï¼ˆã€Šç»åˆç»„ç»‡å°½èŒè°ƒæŸ¥æŒ‡å—ã€‹ï¼Œå‚è§å®šä¹‰é€‰é¡¹å¡ï¼‰',
            Q4: 'æ˜¯å¦ 100% çš„é’´æ¥è‡ªå›æ”¶æ–™æˆ–æŠ¥åºŸæ–™èµ„æºï¼Ÿ',
            Q5: 'ç™¾åˆ†ä¹‹å¤šå°‘çš„ç›¸å…³ä¾›åº”å•†å·²å¯¹è´µå…¬å¸çš„ä¾›åº”é“¾è°ƒæŸ¥æä¾›ç­”å¤ï¼Ÿ',
            Q6: 'æ‚¨æ˜¯å¦è¯†åˆ«å‡ºä¸ºè´µå…¬å¸çš„ä¾›åº”é“¾ä¾›åº”é’´æˆ–å¤©ç„¶äº‘æ¯çš„æ‰€æœ‰å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ï¼Ÿ',
            Q7: 'è´µå…¬å¸æ”¶åˆ°çš„æ‰€æœ‰é€‚ç”¨å†¶ç‚¼å‚æˆ–åŠ å·¥å‚ä¿¡æ¯æ˜¯å¦å·²åœ¨æ­¤ç”³æŠ¥ä¸­æŠ¥å‘Šï¼Ÿ'
        };

        const questions = [
            { id: 'Q1', text: questionTextV2.Q1, options: ['Yes', 'No', 'Unknown', 'Not declaring'], dependency: null },
            { id: 'Q2', text: questionTextV2.Q2, options: ['Yes', 'No', 'Unknown'], dependency: null },
            { id: 'Q3', text: questionTextV2.Q3, options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q4', text: questionTextV2.Q4, options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q5', text: questionTextV2.Q5, options: ['100%', 'Greater than 90%', 'Greater than 75%', 'Greater than 50%', '50% or less', 'None', 'Did not survey'], dependency: 'Q1Q2' },
            { id: 'Q6', text: questionTextV2.Q6, options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' },
            { id: 'Q7', text: questionTextV2.Q7, options: ['Yes', 'No', 'Unknown'], dependency: 'Q1Q2' }
        ];

        function isV1() {
            return currentVersion.startsWith('1.');
        }

        function getQuestionText(questionId) {
            if (isV1()) return questionTextV1[questionId] || '';
            return questionTextV2[questionId] || '';
        }

        function isNegativeQ1(value) {
            if (!value) return false;
            if (value === 'No' || value === 'Unknown') return true;
            if (isV1()) return value === 'Not applicable for this declaration';
            return value === 'Not declaring';
        }

        function isNegativeQ2(value) {
            if (!value) return false;
            return value === 'No' || value === 'Unknown';
        }

        function getQuestionOptions(questionId, mineral) {
            if (!isV1()) {
                const q = questions.find(item => item.id === questionId);
                return q ? q.options : [];
            }
            if (questionId === 'Q1') return ['Yes', 'No', 'Unknown', 'Not applicable for this declaration'];
            if (questionId === 'Q2') return ['Yes', 'No', 'Unknown'];
            if (questionId === 'Q3') {
                if (mineral === 'Mica') {
                    return ['Yes', 'No', 'Unknown', 'India and/or Madagascar only'];
                }
                return ['Yes', 'No', 'Unknown', 'DRC only'];
            }
            if (questionId === 'Q4') return ['Yes', 'No', 'Unknown'];
            if (questionId === 'Q5') return ['100%', 'Greater than 90%', 'Greater than 75%', 'Greater than 50%', '50% or less', 'None'];
            if (questionId === 'Q6') return ['Yes', 'No', 'Unknown'];
            if (questionId === 'Q7') return ['Yes', 'No', 'Unknown'];
            const q = questions.find(item => item.id === questionId);
            return q ? q.options : [];
        }

        function getCompanyQuestionsData() {
            if (currentVersion === '1.1') {
                return [
                    { id: 'A', text: 'è´µå…¬å¸æ˜¯å¦åˆ¶å®šäº†å¯å…¬å¼€æŸ¥é˜…çš„é’´é‡‡è´­æ”¿ç­–ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'B', text: 'è´µå…¬å¸çš„æ”¿ç­–æ˜¯å¦è‡³å°‘æ¶µç›–ã€Šç»åˆç»„ç»‡å°½èŒè°ƒæŸ¥æŒ‡å—ã€‹é™„å½•äºŒã€Šç¤ºèŒƒæ”¿ç­–ã€‹ä¸­çš„æ‰€æœ‰é£é™©ä»¥åŠç«¥å·¥é—®é¢˜çš„æœ€æ¶åŠ£å½¢å¼ï¼Ÿ', options: ['Yes', 'No'], commentCondition: 'Yes', commentHint: 'å¦‚é€‰Yesï¼Œè¯·å¡«å†™URL' },
                    { id: 'C', text: 'è´µå…¬å¸æ˜¯å¦è¦æ±‚è´µå…¬å¸çš„ç›´æ¥ä¾›åº”å•†ä»å°½èŒè°ƒæŸ¥å®è·µç»ç‹¬ç«‹ç¬¬ä¸‰æ–¹å®¡è®¡è®¡åˆ’éªŒè¯è¿‡çš„å†¶ç‚¼å‚é‡‡è´­é’´æˆ–ä»æ‹¥æœ‰ç›¸åŒèµ„è´¨çš„åŠ å·¥å‚é‡‡è´­å¤©ç„¶äº‘æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'D', text: 'è´µå…¬å¸æ˜¯å¦è¦æ±‚ä¾›åº”å•†çš„å°½èŒè°ƒæŸ¥å®è·µè‡³å°‘æ¶µç›–ã€Šç»åˆç»„ç»‡å°½èŒè°ƒæŸ¥æŒ‡å—ã€‹é™„å½•äºŒã€Šç¤ºèŒƒæ”¿ç­–ã€‹ä¸­çš„æ‰€æœ‰é£é™©ä»¥åŠç«¥å·¥é—®é¢˜çš„æœ€æ¶åŠ£å½¢å¼ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'E', text: 'è´µå…¬å¸æ˜¯å¦é’ˆå¯¹ç›¸å…³ä¾›åº”å•†è¿›è¡Œé’´å’Œ/æˆ–å¤©ç„¶äº‘æ¯ä¾›åº”é“¾è°ƒæŸ¥ï¼Ÿ', options: ['Yes, in conformance with IPC1755 (e.g. EMRT)', 'Yes, Using Other Format (Describe)', 'No'], commentCondition: 'Yes, Using Other Format (Describe)', commentHint: 'è¯·æè¿°ä½¿ç”¨çš„å…¶ä»–æ ¼å¼' },
                    { id: 'F', text: 'è´µå…¬å¸æ˜¯å¦ä¼šæ ¹æ®é¢„æœŸå®¡æ ¸ä»ä¾›åº”å•†å¤„æ”¶åˆ°çš„å°½èŒè°ƒæŸ¥ä¿¡æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'G', text: 'è´µå…¬å¸çš„å®¡æ ¸æµç¨‹æ˜¯å¦åŒ…æ‹¬çº é”™è¡ŒåŠ¨ç®¡ç†ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null }
                ];
            }
            if (isV1()) {
                return [
                    { id: 'A', text: 'è´µå…¬å¸æ˜¯å¦åˆ¶å®šäº†å¯å…¬å¼€æŸ¥é˜…çš„çŸ¿äº§é‡‡è´­æ”¿ç­–ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'B', text: 'è´µå…¬å¸çš„è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­æ”¿ç­–æ˜¯å¦å…¬å¼€å‘å¸ƒäºè´µå…¬å¸ç½‘é¡µä¸Šï¼Ÿï¼ˆå¤‡æ³¨ - å¦‚æœæ˜¯ï¼Œè¯·åœ¨æ³¨é‡Šå­—æ®µä¸­æ³¨æ˜ URLã€‚ï¼‰', options: ['Yes', 'No'], commentCondition: 'Yes', commentHint: 'å¦‚é€‰Yesï¼Œè¯·å¡«å†™URL' },
                    { id: 'C', text: 'è´µå…¬å¸æ˜¯å¦è¦æ±‚è´µå…¬å¸çš„ç›´æ¥ä¾›åº”å•†ä»å°½èŒè°ƒæŸ¥å®è·µç»ç‹¬ç«‹ç¬¬ä¸‰æ–¹å®¡è®¡è®¡åˆ’éªŒè¯è¿‡çš„å†¶ç‚¼å‚é‡‡è´­é’´æˆ–ä»æ‹¥æœ‰ç›¸åŒèµ„è´¨çš„åŠ å·¥å‚é‡‡è´­å¤©ç„¶äº‘æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'D', text: 'è´µå…¬å¸æ˜¯å¦å·²å®æ–½è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­çš„å°½èŒè°ƒæŸ¥æªæ–½ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'E', text: 'è´µå…¬å¸æ˜¯å¦é’ˆå¯¹ç›¸å…³ä¾›åº”å•†è¿›è¡Œé’´å’Œ/æˆ–å¤©ç„¶äº‘æ¯ä¾›åº”é“¾è°ƒæŸ¥ï¼Ÿ', options: ['Yes, in conformance with IPC1755 (e.g. EMRT)', 'Yes, Using Other Format (Describe)', 'No'], commentCondition: 'Yes, Using Other Format (Describe)', commentHint: 'è¯·æè¿°ä½¿ç”¨çš„å…¶ä»–æ ¼å¼' },
                    { id: 'F', text: 'è´µå…¬å¸æ˜¯å¦ä¼šæ ¹æ®é¢„æœŸå®¡æ ¸ä»ä¾›åº”å•†å¤„æ”¶åˆ°çš„å°½èŒè°ƒæŸ¥ä¿¡æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                    { id: 'G', text: 'è´µå…¬å¸çš„å®¡æ ¸æµç¨‹æ˜¯å¦åŒ…æ‹¬çº é”™è¡ŒåŠ¨ç®¡ç†ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null }
                ];
            }
            return [
                { id: 'A', text: 'è´µå…¬å¸æ˜¯å¦åˆ¶å®šäº†å¯å…¬å¼€æŸ¥é˜…çš„çŸ¿äº§é‡‡è´­æ”¿ç­–ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                { id: 'B', text: 'è´µå…¬å¸çš„è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­æ”¿ç­–æ˜¯å¦å…¬å¼€å‘å¸ƒäºè´µå…¬å¸ç½‘é¡µä¸Šï¼Ÿï¼ˆå¤‡æ³¨ - å¦‚æœæ˜¯ï¼Œè¯·åœ¨æ³¨é‡Šå­—æ®µä¸­æ³¨æ˜ URLã€‚ï¼‰', options: ['Yes', 'No'], commentCondition: 'Yes', commentHint: 'å¦‚é€‰Yesï¼Œè¯·å¡«å†™URL' },
                { id: 'C', text: 'è´µå…¬å¸æ˜¯å¦è¦æ±‚è´µå…¬å¸çš„ç›´æ¥ä¾›åº”å•†ä»å°½èŒè°ƒæŸ¥å®è·µç»ç‹¬ç«‹ç¬¬ä¸‰æ–¹å®¡è®¡è®¡åˆ’éªŒè¯è¿‡çš„å†¶ç‚¼å‚é‡‡è´­æŒ‡å®šçŸ¿äº§ï¼Ÿ', options: ['Yes', 'Yes, when more processors are validated', 'No'], commentCondition: null },
                { id: 'D', text: 'è´µå…¬å¸æ˜¯å¦å·²å®æ–½è´Ÿè´£ä»»çŸ¿äº§é‡‡è´­çš„å°½èŒè°ƒæŸ¥æªæ–½ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                { id: 'E', text: 'è´µå…¬å¸æ˜¯å¦é’ˆå¯¹ç›¸å…³ä¾›åº”å•†è¿›è¡ŒæŒ‡å®šçŸ¿äº§ä¾›åº”é“¾è°ƒæŸ¥ï¼Ÿ', options: ['Yes, in conformance with IPC1755 (e.g. EMRT)', 'Yes, Using Other Format (Describe)', 'No'], commentCondition: 'Yes, Using Other Format (Describe)', commentHint: 'è¯·æè¿°ä½¿ç”¨çš„å…¶ä»–æ ¼å¼' },
                { id: 'F', text: 'è´µå…¬å¸æ˜¯å¦ä¼šæ ¹æ®é¢„æœŸå®¡æ ¸ä»ä¾›åº”å•†å¤„æ”¶åˆ°çš„å°½èŒè°ƒæŸ¥ä¿¡æ¯ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null },
                { id: 'G', text: 'è´µå…¬å¸çš„å®¡æ ¸æµç¨‹æ˜¯å¦åŒ…æ‹¬çº é”™è¡ŒåŠ¨ç®¡ç†ï¼Ÿ', options: ['Yes', 'No'], commentCondition: null }
            ];
        }

        let companyQuestionsData = getCompanyQuestionsData();


        const smelterLookupOptions = [
            'Select from list...',
            'Smelter not listed',
            'Smelter not yet identified',
            '---',
            'Ningxia Orient Tantalum Industry Co., Ltd.',
            'Malaysia Smelting Corporation',
            'Xiamen Tungsten Co., Ltd.',
            'Metalor Technologies SA'
        ];

        const countries = ['China', 'Malaysia', 'Indonesia', 'Japan', 'USA', 'Germany', 'Switzerland', 'Vietnam', 'Thailand', 'Philippines'];

        function getVersionFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const v = params.get('version');
            return v && versionConfigs[v] ? v : null;
        }

        function initVersionSelector() {
            const select = document.getElementById('versionSelect');
            if (!select) return;
            select.innerHTML = '';
            ['2.1', '2.0', '1.3', '1.2', '1.11', '1.1'].forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = `v${v}`;
                select.appendChild(opt);
            });
            select.value = currentVersion;
            select.addEventListener('change', () => {
                const params = new URLSearchParams(window.location.search);
                params.set('version', select.value);
                window.location.search = params.toString();
            });
        }

        function applyVersion(version) {
            const config = versionConfigs[version] || versionConfigs[defaultVersion];
            currentVersion = version;
            mineralOptions = config.minerals;
            companyQuestionsData = getCompanyQuestionsData();
            document.querySelector('.logo-version').textContent = `v${config.label}`;
            document.body.classList.toggle('emrt-no-mine', !config.hasMine);
            document.body.classList.toggle('emrt-no-combined', !config.hasCombined);
            document.body.classList.toggle('emrt-mine-smelter-input', !!config.hasMine && !config.mineSmelterLookup);
            document.body.classList.toggle('emrt-mine-smelter-select', !!config.hasMine && !!config.mineSmelterLookup);
        }

        function hasMineList() {
            return !!versionConfigs[currentVersion]?.hasMine;
        }

        function hasCombinedColumns() {
            return !!versionConfigs[currentVersion]?.hasCombined;
        }

        function hasMineSmelterLookup() {
            return !!versionConfigs[currentVersion]?.mineSmelterLookup;
        }

        function getMineSmelterName(row) {
            if (hasMineSmelterLookup()) {
                const select = row.querySelector('[data-field="smelter_name_select"]');
                return select ? select.value : '';
            }
            const input = row.querySelector('[data-field="smelter_name_input"]');
            return input ? input.value.trim() : '';
        }

        function getPageOrder() {
            const pageOrder = ['declaration', 'smelter'];
            if (hasMineList()) pageOrder.push('mine');
            pageOrder.push('product', 'checker');
            return pageOrder;
        }

        document.addEventListener('DOMContentLoaded', function() {
            initVersionSelector();
            applyVersion(currentVersion);
            renderMineralSelector();
            initQuestionMatrix();
            initCompanyQuestions();
            setupFormListeners();
            updateCompanyFieldsCount();
            addSmelterRow();
            if (hasMineList()) addMineRow();
            addProductRow();
            updateCompanyQuestionsState();
            setupUnsavedChangesTracking();
            setupBeforeUnload();
            runChecker();
            setupProgressNavigation();
            goToPage('declaration');
            updateStickyOffsets();
            window.addEventListener('resize', updateStickyOffsets);
        });

        // ç¦»å¼€ç¡®è®¤
        function setupBeforeUnload() {
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ•°æ®ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                    return e.returnValue;
                }
            });
        }

        function markAsModified() {
            hasUnsavedChanges = true;
        }

        function updateStickyOffsets() {
            const nav = document.querySelector('.top-nav');
            if (!nav) return;
            const height = nav.getBoundingClientRect().height;
            document.documentElement.style.setProperty('--top-nav-height', `${height}px`);
        }

        function shouldTrackUnsaved(target) {
            if (!target) return false;
            if (target.id === 'versionSelect') return false;
            return target.matches('input, select, textarea');
        }

        function setupUnsavedChangesTracking() {
            document.addEventListener('input', (e) => {
                if (shouldTrackUnsaved(e.target)) markAsModified();
            });
            document.addEventListener('change', (e) => {
                if (shouldTrackUnsaved(e.target)) markAsModified();
            });
        }

        function setupProgressNavigation() {
            document.querySelectorAll('.progress-step').forEach(step => {
                step.addEventListener('click', () => {
                    const target = step.dataset.step;
                    if (!getPageOrder().includes(target)) return;
                    goToPage(target);
                });
            });
        }

        document.addEventListener('click', (e) => {
            const btn = e.target.closest('.page-actions button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (action !== 'prev' && action !== 'next') return;
            const target = btn.dataset.target;
            if (target) goToPage(target);
        });

        function updatePageActions() {
            const pageOrder = getPageOrder();
            document.querySelectorAll('.page-actions').forEach(actions => {
                const pageId = actions.dataset.page;
                const index = pageOrder.indexOf(pageId);
                const prevBtn = actions.querySelector('[data-action="prev"]');
                const nextBtn = actions.querySelector('[data-action="next"]');
                if (prevBtn) {
                    const prevPage = index > 0 ? pageOrder[index - 1] : '';
                    prevBtn.disabled = index <= 0;
                    prevBtn.dataset.target = prevPage;
                }
                if (nextBtn) {
                    const nextPage = index >= 0 && index < pageOrder.length - 1 ? pageOrder[index + 1] : '';
                    nextBtn.disabled = index === -1 || index >= pageOrder.length - 1;
                    nextBtn.dataset.target = nextPage;
                }
            });
        }

        function goToPage(pageId) {
            const page = document.getElementById('page-' + pageId);
            if (!page) return;
            currentPageId = pageId;
            document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
            page.classList.add('active');
            updateProgressIndicator(pageId);
            updatePageActions();
            if (pageId === 'checker') {
                runChecker();
            }
        }

        // æ›´æ–°è¿›åº¦æŒ‡ç¤ºå™¨
        function updateProgressIndicator(currentPage) {
            const pageOrder = getPageOrder();

            document.querySelectorAll('.progress-step').forEach(step => {
                const stepPage = step.dataset.step;
                step.style.display = pageOrder.includes(stepPage) ? 'flex' : 'none';
            });
            document.querySelectorAll('.progress-arrow').forEach(arrow => {
                const after = arrow.dataset.after;
                arrow.style.display = pageOrder.includes(after) ? 'inline' : 'none';
            });

            const currentIndex = pageOrder.indexOf(currentPage);
            document.querySelectorAll('.progress-step').forEach(step => {
                const stepPage = step.dataset.step;
                if (!pageOrder.includes(stepPage)) return;
                const index = pageOrder.indexOf(stepPage);
                step.classList.remove('active', 'completed');
                const num = step.querySelector('.progress-step-num');
                if (index < currentIndex) {
                    step.classList.add('completed');
                    if (num) num.textContent = 'âœ“';
                } else if (index === currentIndex) {
                    step.classList.add('active');
                    if (num) num.textContent = index + 1;
                } else {
                    if (num) num.textContent = index + 1;
                }
            });
        }

        // è·³è½¬åˆ° Checker é¡µé¢
        function goToChecker() {
            goToPage('checker');
        }

        // åˆ‡æ¢é€šè¿‡é¡¹å±•å¼€/æŠ˜å 
        function togglePassedDetails() {
            const details = document.getElementById('passedDetails');
            const btn = document.getElementById('passedToggleBtn');
            details.classList.toggle('expanded');
            btn.textContent = details.classList.contains('expanded') ? 'æ”¶èµ·' : 'å±•å¼€æŸ¥çœ‹';
        }

        // åˆ‡æ¢é”™è¯¯åˆ†ç»„å±•å¼€/æŠ˜å 
        function toggleErrorGroup(groupId) {
            const group = document.getElementById(groupId);
            group.classList.toggle('collapsed');
        }

        function handleModalBackdrop(event) {
            if (event.target && event.target.id === 'submitModal') {
                closeSubmitModal();
            }
        }

        function openSubmitModal() {
            const result = runChecker();
            const errors = result?.errors || lastCheckerSummary.errors || [];
            const completion = result?.completion ?? lastCheckerSummary.completion ?? 0;
            const errorCount = errors.length;

            document.getElementById('submitCompletion').textContent = completion + '%';
            document.getElementById('submitErrorCount').textContent = errorCount;

            const list = document.getElementById('submitErrorsList');
            const errorsSection = document.getElementById('submitErrorsSection');
            const allPass = document.getElementById('submitAllPass');
            const fixBtn = document.getElementById('submitFixBtn');

            if (errorCount === 0) {
                errorsSection.style.display = 'none';
                allPass.style.display = 'block';
                if (fixBtn) fixBtn.disabled = true;
                list.innerHTML = '';
            } else {
                errorsSection.style.display = 'block';
                allPass.style.display = 'none';
                if (fixBtn) fixBtn.disabled = false;
                list.innerHTML = errors.slice(0, 5).map(item => `
                    <li class="submit-error-item">
                        <span>âŒ</span>
                        <div>
                            <div>${formatCheckerLocation(item.location || '')}</div>
                            <div style="color: var(--gray-500); font-size: 12px;">${item.message}</div>
                        </div>
                    </li>
                `).join('');
            }

            document.getElementById('submitModal').classList.add('show');
        }

        function closeSubmitModal() {
            document.getElementById('submitModal').classList.remove('show');
        }

        function handleSubmitFix() {
            closeSubmitModal();
            goToChecker();
            const errorsCard = document.getElementById('errorsCard');
            if (errorsCard) {
                setTimeout(() => errorsCard.scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
            }
        }

        function renderMineralSelector() {
            const container = document.getElementById('mineralSelector');
            const card = document.getElementById('mineralScopeCard');
            const hint = document.getElementById('mineralScopeHint');
            if (isV1()) {
                if (card) card.style.display = 'none';
                appData.minerals = mineralOptions.map(m => m.id);
                initQuestionMatrix();
                initCompanyQuestions();
                updateCompanyQuestionsState();
                updateSmelterMetalOptions();
                if (hasMineList()) updateMineMetalOptions();
                runChecker();
                return;
            }
            if (card) card.style.display = '';
            container.innerHTML = '';
            if (hint) hint.style.display = currentVersion === '2.0' ? 'none' : '';

            mineralOptions.forEach(m => {
                const label = document.createElement('label');
                label.className = 'mineral-option';
                label.innerHTML = `<input type="checkbox" value="${m.id}" autocomplete="off"> ${m.name}`;
                const input = label.querySelector('input');
                input.checked = true;
                input.defaultChecked = true;
                input.addEventListener('change', updateSelectedMinerals);
                container.appendChild(label);
            });
            updateSelectedMinerals();
        }

        function updateSelectedMinerals() {
            const selected = Array.from(document.querySelectorAll('#mineralSelector input:checked')).map(i => i.value);
            const sorted = selected.slice().sort((a, b) => a.localeCompare(b));
            appData.minerals = sorted;

            document.getElementById('mineralScopeCount').textContent = `${sorted.length}/${mineralOptions.length} å·²é€‰`;

            const selectedList = document.getElementById('selectedMineralList');
            selectedList.innerHTML = sorted.map(m => `<span class="mineral-chip">${m}</span>`).join('');

            initQuestionMatrix();
            initCompanyQuestions();
            updateCompanyQuestionsState();
            updateSmelterMetalOptions();
            if (hasMineList()) updateMineMetalOptions();
            runChecker();
        }

        // Question Matrix
        function initQuestionMatrix() {
            const container = document.getElementById('questionMatrixContainer');
            container.innerHTML = '';

            if (appData.minerals.length === 0) {
                container.innerHTML = '<div class="form-hint">è¯·å…ˆé€‰æ‹©çŸ¿äº§ç”³æŠ¥èŒƒå›´</div>';
                return;
            }

            // Preserve existing answers/comments for minerals still in scope
            const previousMatrix = appData.questionMatrix || {};
            const nextMatrix = {};
            questions.forEach(q => {
                nextMatrix[q.id] = {};
                appData.minerals.forEach(m => {
                    const existing = previousMatrix[q.id]?.[m];
                    nextMatrix[q.id][m] = existing
                        ? { answer: existing.answer || '', comment: existing.comment || '' }
                        : { answer: '', comment: '' };
                });
            });
            appData.questionMatrix = nextMatrix;

            questions.forEach(q => {
                const block = document.createElement('div');
                block.className = 'question-block';
                block.id = 'question-' + q.id;

                const isDependentQ = q.dependency === 'Q1Q2';

                block.innerHTML = `
                    <div class="question-header">
                        <span class="q-num">${q.id.replace('Q', '')}</span>
                        ${getQuestionText(q.id)}
                    </div>
                    <table class="question-table">
                        <thead>
                            <tr>
                                <th style="width: 160px;"></th>
                                <th style="width: 220px;">å›ç­”</th>
                                <th>æ³¨é‡Š</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${appData.minerals.map(m => {
                                const meta = mineralOptions.find(x => x.id === m);
                                return `
                                <tr data-mineral="${m}">
                                    <td>
                                        <span class="metal-label ${meta ? meta.class : ''}">
                                            ${m} <span class="required">*</span>
                                        </span>
                                    </td>
                                    <td>
                                        <select class="answer-select" data-question="${q.id}" data-mineral="${m}" ${isDependentQ ? 'disabled' : ''}>
                                            <option value="">--</option>
                                            ${getQuestionOptions(q.id, m).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" class="comment-input" data-question="${q.id}" data-mineral="${m}" placeholder="æ³¨é‡Š (å¯é€‰)">
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                `;
                container.appendChild(block);
            });

            container.querySelectorAll('.answer-select').forEach(select => {
                select.addEventListener('change', function() {
                    const q = this.dataset.question;
                    const m = this.dataset.mineral;
                    appData.questionMatrix[q][m].answer = this.value;
                    this.classList.toggle('answered', this.value !== '');

                    if (q === 'Q1') {
                        updateQ2Dependency();
                        updateQ3Q7Dependency();
                        updateCompanyQuestionsState();
                        updateSmelterWarning();
                        updateSmelterMetalOptions();
                        if (hasMineList()) updateMineMetalOptions();
                    } else if (q === 'Q2') {
                        updateQ3Q7Dependency();
                        updateCompanyQuestionsState();
                        updateSmelterWarning();
                        updateSmelterMetalOptions();
                        if (hasMineList()) updateMineMetalOptions();
                    }

                    runChecker();
                });
            });

            container.querySelectorAll('.comment-input').forEach(input => {
                input.addEventListener('input', function() {
                    const q = this.dataset.question;
                    const m = this.dataset.mineral;
                    appData.questionMatrix[q][m].comment = this.value;
                    runChecker();
                });
            });

            // Restore values from preserved matrix
            container.querySelectorAll('.answer-select').forEach(select => {
                const q = select.dataset.question;
                const m = select.dataset.mineral;
                const value = appData.questionMatrix[q]?.[m]?.answer || '';
                if (value) {
                    select.value = value;
                    select.classList.add('answered');
                }
            });
            container.querySelectorAll('.comment-input').forEach(input => {
                const q = input.dataset.question;
                const m = input.dataset.mineral;
                const value = appData.questionMatrix[q]?.[m]?.comment || '';
                if (value) input.value = value;
            });

            updateQ2Dependency();
            updateQ3Q7Dependency();
            updateCompanyQuestionsState();
            updateSmelterWarning();
            updateSmelterMetalOptions();
            if (hasMineList()) updateMineMetalOptions();
        }

        function getSmelterEligibleMetals() {
            if (isV1()) {
                return mineralOptions.map(m => m.id);
            }
            return appData.minerals.filter(m => appData.questionMatrix['Q2']?.[m]?.answer === 'Yes');
        }

        function updateQ2Dependency() {
            appData.minerals.forEach(m => {
                const q1Answer = appData.questionMatrix['Q1']?.[m]?.answer;
                const required = !isNegativeQ1(q1Answer);
                const q2Select = document.querySelector(`select[data-question="Q2"][data-mineral="${m}"]`);
                const q2Comment = document.querySelector(`input.comment-input[data-question="Q2"][data-mineral="${m}"]`);

                if (q2Select) {
                    q2Select.disabled = !required;
                    q2Select.classList.toggle('disabled', !required);
                    if (!required) {
                        q2Select.value = '';
                        q2Select.classList.remove('answered');
                        if (appData.questionMatrix['Q2']?.[m]) {
                            appData.questionMatrix['Q2'][m].answer = '';
                        }
                    }
                }

                if (q2Comment) {
                    q2Comment.disabled = !required;
                    q2Comment.classList.toggle('disabled', !required);
                    if (!required) {
                        q2Comment.value = '';
                        if (appData.questionMatrix['Q2']?.[m]) {
                            appData.questionMatrix['Q2'][m].comment = '';
                        }
                    }
                }
            });
        }

        function updateQ3Q7Dependency() {
            appData.minerals.forEach(m => {
                const q1Answer = appData.questionMatrix['Q1']?.[m]?.answer;
                const q2Answer = appData.questionMatrix['Q2']?.[m]?.answer;
                const required = !isNegativeQ1(q1Answer) && !isNegativeQ2(q2Answer);

                ['Q3', 'Q4', 'Q5', 'Q6', 'Q7'].forEach(qId => {
                    const select = document.querySelector(`select[data-question="${qId}"][data-mineral="${m}"]`);
                    const comment = document.querySelector(`input.comment-input[data-question="${qId}"][data-mineral="${m}"]`);
                    const row = select ? select.closest('tr') : null;
                    if (select) {
                        select.disabled = !required;
                        select.classList.toggle('disabled', !required);
                        if (!required) {
                            select.value = '';
                            select.classList.remove('answered');
                            appData.questionMatrix[qId][m].answer = '';
                        }
                    }
                    if (comment) {
                        comment.disabled = !required;
                        comment.classList.toggle('disabled', !required);
                        if (!required) {
                            comment.value = '';
                            appData.questionMatrix[qId][m].comment = '';
                        }
                    }

                    if (row) {
                        row.style.opacity = required ? '1' : '0.5';
                    }
                });
            });

            ['Q3', 'Q4', 'Q5', 'Q6', 'Q7'].forEach(qId => {
                const block = document.getElementById('question-' + qId);
                if (!block) return;
                let allDisabledForQ = true;
                appData.minerals.forEach(m => {
                    const q1Answer = appData.questionMatrix['Q1']?.[m]?.answer;
                    const q2Answer = appData.questionMatrix['Q2']?.[m]?.answer;
                    if (q1Answer !== 'No' && q2Answer !== 'No') {
                        allDisabledForQ = false;
                    }
                });
                const oldHint = block.querySelector('.disabled-overlay-hint');
                if (oldHint) oldHint.remove();
                block.classList.remove('disabled-overlay');
            });
        }

        function updateCompanyQuestionsState() {
            const eligibleMetals = appData.minerals.filter(m => {
                const q1 = appData.questionMatrix['Q1']?.[m]?.answer;
                const q2 = appData.questionMatrix['Q2']?.[m]?.answer;
                return !isNegativeQ1(q1) && !isNegativeQ2(q2);
            });
            const anyRequired = eligibleMetals.length > 0;

            const container = document.getElementById('companyQuestionsBody');
            const status = document.getElementById('cqStatus');

            container.classList.remove('cq-disabled');
            container.classList.toggle('cq-required', anyRequired);
            if (anyRequired) {
                status.textContent = 'å¿…å¡«';
                status.style.background = 'var(--error-light)';
                status.style.color = 'var(--error)';
            } else {
                const q1Label = isV1() ? 'No/Unknown/Not applicable' : 'No/Unknown/Not declaring';
                status.textContent = `Q1 ä¸º ${q1Label} æˆ– Q2 ä¸º No/Unknown æ—¶å¯é€‰å¡«å†™`;
                status.style.background = '';
                status.style.color = '';
            }

            document.querySelectorAll('.cq-mineral-row[data-question="C"]').forEach(row => {
                const metal = row.dataset.mineral;
                const q1 = appData.questionMatrix['Q1']?.[metal]?.answer;
                const q2 = appData.questionMatrix['Q2']?.[metal]?.answer;
                const required = !isNegativeQ1(q1) && !isNegativeQ2(q2);
                const select = row.querySelector('.cq-select');
                if (select) {
                    select.disabled = false;
                    select.classList.remove('disabled');
                }
                row.classList.toggle('cq-row-optional', !required);
                row.classList.remove('cq-row-disabled');
            });
        }

        function updateSmelterWarning() {
            const warningCard = document.getElementById('smelterWarningCard');
            const warningText = document.getElementById('smelterWarningText');
            if (warningCard) warningCard.style.display = 'none';
            if (warningText) warningText.textContent = '';
        }

        // Company Questions
        function initCompanyQuestions() {
            const container = document.getElementById('companyQuestionsBody');
            container.innerHTML = '';

            if (!appData.companyQuestions || typeof appData.companyQuestions !== 'object') {
                appData.companyQuestions = {};
            }
            if (!appData.companyQuestions.C || typeof appData.companyQuestions.C !== 'object') {
                appData.companyQuestions.C = {};
            }
            appData.minerals.forEach(m => {
                if (appData.companyQuestions.C[m] === undefined) {
                    appData.companyQuestions.C[m] = '';
                }
            });

            companyQuestionsData.forEach(q => {
                if (q.id !== 'C') {
                    const div = document.createElement('div');
                    div.className = 'company-question';
                    div.innerHTML = `
                        <div class="cq-letter">${q.id}</div>
                        <div class="cq-content">
                            <div class="cq-text">${q.text}</div>
                            <div class="cq-options">
                                <select class="cq-select" data-question="${q.id}">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                    ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                </select>
                            </div>
                            ${q.commentCondition ? `
                                <div class="cq-comment" id="cq-comment-${q.id}">
                                    <input type="text" placeholder="${q.commentHint || 'è¯·å¡«å†™æ³¨é‡Š'}" data-question="${q.id}">
                                </div>
                            ` : ''}
                        </div>
                    `;
                    container.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'company-question';
                    div.innerHTML = `
                        <div class="cq-letter">${q.id}</div>
                        <div class="cq-content">
                            <div class="cq-text">${q.text}</div>
                            <div class="cq-mineral-list">
                                ${appData.minerals.map(m => `
                                    <div class="cq-mineral-row" data-question="C" data-mineral="${m}">
                                        <span class="cq-mineral-label">${m}</span>
                                        <select class="cq-select" data-question="C" data-mineral="${m}">
                                            <option value="">-- è¯·é€‰æ‹© --</option>
                                            ${q.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                                        </select>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });

            container.querySelectorAll('.cq-select').forEach(select => {
                select.addEventListener('change', function() {
                    const qId = this.dataset.question;
                    const mineral = this.dataset.mineral;
                    if (qId === 'C' && mineral) {
                        if (!appData.companyQuestions.C || typeof appData.companyQuestions.C !== 'object') {
                            appData.companyQuestions.C = {};
                        }
                        appData.companyQuestions.C[mineral] = this.value;
                    } else {
                        appData.companyQuestions[qId] = this.value;
                    }
                    this.classList.toggle('answered', this.value !== '');

                    if (qId !== 'C') {
                        const qData = companyQuestionsData.find(q => q.id === qId);
                        const comment = document.getElementById('cq-comment-' + qId);
                        if (comment && qData.commentCondition) {
                            comment.classList.toggle('show', this.value === qData.commentCondition);
                        }
                    }

                    runChecker();
                });
            });

            container.querySelectorAll('.cq-comment input').forEach(input => {
                input.addEventListener('input', runChecker);
            });

            container.querySelectorAll('.cq-select').forEach(select => {
                const qId = select.dataset.question;
                const mineral = select.dataset.mineral;
                let value = '';
                if (qId === 'C' && mineral) {
                    value = appData.companyQuestions.C?.[mineral] || '';
                } else {
                    value = appData.companyQuestions[qId] || '';
                }
                if (value) {
                    select.value = value;
                    select.classList.add('answered');
                }
                if (qId !== 'C') {
                    const qData = companyQuestionsData.find(q => q.id === qId);
                    const comment = document.getElementById('cq-comment-' + qId);
                    if (comment && qData.commentCondition) {
                        comment.classList.toggle('show', value === qData.commentCondition);
                    }
                }
            });
        }

        // Form Listeners
        function setupFormListeners() {
            document.getElementById('declarationScope').addEventListener('change', function() {
                const scopeDescGroup = document.getElementById('scopeDescGroup');
                scopeDescGroup.style.display = this.value === 'C' ? 'block' : 'none';
                this.classList.toggle('required-field', !this.value);
                markAsModified();
                updateCompanyFieldsCount();
                runChecker();
            });

            const handleCompanyFieldInput = (input) => {
                markAsModified();
                if (input.classList.contains('required-field') && input.value.trim()) {
                    input.classList.remove('required-field');
                    input.classList.add('valid');
                } else if (!input.value.trim() && input.closest('[data-required="true"]')) {
                    input.classList.add('required-field');
                    input.classList.remove('valid');
                }
                updateCompanyFieldsCount();
                runChecker();
            };

            document.querySelectorAll('#companyForm input, #companyForm select, #companyForm textarea').forEach(input => {
                input.addEventListener('input', () => handleCompanyFieldInput(input));
                input.addEventListener('change', () => handleCompanyFieldInput(input));
            });
        }

        function updateCompanyFieldsCount() {
            const requiredFields = document.querySelectorAll('#companyForm [data-required="true"]');
            let filled = 0;
            let total = 8; // åŸºç¡€ 8 ä¸ªå¿…å¡«å­—æ®µ
            requiredFields.forEach(group => {
                const input = group.querySelector('input, select, textarea');
                if (input && input.value.trim()) filled++;
            });

            const scope = document.getElementById('declarationScope').value;
            if (scope === 'C') {
                total += 1;
                const desc = document.getElementById('scopeDescription').value.trim();
                if (desc) filled++;
            }

            document.getElementById('companyFieldsCount').textContent = `${filled}/${total} å¿…å¡«å·²å®Œæˆ`;
        }

        // Smelter List
        function addSmelterRow() {
            const tbody = document.getElementById('smelterTableBody');
            const rowId = 'smelter-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td class="sticky-col-1" style="left: 0; background: white;"><input type="text" data-field="id_input" placeholder="è¾“å…¥è¯†åˆ«å·..." style="font-family: var(--font-mono); font-size: 11px;"></td>
                <td class="sticky-col-2" style="left: 120px; background: white;"><select data-field="metal" class="metal-select" style="background: var(--yellow-fill);"></select></td>
                <td class="sticky-col-3" style="left: 240px; background: white; border-right: 2px solid var(--gray-300);"><select data-field="lookup" style="background: var(--yellow-fill);"></select></td>
                <td><input type="text" data-field="name" placeholder="å†¶ç‚¼å‚åç§°"></td>
                <td><select data-field="country"></select></td>
                <td><input type="text" data-field="smelter_id" placeholder="CID..." style="font-family: var(--font-mono); font-size: 10px; background: var(--gray-100);" readonly></td>
                <td><input type="text" data-field="source_id" placeholder="Source ID" style="font-size: 10px; background: var(--gray-100);" readonly></td>
                <td><input type="text" data-field="street" placeholder="è¡—é“" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" data-field="city" placeholder="åŸå¸‚" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" data-field="state" placeholder="å·/çœ" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><input type="text" data-field="contact" placeholder="è”ç³»äºº" style="font-size: 11px;"></td>
                <td><input type="email" data-field="email" placeholder="email@..." style="font-size: 11px;"></td>
                <td><input type="text" data-field="next_steps" placeholder="åç»­æ­¥éª¤" style="font-size: 11px;"></td>
                <td><input type="text" data-field="mine_name" placeholder="çŸ¿äº•åç§°" style="font-size: 11px;"></td>
                <td><input type="text" data-field="mine_country" placeholder="çŸ¿äº•å›½å®¶" style="font-size: 11px;"></td>
                <td>
                    <select data-field="recycled">
                        <option value="">--</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                        <option value="Unknown">Unknown</option>
                    </select>
                </td>
                <td><input type="text" data-field="comments" placeholder="æ³¨é‡Š" style="font-size: 11px;"></td>
                <td class="col-combined"><input type="text" data-field="combined_metal" placeholder="" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td class="col-combined"><input type="text" data-field="combined_smelter" placeholder="" style="font-size: 11px; background: var(--gray-100);" readonly></td>
                <td><button class="delete-row-btn" onclick="deleteRow('${rowId}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);

            bindSmelterRow(tr);
            updateSmelterCount();
            updateSmelterMetalOptions();
            runChecker();
        }

        function bindSmelterRow(row) {
            const idInput = row.querySelector('[data-field="id_input"]');
            const metalSelect = row.querySelector('[data-field="metal"]');
            const lookupSelect = row.querySelector('[data-field="lookup"]');
            const countrySelect = row.querySelector('[data-field="country"]');

            idInput.addEventListener('change', () => {
                handleSmelterIdInput(row);
                runChecker();
            });

            metalSelect.addEventListener('change', () => {
                metalSelect.style.background = metalSelect.value ? 'white' : 'var(--yellow-fill)';
                updateCombinedFields(row);
                refreshMineSmelterOptions();
                runChecker();
            });

            lookupSelect.addEventListener('change', () => {
                lookupSelect.style.background = lookupSelect.value ? 'white' : 'var(--yellow-fill)';
                handleSmelterLookupChange(row);
                updateCombinedFields(row);
                refreshMineSmelterOptions();
                runChecker();
            });

            countrySelect.addEventListener('change', () => {
                updateCombinedFields(row);
                runChecker();
            });

            row.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', () => {
                    updateCombinedFields(row);
                    runChecker();
                });
            });

            row.querySelectorAll('select').forEach(select => {
                if (select !== metalSelect && select !== lookupSelect && select !== countrySelect) {
                    select.addEventListener('change', runChecker);
                }
            });
        }

        function updateSmelterMetalOptions() {
            const eligibleMetals = getSmelterEligibleMetals();
            document.querySelectorAll('#smelterTableBody tr').forEach(row => {
                const select = row.querySelector('[data-field="metal"]');
                const current = select.value;
                const options = eligibleMetals.slice();
                const keepLegacy = current && !options.includes(current);
                if (keepLegacy) options.unshift(current);
                select.innerHTML = '<option value="">--</option>' + options.map(m => {
                    if (keepLegacy && m === current) {
                        return `<option value="${m}" disabled>${m}</option>`;
                    }
                    return `<option value="${m}">${m}</option>`;
                }).join('');
                if (current) select.value = current;
                select.style.background = select.value ? 'white' : 'var(--yellow-fill)';
            });

            document.querySelectorAll('#smelterTableBody tr').forEach(row => {
                const lookup = row.querySelector('[data-field="lookup"]');
                const lookupValue = lookup.value;
                lookup.innerHTML = smelterLookupOptions.map(opt =>
                    opt === '---' ? '<option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>' : `<option value="${opt}">${opt}</option>`
                ).join('');
                lookup.value = smelterLookupOptions.includes(lookupValue) ? lookupValue : '';

                const country = row.querySelector('[data-field="country"]');
                const countryValue = country.value;
                country.innerHTML = '<option value="">-- é€‰æ‹© --</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
                country.value = countries.includes(countryValue) ? countryValue : '';
            });
        }

        function handleSmelterIdInput(row) {
            const idValue = row.querySelector('[data-field="id_input"]').value.trim();
            if (!idValue) return;

            if (idValue.startsWith('CID')) {
                row.querySelector('[data-field="smelter_id"]').value = idValue;
                row.querySelector('[data-field="source_id"]').value = 'SRC-' + idValue.slice(3);
                showToast('å·²é€šè¿‡è¯†åˆ«å·è‡ªåŠ¨å¡«å……éƒ¨åˆ†å­—æ®µ', 'success');
            }
        }

        function handleSmelterLookupChange(row) {
            const lookupValue = row.querySelector('[data-field="lookup"]').value;
            const nameInput = row.querySelector('[data-field="name"]');
            const countrySelect = row.querySelector('[data-field="country"]');
            const smelterId = row.querySelector('[data-field="smelter_id"]');
            const sourceId = row.querySelector('[data-field="source_id"]');
            const street = row.querySelector('[data-field="street"]');
            const city = row.querySelector('[data-field="city"]');
            const state = row.querySelector('[data-field="state"]');

            countrySelect.disabled = false;
            countrySelect.style.background = '';

            if (lookupValue === 'Smelter not listed') {
                nameInput.disabled = false;
                nameInput.placeholder = 'å¿…å¡«ï¼šå†¶ç‚¼å‚åç§°';
                nameInput.style.background = 'var(--yellow-fill)';
                countrySelect.style.background = 'var(--yellow-fill)';
                smelterId.value = '';
                sourceId.value = '';
                street.value = '';
                city.value = '';
                state.value = '';
            } else if (lookupValue === 'Smelter not yet identified') {
                nameInput.disabled = true;
                nameInput.value = 'Unknown';
                nameInput.style.background = 'var(--gray-100)';
                smelterId.value = 'Unknown';
                sourceId.value = 'Unknown';
                countrySelect.value = '';
            } else if (lookupValue && !lookupValue.includes('Select')) {
                nameInput.value = lookupValue;
                nameInput.disabled = true;
                nameInput.style.background = 'var(--gray-100)';

                const mockData = getSmelterMockData(lookupValue);
                smelterId.value = mockData.cid;
                sourceId.value = mockData.sourceId;
                street.value = mockData.street;
                city.value = mockData.city;
                state.value = mockData.state;
                countrySelect.value = mockData.country;
                countrySelect.style.background = 'var(--gray-100)';
                countrySelect.disabled = true;
            } else {
                nameInput.disabled = false;
                nameInput.value = '';
                nameInput.style.background = '';
            }
        }

        function updateCombinedFields(row) {
            const metal = row.querySelector('[data-field="metal"]').value;
            const name = row.querySelector('[data-field="name"]').value;
            row.querySelector('[data-field="combined_metal"]').value = metal;
            row.querySelector('[data-field="combined_smelter"]').value = name;
        }

        function getSmelterMockData(smelterName) {
            const mockDatabase = {
                'Ningxia Orient Tantalum Industry Co., Ltd.': {
                    cid: 'CID001277', sourceId: 'RMI-Ta-001', country: 'China',
                    street: '123 Industrial Road', city: 'Shizuishan', state: 'Ningxia'
                },
                'Malaysia Smelting Corporation': {
                    cid: 'CID001105', sourceId: 'RMI-Sn-002', country: 'Malaysia',
                    street: '88 Smelter Ave', city: 'Butterworth', state: 'Penang'
                },
                'Xiamen Tungsten Co., Ltd.': {
                    cid: 'CID002082', sourceId: 'RMI-W-003', country: 'China',
                    street: '56 Tungsten Blvd', city: 'Xiamen', state: 'Fujian'
                },
                'Metalor Technologies SA': {
                    cid: 'CID001149', sourceId: 'RMI-Au-004', country: 'Switzerland',
                    street: '2 Metalor Strasse', city: 'Marin-Epagnier', state: 'NeuchÃ¢tel'
                }
            };
            return mockDatabase[smelterName] || {
                cid: 'CID' + Math.floor(Math.random() * 900000 + 100000),
                sourceId: 'SRC-' + Math.floor(Math.random() * 10000),
                country: '', street: '', city: '', state: ''
            };
        }

        function updateSmelterCount() {
            const count = document.querySelectorAll('#smelterTableBody tr').length;
            document.getElementById('smelterCount').textContent = `${count} æ¡è®°å½•`;
        }

        // Mine List
        function addMineRow() {
            const tbody = document.getElementById('mineTableBody');
            const rowId = 'mine-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><select data-field="metal"></select></td>
                <td>
                    <select data-field="smelter_name_select" class="mine-smelter-select"></select>
                    <input type="text" data-field="smelter_name_input" class="mine-smelter-input" placeholder="å†¶ç‚¼å‚åç§°">
                </td>
                <td><input type="text" data-field="mine_name" placeholder="çŸ¿å‚åç§°"></td>
                <td><input type="text" data-field="mine_id" placeholder="CID..."></td>
                <td><input type="text" data-field="source_id" placeholder="Source ID"></td>
                <td><select data-field="country"></select></td>
                <td><input type="text" data-field="street" placeholder="è¡—é“"></td>
                <td><input type="text" data-field="city" placeholder="åŸå¸‚"></td>
                <td><input type="text" data-field="state" placeholder="å·/çœ"></td>
                <td><input type="text" data-field="contact" placeholder="è”ç³»äºº"></td>
                <td><input type="email" data-field="email" placeholder="email@..."></td>
                <td><input type="text" data-field="next_steps" placeholder="åç»­æ­¥éª¤"></td>
                <td><input type="text" data-field="comments" placeholder="æ³¨é‡Š"></td>
                <td><button class="delete-row-btn" onclick="deleteRow('${rowId}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            bindMineRow(tr);
            updateMineCount();
            updateMineMetalOptions();
            refreshMineSmelterOptions();
            runChecker();
        }

        function bindMineRow(row) {
            row.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('input', runChecker);
                el.addEventListener('change', () => {
                    if (el.dataset.field === 'metal') {
                        if (hasMineSmelterLookup()) refreshMineSmelterOptions();
                    }
                    runChecker();
                });
            });
        }

        function updateMineMetalOptions() {
            const eligibleMetals = getSmelterEligibleMetals();
            document.querySelectorAll('#mineTableBody tr').forEach(row => {
                const select = row.querySelector('[data-field="metal"]');
                const current = select.value;
                const options = eligibleMetals.slice();
                const keepLegacy = current && !options.includes(current);
                if (keepLegacy) options.unshift(current);
                select.innerHTML = '<option value="">--</option>' + options.map(m => {
                    if (keepLegacy && m === current) {
                        return `<option value="${m}" disabled>${m}</option>`;
                    }
                    return `<option value="${m}">${m}</option>`;
                }).join('');
                if (current) select.value = current;

                const country = row.querySelector('[data-field="country"]');
                const countryValue = country.value;
                country.innerHTML = '<option value="">-- é€‰æ‹© --</option>' + countries.map(c => `<option value="${c}">${c}</option>`).join('');
                country.value = countries.includes(countryValue) ? countryValue : '';
            });
        }

        function refreshMineSmelterOptions() {
            if (!hasMineSmelterLookup()) return;
            const smelterByMetal = {};
            document.querySelectorAll('#smelterTableBody tr').forEach(row => {
                const metal = row.querySelector('[data-field="metal"]').value;
                const name = row.querySelector('[data-field="name"]').value;
                if (metal && name) {
                    if (!smelterByMetal[metal]) smelterByMetal[metal] = [];
                    if (!smelterByMetal[metal].includes(name)) smelterByMetal[metal].push(name);
                }
            });

            document.querySelectorAll('#mineTableBody tr').forEach(row => {
                const metal = row.querySelector('[data-field="metal"]').value;
                const select = row.querySelector('[data-field="smelter_name_select"]');
                if (!select) return;
                const current = select.value;
                const options = (smelterByMetal[metal] || []);
                select.innerHTML = '<option value="">-- é€‰æ‹© --</option>' + options.map(n => `<option value="${n}">${n}</option>`).join('');
                if (options.includes(current)) {
                    select.value = current;
                } else {
                    select.value = '';
                }
            });
        }

        function updateMineCount() {
            const count = document.querySelectorAll('#mineTableBody tr').length;
            document.getElementById('mineCount').textContent = `${count} æ¡è®°å½•`;
        }

        // Product List
        function addProductRow() {
            const tbody = document.getElementById('productTableBody');
            const rowId = 'product-' + Date.now();
            const tr = document.createElement('tr');
            tr.id = rowId;
            tr.innerHTML = `
                <td><input type="text" data-field="product_id" placeholder="PRD-xxxx-xxx" style="font-family: var(--font-mono);"></td>
                <td><input type="text" data-field="product_name" placeholder="äº§å“åç§°"></td>
                <td><input type="text" data-field="requester_id" placeholder="è¯·æ±‚æ–¹äº§å“ç¼–å·"></td>
                <td><input type="text" data-field="requester_name" placeholder="è¯·æ±‚æ–¹äº§å“åç§°"></td>
                <td><input type="text" data-field="comments" placeholder="å¤‡æ³¨"></td>
                <td><button class="delete-row-btn" onclick="deleteRow('${rowId}')">Ã—</button></td>
            `;
            tbody.appendChild(tr);
            updateProductCount();
            runChecker();
        }

        function updateProductCount() {
            const count = document.querySelectorAll('#productTableBody tr').length;
            document.getElementById('productCount').textContent = `${count} æ¡è®°å½•`;
        }

        function deleteRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateSmelterCount();
                updateProductCount();
                updateMineCount();
                refreshMineSmelterOptions();
                runChecker();
            }
        }

        // Checker
        function runChecker() {
            const errors = [];
            const passed = [];
            const questionErrors = {
                Q1: [],
                Q2: [],
                Q3: [],
                Q4: [],
                Q5: [],
                Q6: [],
                Q7: []
            };
            const otherErrors = [];

            const requiredFields = [
                { id: 'companyName', name: 'å…¬å¸åç§°' },
                { id: 'declarationScope', name: 'ç”³æŠ¥èŒƒå›´' },
                { id: 'contactName', name: 'è”ç³»äººå§“å' },
                { id: 'contactEmail', name: 'è”ç³»äººç”µé‚®åœ°å€' },
                { id: 'contactPhone', name: 'è”ç³»äººç”µè¯' },
                { id: 'authorizerName', name: 'æˆæƒäººå§“å' },
                { id: 'authorizerEmail', name: 'æˆæƒäººç”µé‚®åœ°å€' },
                { id: 'authDate', name: 'æˆæƒæ—¥æœŸ' }
            ];

            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) {
                    passed.push({ message: `${field.name} å·²å¡«å†™`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯' });
                } else {
                    otherErrors.push({ id: 'E000', message: `${field.name} ä¸ºå¿…å¡«é¡¹`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: field.id });
                }
            });

            [
                { id: 'contactEmail', name: 'è”ç³»äººç”µé‚®åœ°å€' },
                { id: 'authorizerEmail', name: 'æˆæƒäººç”µé‚®åœ°å€' }
            ].forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim() && !input.value.includes('@')) {
                    otherErrors.push({ id: 'E000', message: `${field.name} æ ¼å¼ä¸æ­£ç¡®`, location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: field.id });
                }
            });

            const authorizer = document.getElementById('authorizerName').value.trim().toLowerCase();
            if (authorizer === 'same') {
                otherErrors.push({ id: 'E000', message: 'æˆæƒäººå§“åä¸å¯ä¸º "same"', location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: 'authorizerName' });
            }

            const scope = document.getElementById('declarationScope').value;
            if (scope === 'C') {
                const desc = document.getElementById('scopeDescription').value.trim();
                if (!desc) {
                    otherErrors.push({ id: 'E002', message: 'é€‰æ‹©è‡ªå®šä¹‰èŒƒå›´(C)æ—¶å¿…é¡»å¡«å†™èŒƒå›´æè¿°', location: 'Declaration â†’ å…¬å¸ä¿¡æ¯', field: 'scopeDescription' });
                } else {
                    passed.push({ message: 'èŒƒå›´æè¿°å·²å¡«å†™', location: 'Declaration â†’ å…¬å¸ä¿¡æ¯' });
                }
            }

            if (scope === 'B') {
                const products = document.querySelectorAll('#productTableBody tr');
                let hasValidProduct = false;
                products.forEach(row => {
                    const productId = row.querySelector('[data-field="product_id"]').value.trim();
                    if (productId) hasValidProduct = true;
                });
                if (!hasValidProduct) {
                    otherErrors.push({ id: 'E001', message: 'ç”³æŠ¥èŒƒå›´é€‰æ‹© B.Product æ—¶ï¼ŒProduct List è‡³å°‘éœ€è¦ä¸€æ¡æœ‰æ•ˆè®°å½•', location: 'Product List', field: 'productTable' });
                } else {
                    passed.push({ message: 'Product List å·²å¡«å†™', location: 'Product List' });
                }
            }

            if (appData.minerals.length === 0) {
                otherErrors.push({ id: 'E000', message: 'çŸ¿äº§ç”³æŠ¥èŒƒå›´è‡³å°‘é€‰æ‹© 1 ç§', location: 'Declaration â†’ çŸ¿äº§ç”³æŠ¥èŒƒå›´', field: 'mineralSelector' });
            } else {
                passed.push({ message: `çŸ¿äº§ç”³æŠ¥èŒƒå›´å·²é€‰æ‹© ${appData.minerals.length} ç§`, location: 'Declaration â†’ çŸ¿äº§ç”³æŠ¥èŒƒå›´' });
            }

            // Question Matrix
            const mineralsWithFollowups = [];
            const mineralsWithQ2Required = [];
            const q1NegLabel = isV1() ? 'No/Unknown/Not applicable' : 'No/Unknown/Not declaring';
            appData.minerals.forEach(m => {
                const q1 = appData.questionMatrix['Q1']?.[m]?.answer;
                const q2 = appData.questionMatrix['Q2']?.[m]?.answer;

                if (!q1) {
                    questionErrors.Q1.push({ id: 'E003', message: `Q1 ${m} æœªå›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: 'question-Q1', questionId: 'Q1', mineral: m });
                } else {
                    passed.push({ message: `Q1 ${m} å·²å›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                }

                const q1Negative = isNegativeQ1(q1);
                const q2Negative = isNegativeQ2(q2);

                if (!q1Negative) {
                    mineralsWithQ2Required.push(m);
                    if (!q2) {
                        questionErrors.Q2.push({ id: 'E003', message: `Q2 ${m} æœªå›ç­” (Q1â‰ ${q1NegLabel}æ—¶å¿…å¡«)`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: 'question-Q2', questionId: 'Q2', mineral: m });
                    } else {
                        passed.push({ message: `Q2 ${m} å·²å›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                    }
                }

                if (!q1Negative && !q2Negative) {
                    mineralsWithFollowups.push(m);
                    ['Q3', 'Q4', 'Q5', 'Q6', 'Q7'].forEach(qId => {
                        const ans = appData.questionMatrix[qId]?.[m]?.answer;
                        if (!ans) {
                            questionErrors[qId].push({ id: 'E003', message: `${qId} ${m} æœªå›ç­” (Q1â‰ ${q1NegLabel} ä¸” Q2â‰ No/Unknown æ—¶å¿…å¡«)`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ', field: `question-${qId}`, questionId: qId, mineral: m });
                        } else {
                            passed.push({ message: `${qId} ${m} å·²å›ç­”`, location: 'Declaration â†’ é—®é¢˜çŸ©é˜µ' });
                        }
                    });
                }
            });

            // Company questions
            if (mineralsWithFollowups.length > 0) {
                companyQuestionsData.forEach(q => {
                    if (q.id === 'C') {
                        mineralsWithFollowups.forEach(m => {
                            const answer = appData.companyQuestions.C?.[m];
                            if (!answer) {
                                otherErrors.push({ id: 'E004', message: `å…¬å¸é—®é¢˜ C ${m} æœªå›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'companyQuestionsCard', questionId: 'C', mineral: m });
                            } else {
                                passed.push({ message: `å…¬å¸é—®é¢˜ C ${m} å·²å›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜' });
                            }
                        });
                        return;
                    }

                    if (!appData.companyQuestions[q.id]) {
                        otherErrors.push({ id: 'E004', message: `å…¬å¸é—®é¢˜ ${q.id} æœªå›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'companyQuestionsCard', questionId: q.id });
                    } else {
                        passed.push({ message: `å…¬å¸é—®é¢˜ ${q.id} å·²å›ç­”`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜' });

                        if (q.id === 'E' && appData.companyQuestions[q.id] === 'Yes, Using Other Format (Describe)') {
                            const commentInput = document.querySelector('#cq-comment-E input');
                            if (!commentInput || !commentInput.value.trim()) {
                                otherErrors.push({ id: 'E006', message: 'é—®é¢˜E é€‰æ‹© "Using Other Format" æ—¶æ³¨é‡Šå¿…å¡«', location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'cq-comment-E', questionId: 'E' });
                            }
                        }

                        if (q.id === 'B' && appData.companyQuestions[q.id] === 'Yes') {
                            const commentInput = document.querySelector('#cq-comment-B input');
                            if (!commentInput || !commentInput.value.trim()) {
                                otherErrors.push({ id: 'E005', message: 'The URL in the comment field', location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜', field: 'cq-comment-B', questionId: 'B' });
                            }
                        }
                    }
                });
            } else {
                passed.push({ message: `A-G æ— éœ€å¡«å†™ (æ— çŸ¿äº§æ»¡è¶³ Q1â‰ ${q1NegLabel} ä¸” Q2â‰ No/Unknown)`, location: 'Declaration â†’ å…¬å¸å±‚é¢é—®é¢˜' });
            }

            // Smelter List
            const smelterRows = document.querySelectorAll('#smelterTableBody tr');
            const smelterMetals = {};

            smelterRows.forEach((row, index) => {
                const metal = row.querySelector('[data-field="metal"]').value;
                const lookup = row.querySelector('[data-field="lookup"]').value;
                const name = row.querySelector('[data-field="name"]').value.trim();
                const country = row.querySelector('[data-field="country"]').value;

                if (metal) smelterMetals[metal] = true;

                if (lookup === 'Smelter not listed') {
                    if (!name) {
                        otherErrors.push({ id: 'E007', message: `Smelter List ç¬¬ ${index + 1} è¡Œ: é€‰æ‹© "Smelter not listed" æ—¶å†¶ç‚¼å‚åç§°å¿…å¡«`, location: 'Smelter List', field: 'smelterTable' });
                    }
                    if (!country) {
                        otherErrors.push({ id: 'E007', message: `Smelter List ç¬¬ ${index + 1} è¡Œ: é€‰æ‹© "Smelter not listed" æ—¶å›½å®¶å¿…å¡«`, location: 'Smelter List', field: 'smelterTable' });
                    }
                }
            });

            mineralsWithFollowups.forEach(metal => {
                if (!smelterMetals[metal]) {
                    otherErrors.push({ id: 'E010', message: `${metal} Q1â‰ å¦å®šå€¼ä¸” Q2â‰ No/Unknownï¼Œä½† Smelter List ä¸­æ²¡æœ‰å¯¹åº”è®°å½•`, location: 'Smelter List', field: 'smelterTable', mineral: metal });
                }
            });

            // Mine List (2.0+)
            // è¯´æ˜æ€§é¡µé¢ï¼šExcel Checker ä¸å¯¹ Mine List åšå¼ºåˆ¶æ ¡éªŒï¼Œä»…ä¿ç•™å¡«å†™è”åŠ¨ä¸ä¸‹æ‹‰æ¥æºã€‚

            const otherById = {};
            otherErrors.forEach(item => {
                if (!otherById[item.id]) otherById[item.id] = [];
                otherById[item.id].push(item);
            });
            const ruleOrder = ['E000', 'E001', 'E002', 'E003', 'E004', 'E005', 'E006', 'E007', 'E010', 'E012'];
            ruleOrder.forEach(ruleId => {
                if (ruleId === 'E003') {
                    errors.push(
                        ...questionErrors.Q1,
                        ...questionErrors.Q2,
                        ...questionErrors.Q3,
                        ...questionErrors.Q4,
                        ...questionErrors.Q5,
                        ...questionErrors.Q6,
                        ...questionErrors.Q7
                    );
                } else if (otherById[ruleId]) {
                    errors.push(...otherById[ruleId]);
                }
            });

            errors.sort(compareCheckerErrors);

            // Completion rate (approx)
            let totalRequired = requiredFields.length + (appData.minerals.length > 0 ? appData.minerals.length : 0) + mineralsWithQ2Required.length;
            let completedRequired = 0;

            requiredFields.forEach(field => {
                const input = document.getElementById(field.id);
                if (input && input.value.trim()) completedRequired++;
            });

            appData.minerals.forEach(m => {
                const q1 = appData.questionMatrix['Q1']?.[m]?.answer;
                const q2 = appData.questionMatrix['Q2']?.[m]?.answer;
                if (q1) completedRequired++;
                if (!isNegativeQ1(q1) && q2) {
                    completedRequired++;
                }
            });

            if (mineralsWithFollowups.length > 0) {
                totalRequired += mineralsWithFollowups.length * 5;
                totalRequired += (companyQuestionsData.length - 1) + mineralsWithFollowups.length;
                mineralsWithFollowups.forEach(m => {
                    ['Q3', 'Q4', 'Q5', 'Q6', 'Q7'].forEach(qId => {
                        if (appData.questionMatrix[qId]?.[m]?.answer) completedRequired++;
                    });
                });
                companyQuestionsData.forEach(q => {
                    if (q.id === 'C') {
                        mineralsWithFollowups.forEach(m => {
                            if (appData.companyQuestions.C?.[m]) completedRequired++;
                        });
                    } else if (appData.companyQuestions[q.id]) {
                        completedRequired++;
                    }
                });
            }

            const completion = totalRequired > 0 ? Math.round((completedRequired / totalRequired) * 100) : 0;

            const errorCountEl = document.getElementById('errorCount');
            if (errorCountEl) errorCountEl.textContent = errors.length;
            const passedCountEl = document.getElementById('passedCount');
            if (passedCountEl) passedCountEl.textContent = passed.length;
            const completionEl = document.getElementById('completionRate');
            if (completionEl) completionEl.textContent = completion + '%';
            document.getElementById('progressText').textContent = completion + '%';
            document.getElementById('progressFill').style.width = completion + '%';

            document.getElementById('errorBadge').textContent = errors.length + ' é¡¹';
            document.getElementById('passedBadge').textContent = passed.length + ' é¡¹';

            document.getElementById('errorsCard').style.display = errors.length > 0 ? 'block' : 'none';

            updateGlobalErrorBar(errors.length);
            document.getElementById('passedSummaryText').textContent = `å·²é€šè¿‡ ${passed.length} é¡¹æ£€æŸ¥`;
            renderGroupedErrors(errors);
            renderCheckerList('passedList', passed, 'success');

            lastCheckerSummary = { errors, passed, completion };
            return lastCheckerSummary;
        }

        function compareCheckerErrors(a, b) {
            const sectionOrder = {
                companyInfo: 0,
                mineralsScope: 1,
                questionMatrix: 2,
                companyQuestions: 3,
                productList: 4,
                smelterList: 5,
                mineList: 6
            };
            const aSection = getErrorSectionKey(a, sectionOrder);
            const bSection = getErrorSectionKey(b, sectionOrder);
            if (aSection !== bSection) return aSection - bSection;

            if (aSection === sectionOrder.companyInfo) {
                const fieldOrder = [
                    'companyName', 'declarationScope', 'scopeDescription', 'uniqueId', 'authId', 'address',
                    'contactName', 'contactEmail', 'contactPhone', 'authorizerName', 'authorizerTitle',
                    'authorizerEmail', 'authorizerPhone', 'authDate', 'mineralSelector'
                ];
                const aIdx = fieldOrder.indexOf(a.field);
                const bIdx = fieldOrder.indexOf(b.field);
                if (aIdx !== bIdx) return (aIdx === -1 ? 999 : aIdx) - (bIdx === -1 ? 999 : bIdx);
            }

            if (aSection === sectionOrder.questionMatrix) {
                const questionOrder = {};
                questions.forEach((q, idx) => { questionOrder[q.id] = idx; });
                const qa = a.questionId || extractQuestionId(a.message);
                const qb = b.questionId || extractQuestionId(b.message);
                if (qa || qb) {
                    const aIdx = qa ? (questionOrder[qa] ?? 999) : 999;
                    const bIdx = qb ? (questionOrder[qb] ?? 999) : 999;
                    if (aIdx !== bIdx) return aIdx - bIdx;
                }
                const ma = a.mineral || findMineralInMessage(a.message);
                const mb = b.mineral || findMineralInMessage(b.message);
                const mIdxA = mineralIndex(ma);
                const mIdxB = mineralIndex(mb);
                if (mIdxA !== mIdxB) return mIdxA - mIdxB;
            }

            if (aSection === sectionOrder.companyQuestions) {
                const companyOrder = {};
                companyQuestionsData.forEach((q, idx) => { companyOrder[q.id] = idx; });
                const qa = a.questionId || extractCompanyQuestionId(a.message);
                const qb = b.questionId || extractCompanyQuestionId(b.message);
                if (qa || qb) {
                    const aIdx = qa ? (companyOrder[qa] ?? 999) : 999;
                    const bIdx = qb ? (companyOrder[qb] ?? 999) : 999;
                    if (aIdx !== bIdx) return aIdx - bIdx;
                }
                if (qa === 'C' || qb === 'C') {
                    const ma = a.mineral || findMineralInMessage(a.message);
                    const mb = b.mineral || findMineralInMessage(b.message);
                    const mIdxA = mineralIndex(ma);
                    const mIdxB = mineralIndex(mb);
                    if (mIdxA !== mIdxB) return mIdxA - mIdxB;
                }
            }

            const aRow = extractRowIndex(a.message);
            const bRow = extractRowIndex(b.message);
            if (aRow !== bRow) return aRow - bRow;

            return String(a.message || '').localeCompare(String(b.message || ''));
        }

        function getErrorSectionKey(error, sectionOrder) {
            const loc = error.location || '';
            if (loc.includes('å…¬å¸ä¿¡æ¯')) return sectionOrder.companyInfo;
            if (loc.includes('çŸ¿äº§ç”³æŠ¥èŒƒå›´')) return sectionOrder.mineralsScope;
            if (loc.includes('é—®é¢˜çŸ©é˜µ')) return sectionOrder.questionMatrix;
            if (loc.includes('å…¬å¸å±‚é¢')) return sectionOrder.companyQuestions;
            if (loc.includes('Product') || loc.includes('äº§å“')) return sectionOrder.productList;
            if (loc.includes('Smelter') || loc.includes('å†¶ç‚¼å‚')) return sectionOrder.smelterList;
            if (loc.includes('Mine') || loc.includes('çŸ¿å‚')) return sectionOrder.mineList;
            return 99;
        }

        function extractQuestionId(message) {
            const match = message && message.match(/(Q\\d+)/);
            return match ? match[1] : null;
        }

        function extractCompanyQuestionId(message) {
            const match = message && message.match(/å…¬å¸é—®é¢˜\\s*([A-Z])/);
            return match ? match[1] : null;
        }

        function extractRowIndex(message) {
            const match = message && message.match(/ç¬¬\\s*(\\d+)\\s*è¡Œ/);
            return match ? Number(match[1]) : 999;
        }

        function findMineralInMessage(message) {
            if (!message) return null;
            return appData.minerals.find(m => message.includes(m)) || null;
        }

        function mineralIndex(mineral) {
            if (!mineral) return 999;
            const idx = appData.minerals.indexOf(mineral);
            return idx === -1 ? 999 : idx;
        }

        function updateGlobalErrorBar(errorCount) {
            const bar = document.getElementById('globalErrorBar');
            const icon = document.getElementById('globalErrorIcon');
            const text = document.getElementById('globalErrorText');
            if (!bar || !icon || !text) return;
            if (errorCount > 0) {
                bar.className = 'global-error-bar has-errors';
                icon.textContent = 'âš ï¸';
                text.textContent = `è¿˜æœ‰ ${errorCount} ä¸ªå¿…å¡«é¡¹æœªå®Œæˆ`;
            } else {
                bar.className = 'global-error-bar all-passed';
                icon.textContent = 'âœ…';
                text.textContent = 'æ‰€æœ‰å¿…å¡«é¡¹å·²å®Œæˆ';
            }
        }

        function renderGroupedErrors(errors) {
            const container = document.getElementById('groupedErrorsList');
            if (!container) return;
            const groups = {
                companyInfo: { label: checkerSectionLabels.companyInfo, errors: [] },
                questionMatrix: { label: checkerSectionLabels.questionMatrix, errors: [] },
                companyQuestions: { label: checkerSectionLabels.companyQuestions, errors: [] },
                productList: { label: checkerSectionLabels.productList, errors: [] },
                smelterList: { label: checkerSectionLabels.smelterList, errors: [] },
                mineList: { label: checkerSectionLabels.mineList, errors: [] }
            };

            errors.forEach(error => {
                const loc = error.location || '';
                if (loc.includes('å…¬å¸ä¿¡æ¯')) {
                    groups.companyInfo.errors.push(error);
                } else if (loc.includes('é—®é¢˜çŸ©é˜µ')) {
                    groups.questionMatrix.errors.push(error);
                } else if (loc.includes('å…¬å¸å±‚é¢')) {
                    groups.companyQuestions.errors.push(error);
                } else if (loc.includes('Smelter') || loc.includes('å†¶ç‚¼å‚')) {
                    groups.smelterList.errors.push(error);
                } else if (loc.includes('Mine') || loc.includes('çŸ¿å‚')) {
                    groups.mineList.errors.push(error);
                } else if (loc.includes('Product') || loc.includes('äº§å“')) {
                    groups.productList.errors.push(error);
                } else {
                    groups.companyInfo.errors.push(error);
                }
            });

            let html = '';
            Object.keys(groups).forEach(key => {
                const group = groups[key];
                if (group.errors.length > 0 && group.label) {
                    html += `
                        <div class="checker-group" id="error-group-${key}">
                            <div class="checker-group-header" onclick="toggleErrorGroup('error-group-${key}')">
                                <div class="checker-group-title">
                                    <span>${group.label}</span>
                                    <span class="checker-group-count">${group.errors.length}</span>
                                </div>
                                <span class="checker-group-toggle">â–¼</span>
                            </div>
                            <div class="checker-group-content">
                                <ul class="checker-list">
                                    ${group.errors.map(item => `
                                        <li class="checker-item">
                                            <div class="checker-icon error">!</div>
                                            <div class="checker-content">
                                                <div class="checker-message">${item.message}</div>
                                            </div>
                                            ${item.field ? `<button class="checker-fix-btn" onclick="goToField('${item.field}')">å®šä½</button>` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        const checkerSectionLabels = {
            companyInfo: 'å…¬å¸ä¿¡æ¯',
            questionMatrix: 'æ ¹æ®ä¸Šè¿°æŒ‡æ˜çš„ç”³æŠ¥èŒƒå›´å›ç­”ä¸‹åˆ—é—®é¢˜ 1 - 7',
            companyQuestions: 'ä»å…¬å¸å±‚é¢æ¥å›ç­”ä»¥ä¸‹é—®é¢˜',
            smelterList: 'å†¶ç‚¼å‚æ¸…å•',
            productList: 'äº§å“æ¸…å•',
            mineList: 'çŸ¿å‚æ¸…å•',
            mineralsScope: 'çŸ¿ç‰©èŒƒå›´'
        };

        function formatCheckerLocation(location) {
            if (!location) return '';
            if (location.includes('å…¬å¸ä¿¡æ¯')) return checkerSectionLabels.companyInfo;
            if (location.includes('é—®é¢˜çŸ©é˜µ')) return checkerSectionLabels.questionMatrix;
            if (location.includes('å…¬å¸å±‚é¢')) return checkerSectionLabels.companyQuestions;
            if (location.includes('Smelter') || location.includes('å†¶ç‚¼å‚')) return checkerSectionLabels.smelterList;
            if (location.includes('Mine') || location.includes('çŸ¿å‚')) return checkerSectionLabels.mineList;
            if (location.includes('Product') || location.includes('äº§å“')) return checkerSectionLabels.productList;
            if (location.includes('Scope') || location.includes('çŸ¿ç‰©èŒƒå›´') || location.includes('Minerals')) return checkerSectionLabels.mineralsScope;
            return location.replace('Declaration â†’ ', '');
        }

        function renderCheckerList(containerId, items, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <li class="checker-item">
                    <div class="checker-icon ${type}">${type === 'error' ? '!' : type === 'warning' ? '!' : 'âœ“'}</div>
                    <div class="checker-content">
                        <div class="checker-location">${formatCheckerLocation(item.location)}</div>
                        <div class="checker-message">${item.message}</div>
                    </div>
                    ${item.field ? `<button class="checker-fix-btn" onclick="goToField('${item.field}')">å®šä½</button>` : ''}
                </li>
            `).join('');
        }

        function goToField(fieldId) {
            const field = document.getElementById(fieldId);
            const page = field ? field.closest('.page-container') : document.getElementById('page-declaration');
            const pageId = page ? page.id.replace('page-', '') : 'declaration';
            goToPage(pageId);
            if (field) {
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                field.focus();
                field.classList.add('highlight-target');
                setTimeout(() => field.classList.remove('highlight-target'), 1500);
            }
        }

        function exportData() {
            const exportBtn = document.querySelector('.btn-export');
            const originalText = exportBtn.textContent;
            exportBtn.classList.add('loading');
            exportBtn.textContent = 'æ­£åœ¨å¯¼å‡º';

            setTimeout(() => {
                const data = {
                    version: currentVersion,
                    company: {},
                    minerals: appData.minerals,
                    questionMatrix: appData.questionMatrix,
                    companyQuestions: appData.companyQuestions,
                    smelters: [],
                    mines: [],
                    products: []
                };

                document.querySelectorAll('#companyForm input, #companyForm select, #companyForm textarea').forEach(input => {
                    if (input.id) data.company[input.id] = input.value;
                });

                document.querySelectorAll('#smelterTableBody tr').forEach(row => {
                    const combinedMetal = row.querySelector('[data-field="combined_metal"]');
                    const combinedSmelter = row.querySelector('[data-field="combined_smelter"]');
                    data.smelters.push({
                        metal: row.querySelector('[data-field="metal"]').value,
                        lookup: row.querySelector('[data-field="lookup"]').value,
                        name: row.querySelector('[data-field="name"]').value,
                        country: row.querySelector('[data-field="country"]').value,
                        id_input: row.querySelector('[data-field="id_input"]').value,
                        smelter_id: row.querySelector('[data-field="smelter_id"]').value,
                        source_id: row.querySelector('[data-field="source_id"]').value,
                        combined_metal: combinedMetal ? combinedMetal.value : '',
                        combined_smelter: combinedSmelter ? combinedSmelter.value : ''
                    });
                });

                if (hasMineList()) {
                    document.querySelectorAll('#mineTableBody tr').forEach(row => {
                        data.mines.push({
                            metal: row.querySelector('[data-field="metal"]').value,
                            smelter_name: getMineSmelterName(row),
                            mine_name: row.querySelector('[data-field="mine_name"]').value,
                            mine_id: row.querySelector('[data-field="mine_id"]').value,
                            source_id: row.querySelector('[data-field="source_id"]').value,
                            country: row.querySelector('[data-field="country"]').value
                        });
                    });
                }

                document.querySelectorAll('#productTableBody tr').forEach(row => {
                    data.products.push({
                        product_id: row.querySelector('[data-field="product_id"]').value,
                        product_name: row.querySelector('[data-field="product_name"]').value,
                        requester_id: row.querySelector('[data-field="requester_id"]').value,
                        requester_name: row.querySelector('[data-field="requester_name"]').value,
                        comments: row.querySelector('[data-field="comments"]').value
                    });
                });

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'emrt-data.json';
                a.click();

                exportBtn.classList.remove('loading');
                exportBtn.textContent = originalText;

                showToast('æ•°æ®å·²å¯¼å‡ºä¸º JSON æ–‡ä»¶', 'success');
            }, 600);
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
